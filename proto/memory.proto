syntax = "proto3";

package memory;

// Memory service for agent conversation storage.
//
// This service provides:
// - Event ingestion for conversation capture
// - Health check for monitoring
// - Reflection for debugging
service MemoryService {
    // Ingest a conversation event.
    //
    // Events are persisted to RocksDB with time-prefixed keys.
    // Idempotent: returns created=false if event_id already exists.
    rpc IngestEvent(IngestEventRequest) returns (IngestEventResponse);

    // Query RPCs (QRY-01 through QRY-05)

    // Get root TOC nodes (year level)
    rpc GetTocRoot(GetTocRootRequest) returns (GetTocRootResponse);

    // Get a specific TOC node by ID
    rpc GetNode(GetNodeRequest) returns (GetNodeResponse);

    // Browse children of a TOC node with pagination
    rpc BrowseToc(BrowseTocRequest) returns (BrowseTocResponse);

    // Get events in a time range
    rpc GetEvents(GetEventsRequest) returns (GetEventsResponse);

    // Expand a grip to show context events
    rpc ExpandGrip(ExpandGripRequest) returns (ExpandGripResponse);

    // Scheduler RPCs (SCHED-05)

    // Get scheduler and job status
    rpc GetSchedulerStatus(GetSchedulerStatusRequest) returns (GetSchedulerStatusResponse);

    // Pause a scheduled job
    rpc PauseJob(PauseJobRequest) returns (PauseJobResponse);

    // Resume a paused job
    rpc ResumeJob(ResumeJobRequest) returns (ResumeJobResponse);

    // Search RPCs (Phase 10.5)

    // Search within a single TOC node
    rpc SearchNode(SearchNodeRequest) returns (SearchNodeResponse);

    // Search across children of a parent node
    rpc SearchChildren(SearchChildrenRequest) returns (SearchChildrenResponse);

    // Teleport RPCs (TEL-01 through TEL-04)

    // Search for TOC nodes or grips by keyword using BM25 ranking
    rpc TeleportSearch(TeleportSearchRequest) returns (TeleportSearchResponse);

    // Vector RPCs (Phase 12 - VEC-01 through VEC-03)

    // Vector semantic search using HNSW index
    rpc VectorTeleport(VectorTeleportRequest) returns (VectorTeleportResponse);

    // Hybrid BM25 + vector search using RRF fusion
    rpc HybridSearch(HybridSearchRequest) returns (HybridSearchResponse);

    // Get vector index status and statistics
    rpc GetVectorIndexStatus(GetVectorIndexStatusRequest) returns (VectorIndexStatus);

    // Topic Graph RPCs (Phase 14 - TOPIC-08)

    // Get topic graph status and statistics
    rpc GetTopicGraphStatus(GetTopicGraphStatusRequest) returns (GetTopicGraphStatusResponse);

    // Get topics matching a query
    rpc GetTopicsByQuery(GetTopicsByQueryRequest) returns (GetTopicsByQueryResponse);

    // Get topics related to a specific topic
    rpc GetRelatedTopics(GetRelatedTopicsRequest) returns (GetRelatedTopicsResponse);

    // Get top topics by importance score
    rpc GetTopTopics(GetTopTopicsRequest) returns (GetTopTopicsResponse);

    // ===== Index Lifecycle RPCs (Phase 16 - FR-08, FR-09) =====

    // Prune old vectors per lifecycle policy (FR-08)
    rpc PruneVectorIndex(PruneVectorIndexRequest) returns (PruneVectorIndexResponse);

    // Prune old BM25 documents per lifecycle policy (FR-09)
    rpc PruneBm25Index(PruneBm25IndexRequest) returns (PruneBm25IndexResponse);

    // Get ranking and novelty status
    rpc GetRankingStatus(GetRankingStatusRequest) returns (GetRankingStatusResponse);

    // ===== Agent Retrieval Policy RPCs (Phase 17) =====

    // Get combined status of all retrieval layers (single call pattern)
    rpc GetRetrievalCapabilities(GetRetrievalCapabilitiesRequest) returns (GetRetrievalCapabilitiesResponse);

    // Classify query intent
    rpc ClassifyQueryIntent(ClassifyQueryIntentRequest) returns (ClassifyQueryIntentResponse);

    // Route a query through the retrieval policy
    rpc RouteQuery(RouteQueryRequest) returns (RouteQueryResponse);
}

// Role of the message author
enum EventRole {
    EVENT_ROLE_UNSPECIFIED = 0;
    EVENT_ROLE_USER = 1;
    EVENT_ROLE_ASSISTANT = 2;
    EVENT_ROLE_SYSTEM = 3;
    EVENT_ROLE_TOOL = 4;
}

// Type of conversation event
enum EventType {
    EVENT_TYPE_UNSPECIFIED = 0;
    EVENT_TYPE_SESSION_START = 1;
    EVENT_TYPE_USER_MESSAGE = 2;
    EVENT_TYPE_ASSISTANT_MESSAGE = 3;
    EVENT_TYPE_TOOL_RESULT = 4;
    EVENT_TYPE_ASSISTANT_STOP = 5;
    EVENT_TYPE_SUBAGENT_START = 6;
    EVENT_TYPE_SUBAGENT_STOP = 7;
    EVENT_TYPE_SESSION_END = 8;
}

// Fields to search within a TOC node
enum SearchField {
    SEARCH_FIELD_UNSPECIFIED = 0;
    SEARCH_FIELD_TITLE = 1;
    SEARCH_FIELD_SUMMARY = 2;
    SEARCH_FIELD_BULLETS = 3;
    SEARCH_FIELD_KEYWORDS = 4;
}

// Classification of memory type for salience scoring (Phase 16)
enum MemoryKind {
    MEMORY_KIND_UNSPECIFIED = 0;
    MEMORY_KIND_OBSERVATION = 1;  // Default, no boost
    MEMORY_KIND_PREFERENCE = 2;   // User preferences ("prefer", "like", "avoid")
    MEMORY_KIND_PROCEDURE = 3;    // Steps or instructions ("step", "first", "then")
    MEMORY_KIND_CONSTRAINT = 4;   // Requirements or limitations ("must", "should")
    MEMORY_KIND_DEFINITION = 5;   // Definitions or meanings ("is defined as", "means")
}

// A conversation event to be stored.
//
// Per ING-02: Includes session_id, timestamp, role, text, metadata.
message Event {
    // Unique identifier (ULID string, generated by client)
    string event_id = 1;

    // Session this event belongs to
    string session_id = 2;

    // Source timestamp in milliseconds since Unix epoch.
    // Per ING-04: Used for ordering, not ingestion time.
    int64 timestamp_ms = 3;

    // Type of event
    EventType event_type = 4;

    // Role of the author
    EventRole role = 5;

    // Event content/text
    string text = 6;

    // Additional metadata (tool names, file paths, etc.)
    map<string, string> metadata = 7;

    // Phase 18: Agent identifier for multi-agent memory
    // Common values: "claude", "opencode", "gemini", "copilot"
    // Empty/absent means legacy event or unknown source
    optional string agent = 8;
}

// Request to ingest an event
message IngestEventRequest {
    // The event to ingest
    Event event = 1;
}

// Response from event ingestion
message IngestEventResponse {
    // The event_id that was stored
    string event_id = 1;

    // True if event was newly created, false if already existed (idempotent)
    bool created = 2;
}

// ===== TOC Navigation Messages (QRY-01, QRY-02, QRY-03) =====

// Level in the TOC hierarchy
enum TocLevel {
    TOC_LEVEL_UNSPECIFIED = 0;
    TOC_LEVEL_YEAR = 1;
    TOC_LEVEL_MONTH = 2;
    TOC_LEVEL_WEEK = 3;
    TOC_LEVEL_DAY = 4;
    TOC_LEVEL_SEGMENT = 5;
}

// A bullet point in a TOC node summary
message TocBullet {
    // Bullet text
    string text = 1;
    // IDs of grips supporting this bullet
    repeated string grip_ids = 2;
}

// A TOC node in the hierarchy
message TocNode {
    // Node identifier (e.g., "toc:year:2026")
    string node_id = 1;
    // Level in hierarchy
    TocLevel level = 2;
    // Display title
    string title = 3;
    // Summary text (optional, may be empty for higher levels)
    optional string summary = 4;
    // Bullet points
    repeated TocBullet bullets = 5;
    // Keywords/tags
    repeated string keywords = 6;
    // Child node IDs
    repeated string child_node_ids = 7;
    // Start timestamp (ms)
    int64 start_time_ms = 8;
    // End timestamp (ms)
    int64 end_time_ms = 9;
    // Version number
    int32 version = 10;

    // Phase 16: Salience scoring fields (field numbers > 100 to avoid conflicts)
    // Salience score (0.0-1.0+), default 0.5 for neutral
    float salience_score = 101;
    // Memory type classification
    MemoryKind memory_kind = 102;
    // Whether node is pinned (boosted importance)
    bool is_pinned = 103;
}

// A grip providing provenance for a bullet
message Grip {
    // Grip identifier
    string grip_id = 1;
    // Excerpt text
    string excerpt = 2;
    // Event ID where excerpt starts
    string event_id_start = 3;
    // Event ID where excerpt ends
    string event_id_end = 4;
    // Timestamp of first event (ms)
    int64 timestamp_ms = 5;
    // Source reference
    string source = 6;

    // Phase 16: Salience scoring fields (field numbers > 10)
    // Salience score (0.0-1.0+), default 0.5 for neutral
    float salience_score = 11;
    // Memory type classification
    MemoryKind memory_kind = 12;
    // Whether grip is pinned (boosted importance)
    bool is_pinned = 13;
}

// Request for root TOC nodes
message GetTocRootRequest {}

// Response with root TOC nodes
message GetTocRootResponse {
    // Year-level nodes, sorted by time descending
    repeated TocNode nodes = 1;
}

// Request for a specific node
message GetNodeRequest {
    // Node ID to retrieve
    string node_id = 1;
}

// Response with the requested node
message GetNodeResponse {
    // The requested node (null if not found)
    optional TocNode node = 1;
}

// Request to browse children of a node
message BrowseTocRequest {
    // Parent node ID
    string parent_id = 1;
    // Maximum results to return
    int32 limit = 2;
    // Continuation token for pagination (from previous response)
    optional string continuation_token = 3;
}

// Response with child nodes
message BrowseTocResponse {
    // Child nodes
    repeated TocNode children = 1;
    // Token for next page (null if no more results)
    optional string continuation_token = 2;
    // Whether more results are available
    bool has_more = 3;
}

// ===== Event Retrieval Messages (QRY-04, QRY-05) =====

// Request for events in a time range
message GetEventsRequest {
    // Start timestamp (ms, inclusive)
    int64 from_timestamp_ms = 1;
    // End timestamp (ms, inclusive)
    int64 to_timestamp_ms = 2;
    // Maximum events to return
    int32 limit = 3;
}

// Response with events
message GetEventsResponse {
    // Events in time range
    repeated Event events = 1;
    // Whether more events exist beyond the limit
    bool has_more = 2;
}

// Request to expand a grip
message ExpandGripRequest {
    // Grip ID to expand
    string grip_id = 1;
    // Number of events before excerpt
    optional int32 events_before = 2;
    // Number of events after excerpt
    optional int32 events_after = 3;
}

// Response with grip context
message ExpandGripResponse {
    // The grip being expanded
    optional Grip grip = 1;
    // Events before the excerpt
    repeated Event events_before = 2;
    // Events containing the excerpt
    repeated Event excerpt_events = 3;
    // Events after the excerpt
    repeated Event events_after = 4;
}

// ===== Scheduler Messages (SCHED-05) =====

// Result of a job execution
enum JobResultStatus {
    JOB_RESULT_STATUS_UNSPECIFIED = 0;
    JOB_RESULT_STATUS_SUCCESS = 1;
    JOB_RESULT_STATUS_FAILED = 2;
    JOB_RESULT_STATUS_SKIPPED = 3;
}

// Status of a scheduled job
message JobStatusProto {
    // Job name
    string job_name = 1;
    // Cron expression
    string cron_expr = 2;
    // Last execution time (ms since epoch, 0 if never run)
    int64 last_run_ms = 3;
    // Last execution duration (ms)
    int64 last_duration_ms = 4;
    // Last execution result
    JobResultStatus last_result = 5;
    // Last error message (if failed)
    optional string last_error = 6;
    // Next scheduled run (ms since epoch)
    int64 next_run_ms = 7;
    // Total successful runs
    uint64 run_count = 8;
    // Total failed runs
    uint64 error_count = 9;
    // Currently executing
    bool is_running = 10;
    // Paused by user
    bool is_paused = 11;
    // Job-specific metadata from last run (e.g., prune_count, items_processed)
    map<string, string> last_run_metadata = 12;
}

// Request for scheduler status
message GetSchedulerStatusRequest {}

// Response with scheduler status
message GetSchedulerStatusResponse {
    // Whether scheduler is running
    bool scheduler_running = 1;
    // All registered jobs
    repeated JobStatusProto jobs = 2;
}

// Request to pause a job
message PauseJobRequest {
    string job_name = 1;
}

// Response from pause
message PauseJobResponse {
    bool success = 1;
    optional string error = 2;
}

// Request to resume a job
message ResumeJobRequest {
    string job_name = 1;
}

// Response from resume
message ResumeJobResponse {
    bool success = 1;
    optional string error = 2;
}

// ===== Search Messages (Phase 10.5) =====

// Search within a single node
message SearchNodeRequest {
    // Node ID to search within
    string node_id = 1;
    // Search terms (space-separated, case-insensitive)
    string query = 2;
    // Fields to search (empty = all fields)
    repeated SearchField fields = 3;
    // Max matches to return (default: 10)
    int32 limit = 4;
    // Optional token budget for response control
    int32 token_budget = 5;
}

message SearchMatch {
    // Which field matched
    SearchField field = 1;
    // Matching text snippet
    string text = 2;
    // If bullet, the supporting grip IDs
    repeated string grip_ids = 3;
    // Term overlap score (0.0-1.0)
    float score = 4;
}

message SearchNodeResponse {
    // Whether any matches found
    bool matched = 1;
    // Individual matches
    repeated SearchMatch matches = 2;
    // Node that was searched
    string node_id = 3;
    // Level of the searched node
    TocLevel level = 4;
}

// Search children of a parent node
message SearchChildrenRequest {
    // Parent node ID (empty string for root/year level)
    string parent_id = 1;
    // Search terms (space-separated, case-insensitive)
    string query = 2;
    // Level to search at (ignored if parent_id provided - uses children's level)
    TocLevel child_level = 3;
    // Fields to search (empty = all fields)
    repeated SearchField fields = 4;
    // Max nodes to return (default: 10)
    int32 limit = 5;
    // Optional token budget for response control
    int32 token_budget = 6;
}

message SearchNodeResult {
    // Node ID of the matching node
    string node_id = 1;
    // Node title for display
    string title = 2;
    // Level of this node
    TocLevel level = 3;
    // Matches within this node
    repeated SearchMatch matches = 4;
    // Aggregate relevance score
    float relevance_score = 5;
}

message SearchChildrenResponse {
    // Matching nodes with their matches
    repeated SearchNodeResult results = 1;
    // Whether more results available
    bool has_more = 2;
}

// ===== Teleport Search Messages (TEL-01 through TEL-04) =====

// Document type filter for teleport search
enum TeleportDocType {
    TELEPORT_DOC_TYPE_UNSPECIFIED = 0;  // Search all types
    TELEPORT_DOC_TYPE_TOC_NODE = 1;     // TOC nodes only
    TELEPORT_DOC_TYPE_GRIP = 2;         // Grips only
}

// Request for teleport search
message TeleportSearchRequest {
    // Search query (keywords)
    string query = 1;
    // Filter by document type (optional)
    TeleportDocType doc_type = 2;
    // Maximum results to return (default: 10)
    int32 limit = 3;
    // Phase 18: Filter results by agent
    optional string agent_filter = 4;
}

// A single teleport search result
message TeleportSearchResult {
    // Document ID (node_id or grip_id)
    string doc_id = 1;
    // Document type
    TeleportDocType doc_type = 2;
    // BM25 relevance score
    float score = 3;
    // Keywords from the document (if available)
    optional string keywords = 4;
    // Timestamp in milliseconds
    optional int64 timestamp_ms = 5;
}

// Response from teleport search
message TeleportSearchResponse {
    // Ranked search results
    repeated TeleportSearchResult results = 1;
    // Total documents in index
    uint64 total_docs = 2;
}

// ===== Vector Search Messages (Phase 12 - VEC-01 through VEC-03) =====

// Target type filter for vector search
enum VectorTargetType {
    VECTOR_TARGET_TYPE_UNSPECIFIED = 0;
    VECTOR_TARGET_TYPE_TOC_NODE = 1;
    VECTOR_TARGET_TYPE_GRIP = 2;
    VECTOR_TARGET_TYPE_ALL = 3;
}

// Time range filter for searches
message TimeRange {
    // Start time in milliseconds (inclusive)
    int64 start_ms = 1;
    // End time in milliseconds (exclusive)
    int64 end_ms = 2;
}

// Request for vector semantic search
message VectorTeleportRequest {
    // Query text to embed and search
    string query = 1;
    // Maximum results to return (default: 10)
    int32 top_k = 2;
    // Minimum similarity score 0.0-1.0 (default: 0.0)
    float min_score = 3;
    // Optional time range filter
    optional TimeRange time_filter = 4;
    // Target type filter
    VectorTargetType target = 5;
    // Phase 18: Filter results by agent
    optional string agent_filter = 6;
}

// A vector search match
message VectorMatch {
    // Document ID (node_id or grip_id)
    string doc_id = 1;
    // Document type ("toc_node" or "grip")
    string doc_type = 2;
    // Similarity score 0.0-1.0
    float score = 3;
    // Preview of matched text
    string text_preview = 4;
    // Document timestamp in milliseconds
    int64 timestamp_ms = 5;
}

// Response from vector search
message VectorTeleportResponse {
    // Ranked matches by similarity
    repeated VectorMatch matches = 1;
    // Index status at time of search
    optional VectorIndexStatus index_status = 2;
}

// Search mode for hybrid search
enum HybridMode {
    HYBRID_MODE_UNSPECIFIED = 0;
    HYBRID_MODE_VECTOR_ONLY = 1;
    HYBRID_MODE_BM25_ONLY = 2;
    HYBRID_MODE_HYBRID = 3;
}

// Request for hybrid BM25 + vector search
message HybridSearchRequest {
    // Search query
    string query = 1;
    // Maximum results to return (default: 10)
    int32 top_k = 2;
    // Search mode
    HybridMode mode = 3;
    // Weight for BM25 in fusion (default: 0.5)
    float bm25_weight = 4;
    // Weight for vector in fusion (default: 0.5)
    float vector_weight = 5;
    // Optional time range filter
    optional TimeRange time_filter = 6;
    // Target type filter
    VectorTargetType target = 7;
    // Phase 18: Filter results by agent
    optional string agent_filter = 8;
}

// Response from hybrid search
message HybridSearchResponse {
    // Ranked matches by fused score
    repeated VectorMatch matches = 1;
    // Actual mode used for this search
    HybridMode mode_used = 2;
    // Whether BM25 index was available
    bool bm25_available = 3;
    // Whether vector index was available
    bool vector_available = 4;
}

// Request for vector index status
message GetVectorIndexStatusRequest {}

// Vector index status and statistics
message VectorIndexStatus {
    // Whether index is available for search
    bool available = 1;
    // Number of vectors in the index
    int64 vector_count = 2;
    // Embedding dimension
    int32 dimension = 3;
    // Last index update timestamp (RFC3339)
    string last_indexed = 4;
    // Index file path
    string index_path = 5;
    // Index size in bytes
    int64 size_bytes = 6;
}

// ===== Topic Graph Messages (Phase 14 - TOPIC-08) =====

// Request for topic graph status
message GetTopicGraphStatusRequest {}

// Response with topic graph status
message GetTopicGraphStatusResponse {
    // Total number of topics
    uint64 topic_count = 1;
    // Total number of relationships between topics
    uint64 relationship_count = 2;
    // Last update timestamp (RFC3339)
    string last_updated = 3;
    // Whether the topic graph is available
    bool available = 4;
}

// A semantic topic from the topic graph
message Topic {
    // Unique topic identifier
    string id = 1;
    // Human-readable label
    string label = 2;
    // Time-decayed importance score (0.0 - 1.0+)
    float importance_score = 3;
    // Keywords associated with this topic
    repeated string keywords = 4;
    // When the topic was first created (RFC3339)
    string created_at = 5;
    // Most recent mention timestamp (RFC3339)
    string last_mention = 6;
}

// A relationship between two topics
message TopicRelationship {
    // Source topic ID
    string source_id = 1;
    // Target topic ID
    string target_id = 2;
    // Relationship type: "co-occurrence", "semantic", "hierarchical"
    string relationship_type = 3;
    // Relationship strength (0.0 - 1.0)
    float strength = 4;
}

// Request for topics by query
message GetTopicsByQueryRequest {
    // Search query (keywords to match against topic labels/keywords)
    string query = 1;
    // Maximum results to return (default: 10)
    uint32 limit = 2;
}

// Response with matching topics
message GetTopicsByQueryResponse {
    // Topics matching the query
    repeated Topic topics = 1;
}

// Request for related topics
message GetRelatedTopicsRequest {
    // Topic ID to find related topics for
    string topic_id = 1;
    // Optional: filter by relationship type ("co-occurrence", "semantic", "hierarchical")
    string relationship_type = 2;
    // Maximum results to return (default: 10)
    uint32 limit = 3;
}

// Response with related topics
message GetRelatedTopicsResponse {
    // Topics related to the requested topic
    repeated Topic related_topics = 1;
    // Relationships between the source topic and related topics
    repeated TopicRelationship relationships = 2;
}

// Request for top topics by importance
message GetTopTopicsRequest {
    // Maximum results to return (default: 10)
    uint32 limit = 1;
    // Look back window in days for importance calculation (default: 30)
    uint32 days = 2;
}

// Response with top topics
message GetTopTopicsResponse {
    // Topics sorted by importance score (descending)
    repeated Topic topics = 1;
}

// ===== Index Lifecycle Messages (Phase 16 - FR-08, FR-09) =====

// Request to prune vector index
message PruneVectorIndexRequest {
    // Optional: prune specific level only ("segment", "grip", "day", "week", or "" for all)
    string level = 1;
    // Override retention days (0 = use config)
    uint32 age_days_override = 2;
    // If true, report what would be pruned without actually deleting
    bool dry_run = 3;
}

// Response from vector prune
message PruneVectorIndexResponse {
    bool success = 1;
    uint32 segments_pruned = 2;
    uint32 grips_pruned = 3;
    uint32 days_pruned = 4;
    uint32 weeks_pruned = 5;
    string message = 6;
}

// Request to prune BM25 index
message PruneBm25IndexRequest {
    // Optional: prune specific level only ("segment", "grip", "day", "week", "all", or "")
    string level = 1;
    // Override retention days (0 = use config)
    uint32 age_days_override = 2;
    // If true, report what would be pruned without actually deleting
    bool dry_run = 3;
}

// Response from BM25 prune
message PruneBm25IndexResponse {
    bool success = 1;
    uint32 segments_pruned = 2;
    uint32 grips_pruned = 3;
    uint32 days_pruned = 4;
    uint32 weeks_pruned = 5;
    bool optimized = 6;
    string message = 7;
}

// Request for ranking/novelty status
message GetRankingStatusRequest {}

// Ranking and novelty status
message GetRankingStatusResponse {
    // Whether salience scoring is enabled
    bool salience_enabled = 1;

    // Whether usage decay is enabled
    bool usage_decay_enabled = 2;

    // Novelty checking status
    bool novelty_enabled = 3;
    int64 novelty_checked_total = 4;
    int64 novelty_rejected_total = 5;
    int64 novelty_skipped_total = 6;

    // Vector lifecycle status
    bool vector_lifecycle_enabled = 7;
    int64 vector_last_prune_timestamp = 8;
    uint32 vector_last_prune_count = 9;

    // BM25 lifecycle status
    bool bm25_lifecycle_enabled = 10;
    int64 bm25_last_prune_timestamp = 11;
    uint32 bm25_last_prune_count = 12;
}

// ===== Agent Retrieval Policy Messages (Phase 17) =====

// Query intent classification
enum QueryIntent {
    QUERY_INTENT_UNSPECIFIED = 0;
    QUERY_INTENT_EXPLORE = 1;     // Discover patterns, themes
    QUERY_INTENT_ANSWER = 2;      // Get evidence-backed result
    QUERY_INTENT_LOCATE = 3;      // Find exact snippet
    QUERY_INTENT_TIME_BOXED = 4;  // Return best partial in N ms
}

// Capability tier based on available layers
enum CapabilityTier {
    CAPABILITY_TIER_UNSPECIFIED = 0;
    CAPABILITY_TIER_FULL = 1;     // Topics + Hybrid + Agentic
    CAPABILITY_TIER_HYBRID = 2;   // BM25 + Vector + Agentic
    CAPABILITY_TIER_SEMANTIC = 3; // Vector + Agentic only
    CAPABILITY_TIER_KEYWORD = 4;  // BM25 + Agentic only
    CAPABILITY_TIER_AGENTIC = 5;  // Agentic TOC only
}

// Execution mode for retrieval
enum ExecutionMode {
    EXECUTION_MODE_UNSPECIFIED = 0;
    EXECUTION_MODE_SEQUENTIAL = 1;  // One layer at a time
    EXECUTION_MODE_PARALLEL = 2;    // Multiple layers at once
    EXECUTION_MODE_HYBRID = 3;      // Start parallel, cancel losers
}

// Retrieval layer identifier
enum RetrievalLayer {
    RETRIEVAL_LAYER_UNSPECIFIED = 0;
    RETRIEVAL_LAYER_TOPICS = 1;
    RETRIEVAL_LAYER_HYBRID = 2;
    RETRIEVAL_LAYER_VECTOR = 3;
    RETRIEVAL_LAYER_BM25 = 4;
    RETRIEVAL_LAYER_AGENTIC = 5;
}

// Status of a single retrieval layer
message LayerStatus {
    RetrievalLayer layer = 1;
    bool enabled = 2;
    bool healthy = 3;
    uint64 doc_count = 4;
    optional string message = 5;
}

// Request for retrieval capabilities
message GetRetrievalCapabilitiesRequest {}

// Response with combined status of all layers
message GetRetrievalCapabilitiesResponse {
    // Detected capability tier
    CapabilityTier tier = 1;

    // Individual layer statuses
    LayerStatus bm25_status = 2;
    LayerStatus vector_status = 3;
    LayerStatus topics_status = 4;
    LayerStatus agentic_status = 5;

    // Detection time in milliseconds
    uint64 detection_time_ms = 6;

    // Any warnings from detection
    repeated string warnings = 7;
}

// Stop conditions for retrieval
message StopConditions {
    uint32 max_depth = 1;
    uint32 max_nodes = 2;
    uint32 max_rpc_calls = 3;
    uint32 max_tokens = 4;
    uint64 timeout_ms = 5;
    uint32 beam_width = 6;
    float min_confidence = 7;
}

// Request to classify query intent
message ClassifyQueryIntentRequest {
    string query = 1;
    // Optional explicit timeout (forces TIME_BOXED)
    optional uint64 timeout_ms = 2;
}

// Response with classified intent
message ClassifyQueryIntentResponse {
    QueryIntent intent = 1;
    float confidence = 2;
    string reason = 3;
    repeated string matched_keywords = 4;
    // Time constraint if detected
    optional uint64 lookback_ms = 5;
}

// Request to route a query
message RouteQueryRequest {
    string query = 1;
    // Optional intent override (skips classification)
    optional QueryIntent intent_override = 2;
    // Optional stop conditions (uses defaults if not provided)
    optional StopConditions stop_conditions = 3;
    // Optional execution mode override
    optional ExecutionMode mode_override = 4;
    // Maximum results to return
    int32 limit = 5;
    // Phase 18: Filter results by agent (e.g., "claude", "opencode")
    // Empty/absent means return all agents
    optional string agent_filter = 6;
}

// A single retrieval result
message RetrievalResult {
    string doc_id = 1;
    string doc_type = 2;
    float score = 3;
    string text_preview = 4;
    RetrievalLayer source_layer = 5;
    map<string, string> metadata = 6;
    // Phase 18: Source agent that produced this result
    optional string agent = 7;
}

// Explainability payload for retrieval decisions
message ExplainabilityPayload {
    QueryIntent intent = 1;
    CapabilityTier tier = 2;
    ExecutionMode mode = 3;
    repeated RetrievalLayer candidates_considered = 4;
    RetrievalLayer winner = 5;
    string why_winner = 6;
    bool fallback_occurred = 7;
    optional string fallback_reason = 8;
    uint64 total_time_ms = 9;
    repeated string grip_ids = 10;
}

// Response from query routing
message RouteQueryResponse {
    // Search results
    repeated RetrievalResult results = 1;

    // Explainability payload
    ExplainabilityPayload explanation = 2;

    // Whether any results were found
    bool has_results = 3;

    // Layers that were attempted
    repeated RetrievalLayer layers_attempted = 4;
}

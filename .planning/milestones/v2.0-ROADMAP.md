# Milestone v2.0: Scheduler+Teleport

**Status:** SHIPPED 2026-02-07
**Phases:** 10-17 (including 10.5)
**Total Plans:** 42

## Overview

Milestone v2.0 delivers the **cognitive architecture for agents** with a full layered stack from index-free agentic search through semantic acceleration, topic discovery, ranking policy, and retrieval brainstem. Every layer above the foundational TOC is an accelerator, not a dependency — the system gracefully degrades if any index fails.

### Cognitive Layer Stack

| Layer | Phase | Capability | Status |
|-------|-------|------------|--------|
| **Integration** | 10 | Background scheduler, cron jobs | Complete |
| **Agentic Navigation** (2) | 10.5 | Index-free search (always works) | Complete |
| **Keyword Acceleration** (3) | 11 | BM25/Tantivy teleport | Complete |
| **Semantic Acceleration** (4) | 12 | Vector/HNSW teleport | Complete |
| **Index Lifecycle** | 13 | Outbox-driven index updates | Complete |
| **Conceptual Enrichment** (5) | 14 | Topic graph discovery | Complete |
| **Configuration UX** | 15 | Interactive wizard skills | Complete |
| **Ranking Policy** (6) | 16 | Salience, usage decay, novelty, lifecycle | Complete |
| **Retrieval Policy** (Control) | 17 | Intent routing, tier detection, fallbacks | Complete |

## Phases

### Phase 10: Background Scheduler
**Goal**: Provide in-process Tokio-based cron scheduler for periodic background jobs (TOC rollups, compaction, index maintenance)
**Depends on**: Phase 9
**Requirements**: SCHED-01, SCHED-02, SCHED-03, SCHED-04, SCHED-05
**Plans**: 4 plans complete

Plans:
- [x] 10-01-PLAN.md — Scheduler infrastructure (memory-scheduler crate, tokio-cron-scheduler, timezone handling)
- [x] 10-02-PLAN.md — Job registry and lifecycle (JobRegistry, overlap policy, jitter utilities)
- [x] 10-03-PLAN.md — TOC rollup jobs (wire existing rollups to scheduler, daemon integration)
- [x] 10-04-PLAN.md — Job observability (GetSchedulerStatus RPC, CLI scheduler commands)

**Key Decisions:**
- SchedulerService wraps tokio-cron-scheduler's JobScheduler
- OverlapPolicy::Skip is default to prevent job pileup
- JitterConfig generates random delay in milliseconds
- Jobs receive CancellationToken for graceful shutdown

### Phase 10.5: Agentic TOC Search (INSERTED)
**Goal**: Add foundational agentic search using TOC navigation with simple term matching - works without any index dependencies
**Depends on**: Phase 10
**Requirements**: SEARCH-01, SEARCH-02, SEARCH-03, SEARCH-04, SEARCH-05
**Plans**: 3 plans complete

Plans:
- [x] 10.5-01-PLAN.md — Core search logic (search_node function, term overlap scoring, unit tests)
- [x] 10.5-02-PLAN.md — gRPC integration (SearchNode/SearchChildren RPCs, integration tests)
- [x] 10.5-03-PLAN.md — CLI and agent (search command, navigator agent updates, documentation)

**Key Decisions:**
- Simple term-overlap scoring without external dependencies
- Always works even if all indexes fail
- Foundation for graceful degradation pattern

### Phase 11: BM25 Teleport (Tantivy)
**Goal**: Enable fast keyword-based search that "teleports" agents directly to relevant TOC nodes or grips
**Depends on**: Phase 10
**Requirements**: TELE-01, TELE-04, TELE-05, TELE-06, TELE-07
**Plans**: 4 plans complete

Plans:
- [x] 11-01-PLAN.md — Tantivy integration (memory-search crate, schema, index setup)
- [x] 11-02-PLAN.md — Indexing pipeline (TOC node and grip text extraction, document mapping)
- [x] 11-03-PLAN.md — Search API (gRPC TeleportSearch RPC, BM25 scoring)
- [x] 11-04-PLAN.md — CLI and testing (teleport command, background commit job)

**Key Decisions:**
- Tantivy embedded index stores searchable text from TOC summaries and grip excerpts
- Index is incrementally updated as new TOC nodes are created
- BM25 scoring returns relevance scores for agent decision-making

### Phase 12: Vector Teleport (HNSW)
**Goal**: Enable semantic similarity search for conceptually related content even when keywords don't match
**Depends on**: Phase 11
**Requirements**: TELE-02, TELE-04, TELE-05, TELE-06, FR-09, FR-10
**Plans**: 5 plans complete

Plans:
- [x] 12-01-PLAN.md — Embedding infrastructure (memory-embeddings crate, Candle model, caching)
- [x] 12-02-PLAN.md — Vector index (memory-vector crate, usearch HNSW, metadata storage)
- [x] 12-02b-PLAN.md — Vector indexing pipeline (outbox consumer, checkpoint recovery, admin commands)
- [x] 12-03-PLAN.md — gRPC integration (VectorTeleport, HybridSearch, GetVectorIndexStatus RPCs)
- [x] 12-04-PLAN.md — CLI and documentation (teleport commands, user guide)

**Key Decisions:**
- Local all-MiniLM-L6-v2 model via Candle (no API dependency)
- usearch HNSW for approximate nearest neighbor search
- Hybrid search combines BM25 and vector scores

### Phase 13: Outbox Index Ingestion
**Goal**: Drive index updates from the existing outbox pattern for rebuildable, crash-safe search indexes
**Depends on**: Phase 12
**Requirements**: TELE-03
**Plans**: 4 plans complete

Plans:
- [x] 13-01-PLAN.md — Outbox consumer infrastructure (memory-indexing crate, outbox reading, checkpoint tracking)
- [x] 13-02-PLAN.md — Incremental index updates (IndexingPipeline, dispatch logic, mock tests)
- [x] 13-03-PLAN.md — Full rebuild command (admin rebuild-indexes, dry-run support)
- [x] 13-04-PLAN.md — Scheduler integration (background job, GetIndexingStatus RPC)

**Key Decisions:**
- Outbox entries trigger index updates for new TOC nodes and grips
- Index consumer tracks checkpoint for crash recovery
- Indexes are disposable and rebuildable from storage

### Phase 14: Topic Graph Memory
**Goal**: Enable conceptual discovery through semantic topics extracted from TOC summaries with time-decayed importance
**Depends on**: Phase 12 (uses embedding infrastructure)
**Requirements**: TOPIC-01 through TOPIC-08
**Plans**: 6 plans complete

Plans:
- [x] 14-01-PLAN.md — Topic extraction (memory-topics crate, CF_TOPICS, HDBSCAN clustering, cosine similarity)
- [x] 14-02-PLAN.md — Topic labeling (LLM integration with keyword fallback, stopword filtering)
- [x] 14-03-PLAN.md — Importance scoring (exponential time decay with configurable half-life)
- [x] 14-04-PLAN.md — Topic relationships (similarity detection, parent/child hierarchy, cycle prevention)
- [x] 14-05-PLAN.md — Navigation RPCs (5 gRPC endpoints: status, query, nodes, top, related)
- [x] 14-06-PLAN.md — Lifecycle management (pruning, resurrection, scheduler jobs, CLI commands)

**Key Decisions:**
- HDBSCAN clustering for topic extraction
- Exponential time decay with configurable half-life
- Fully optional via configuration (topics.enabled = false)

### Phase 15: Configuration Wizard Skills
**Goal**: Create interactive AskUserQuestion-based configuration wizard skills for advanced storage, LLM, and multi-agent configuration
**Depends on**: Phase 9 (Setup & Installer Plugin)
**Requirements**: CONFIG-01, CONFIG-02, CONFIG-03, CONFIG-04
**Plans**: 5 plans complete

Plans:
- [x] 15-01-PLAN.md — memory-storage skill (storage paths, retention, cleanup, GDPR, performance tuning)
- [x] 15-02-PLAN.md — memory-llm skill (provider, model discovery, API testing, cost estimation, budget)
- [x] 15-03-PLAN.md — memory-agents skill (multi-agent mode, agent ID, query scope, team settings)
- [x] 15-04-PLAN.md — Reference documentation (retention-policies.md, provider-comparison.md, storage-strategies.md)
- [x] 15-05-PLAN.md — Plugin integration and memory-setup updates (marketplace.json, gap resolution)

**Key Decisions:**
- Interactive AskUserQuestion-based wizards
- State detection skips already-configured options
- Three flag modes: --fresh, --minimal, --advanced

### Phase 16: Memory Ranking Enhancements
**Goal**: Add retrieval policy improvements with salience scoring, usage tracking, novelty filtering, and index lifecycle automation
**Depends on**: Phase 14 (Topic Graph - uses time-decay pattern)
**Requirements**: RANK-01 through RANK-10
**Plans**: 5 plans complete

Plans:
- [x] 16-01-PLAN.md — Salience scoring (MemoryKind enum, SalienceScorer, TocNode/Grip fields)
- [x] 16-02-PLAN.md — Usage counters (CF_USAGE_COUNTERS, UsageTracker, cache-first reads)
- [x] 16-03-PLAN.md — Novelty threshold (NoveltyChecker, opt-in, fail-open behavior)
- [x] 16-04-PLAN.md — Vector pruning automation (FR-08, per-level retention, scheduler job)
- [x] 16-05-PLAN.md — BM25 lifecycle (FR-09, disabled by default, post-prune optimize)

**Key Decisions:**
- MemoryKind enum: Observation, Preference, Procedure, Constraint, Definition
- Usage tracking in separate CF (CF_USAGE_COUNTERS)
- Novelty filtering opt-in with fail-open behavior
- Index lifecycle automation via scheduler jobs

### Phase 17: Agent Retrieval Policy
**Goal**: Implement the retrieval "brainstem" - decision algorithm for layer selection, intent classification, fallback chains, and skill contracts
**Depends on**: Phase 16 (uses ranking signals), Phase 14 (Topics), Phase 12 (Vector), Phase 11 (BM25), Phase 10.5 (Agentic TOC)
**Requirements**: RETR-01 through RETR-19
**Plans**: 6 plans complete

Plans:
- [x] 17-01-PLAN.md — Core retrieval types (QueryIntent, CapabilityTier, StopConditions, ExecutionMode)
- [x] 17-02-PLAN.md — Intent classification (IntentClassifier with keyword heuristics, time constraint extraction)
- [x] 17-03-PLAN.md — Tier detection (TierDetector, CombinedStatus, GetRetrievalCapabilities proto)
- [x] 17-04-PLAN.md — Execution engine (FallbackChain, RetrievalExecutor, parallel/hybrid modes)
- [x] 17-05-PLAN.md — Skill contracts (ExplainabilityPayload, SkillContract validation, SKILL.md generation)
- [x] 17-06-PLAN.md — CLI/RPC integration (RetrievalHandler, retrieval status/classify/route commands)

**Key Decisions:**
- QueryIntent enum: Explore, Answer, Locate, TimeBoxed
- CapabilityTier enum: Full (1), Hybrid (2), Semantic (3), Keyword (4), Agentic (5)
- Fallback chains skip disabled layers automatically
- ExplainabilityPayload tracks tier used, layers tried, stop reason

---

## Milestone Summary

**Key Decisions:**
- Indexes are accelerators, not dependencies (graceful degradation)
- Skills are the control plane (executive function)
- Cognitive layers stack: Raw Events → TOC → Agentic Search → BM25 → Vector → Topics
- Retrieval policy unifies all layers with intent-based routing

**Issues Resolved:**
- Index-free search added (Phase 10.5) to guarantee baseline functionality
- Outbox-driven indexing enables rebuildable, crash-safe indexes
- Topic graph fully optional via configuration

**Issues Deferred:**
- OpenCode hook adapter (external dependency)
- Gemini CLI hook adapter (external dependency)
- GitHub Copilot CLI hook adapter (external dependency)
- Prune status RPCs (admin feature, scheduler jobs work)

**Technical Debt Incurred:**
- 3 stub RPCs (GetRankingStatus, PruneVectorIndex, PruneBm25Index) - admin features, non-blocking
- Missing SUMMARY.md files for some phases (tracking incomplete)

---

*For current project status, see .planning/ROADMAP.md*

---
*Archived: 2026-02-07 as part of v2.0 milestone completion*

# Requirements Archive: v2.0 Scheduler+Teleport

**Archived:** 2026-02-07
**Status:** SHIPPED

This is the archived requirements specification for v2.0.
For current requirements, see `.planning/REQUIREMENTS.md` (created for next milestone).

---

## v1 Requirements (Complete from v1.0.0)

All v1 requirements were shipped in v1.0.0. See v1.0-REQUIREMENTS.md for details.

## v2 Requirements

### Storage (Complete)

- [x] **STOR-01**: Append-only event storage with time-prefixed keys (`evt:{ts}:{ulid}`)
- [x] **STOR-02**: RocksDB column family isolation (events, toc_nodes, toc_latest, grips, outbox, checkpoints)
- [x] **STOR-03**: Checkpoint-based crash recovery for background jobs
- [x] **STOR-04**: Per-project RocksDB instances (one store per project directory)
- [x] **STOR-05**: FIFO or Universal compaction for append-only workload
- [x] **STOR-06**: Configurable multi-agent mode (unified store with tags OR separate stores)

### TOC Hierarchy (Complete)

- [x] **TOC-01**: Full time hierarchy (Year -> Month -> Week -> Day -> Segment)
- [x] **TOC-02**: TOC nodes store title, bullets, keywords, child_node_ids
- [x] **TOC-03**: Segment creation on time threshold (30 min) or token threshold (4K)
- [x] **TOC-04**: Segment overlap for context continuity (5 min or 500 tokens)
- [x] **TOC-05**: Day/Week/Month rollup jobs with checkpointing
- [x] **TOC-06**: Versioned TOC nodes (append new version, don't mutate)

### Grips (Complete)

- [x] **GRIP-01**: Grip struct with excerpt, event_id_start, event_id_end, timestamp, source
- [x] **GRIP-02**: TOC node bullets link to supporting grips
- [x] **GRIP-03**: Grips stored in dedicated column family
- [x] **GRIP-04**: ExpandGrip returns context events around excerpt

### Summarization (Complete)

- [x] **SUMM-01**: Pluggable Summarizer trait (async, supports API and local LLM)
- [x] **SUMM-02**: Summarizer generates title, bullets, keywords from events
- [x] **SUMM-03**: Summarizer extracts grips as evidence for bullets
- [x] **SUMM-04**: Rollup summarizer aggregates child node summaries

### Ingestion (Complete)

- [x] **ING-01**: gRPC IngestEvent RPC accepts Event message
- [x] **ING-02**: Event includes session_id, timestamp, role, text, metadata
- [x] **ING-03**: Idempotent writes using event_id as key
- [x] **ING-04**: Source timestamp used for ordering (not ingestion time)
- [x] **ING-05**: Outbox entry written atomically with event (for future index updates)

### Query (Complete)

- [x] **QRY-01**: GetTocRoot RPC returns top-level time nodes
- [x] **QRY-02**: GetNode RPC returns node with children and summary
- [x] **QRY-03**: BrowseToc RPC supports pagination of children
- [x] **QRY-04**: GetEvents RPC retrieves raw events by time range
- [x] **QRY-05**: ExpandGrip RPC retrieves context around grip excerpt

### gRPC Service (Complete)

- [x] **GRPC-01**: Memory daemon exposes gRPC service (tonic)
- [x] **GRPC-02**: Proto definitions for Event, TocNode, Grip, all RPCs
- [x] **GRPC-03**: Health check endpoint (tonic-health)
- [x] **GRPC-04**: Reflection endpoint for debugging (tonic-reflection)

### Hook Handler Integration (Complete)

- [x] **HOOK-01**: code_agent_context_hooks repo provides hook handlers
- [x] **HOOK-02**: Hook handlers call daemon's IngestEvent RPC
- [x] **HOOK-03**: Event types map 1:1 from hook events

### Configuration (Complete)

- [x] **CFG-01**: Layered config: defaults -> config file -> env vars -> CLI flags
- [x] **CFG-02**: Config includes: db_path, grpc_port, summarizer settings
- [x] **CFG-03**: Config file location: ~/.config/agent-memory/config.toml

### CLI (Complete)

- [x] **CLI-01**: Memory daemon binary with start/stop/status commands
- [x] **CLI-02**: Query CLI for manual TOC navigation and testing
- [x] **CLI-03**: Admin commands: rebuild-toc, compact, status

### Teleport Indexes (Complete)

- [x] **TELE-01**: BM25 teleport index via Tantivy (embedded) — Phase 11
- [x] **TELE-02**: Vector teleport index via HNSW (embedded) — Phase 12
- [x] **TELE-03**: Outbox relay consumes outbox entries, updates indexes — Phase 13
- [x] **TELE-04**: TeleportQuery RPC searches BM25 and/or vector, returns node_ids/grip_ids
- [x] **TELE-05**: Index rebuild command from outbox or TOC
- [x] **TELE-06**: IndexStatus RPC reports index health
- [x] **TELE-07**: GetTeleportStatus RPC returns config & health for agent skill discovery

### Memory Ranking Enhancements (Complete)

- [x] **RANK-01**: Salience scoring at write time for TOC nodes and Grips — Phase 16
- [x] **RANK-02**: Usage tracking in separate CF (CF_USAGE_COUNTERS)
- [x] **RANK-03**: Cache-first usage reads with LRU cache
- [x] **RANK-04**: Novelty filtering (opt-in, disabled by default)
- [x] **RANK-05**: Vector lifecycle automation per FR-08 retention rules
- [x] **RANK-06**: BM25 lifecycle automation per FR-09 (disabled by default)
- [x] **RANK-07**: Feature flags for all ranking enhancements
- [x] **RANK-08**: Backward compatibility with v2.0.0 data
- [x] **RANK-09**: Staged rollout support with master switch
- [x] **RANK-10**: Config validation on startup

### Agent Retrieval Policy (Complete)

- [x] **RETR-01**: Combined status check for all layer availability — Phase 17
- [x] **RETR-02**: Tier detection algorithm (maps availability to tiers 1-5)
- [x] **RETR-03**: Capability advertisement to skills
- [x] **RETR-04**: Query intent classification (Explore/Answer/Locate/Time-boxed)
- [x] **RETR-05**: Intent-aware routing to appropriate layers
- [x] **RETR-06**: Time constraint extraction from queries
- [x] **RETR-07**: Configuration-aware search (respects enabled layers)
- [x] **RETR-08**: Graceful degradation on layer failure
- [x] **RETR-09**: Partial result return on timeout
- [x] **RETR-10**: Stop condition enforcement (max_depth, max_nodes, timeout)
- [x] **RETR-11**: Timeout handling per intent type
- [x] **RETR-12**: Scanning trigger conditions
- [x] **RETR-13**: Tier/method reporting in results
- [x] **RETR-14**: Fallback explanation in results
- [x] **RETR-15**: Execution mode selection (Sequential/Parallel/Hybrid)
- [x] **RETR-16**: Bounded fan-out for parallel execution
- [x] **RETR-17**: Early stopping on sufficient results
- [x] **RETR-18**: Rank merge across multiple layers
- [x] **RETR-19**: Explainable arbitration for skill contracts

### Pending (Deferred to v2.1+)

- [ ] **CCH-01**: Memory-ingest binary that CCH can invoke via `run` action
- [ ] **CCH-02**: Event mapping from CCH events to memory events
- [ ] **CCH-03**: hooks.yaml template for agent-memory integration
- [ ] **SKILL-01**: Claude Code skill with commands (traceability not updated)
- [ ] **SKILL-02**: Skill uses memory-client library
- [ ] **SKILL-03**: Skill navigates TOC, expands grips
- [ ] **HOOK-04**: OpenCode hook adapter
- [ ] **HOOK-05**: Gemini CLI hook adapter
- [ ] **HOOK-06**: GitHub Copilot CLI hook adapter

---

## Milestone Summary

**Shipped:** 77 of 84 v2 requirements
**Adjusted:** None
**Dropped:** None (7 deferred to v2.1+)

### Deferred Items Explanation

| Requirement | Reason |
|-------------|--------|
| CCH-01, CCH-02, CCH-03 | External CCH integration - deferred pending CCH repo updates |
| SKILL-01, SKILL-02, SKILL-03 | Plugin exists, traceability not updated in REQUIREMENTS.md |
| HOOK-04, HOOK-05, HOOK-06 | External hook adapters for other AI agents - future milestone |

---
*Archived: 2026-02-07 as part of v2.0 milestone completion*

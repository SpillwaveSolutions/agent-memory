---
phase: 24-proto-service-debt-cleanup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - proto/memory.proto
  - crates/memory-search/src/searcher.rs
  - crates/memory-search/src/schema.rs
  - crates/memory-search/src/document.rs
  - crates/memory-search/src/indexer.rs
  - crates/memory-service/src/teleport_service.rs
  - crates/memory-service/src/vector.rs
  - crates/memory-vector/src/metadata.rs
autonomous: true

must_haves:
  truths:
    - "TeleportSearchResult proto message includes an agent field populated from indexed TocNode contributing_agents"
    - "VectorMatch proto message includes an agent field populated from vector metadata"
    - "TeleportResult Rust struct includes an agent field set during search result mapping"
    - "VectorEntry metadata stores agent attribution for vector search results"
  artifacts:
    - path: "proto/memory.proto"
      provides: "Agent field on TeleportSearchResult and VectorMatch"
      contains: "agent"
    - path: "crates/memory-search/src/searcher.rs"
      provides: "TeleportResult with agent field"
      contains: "agent"
    - path: "crates/memory-search/src/schema.rs"
      provides: "BM25 schema with agent field"
      contains: "agent"
    - path: "crates/memory-vector/src/metadata.rs"
      provides: "VectorEntry with agent field"
      contains: "agent"
  key_links:
    - from: "crates/memory-search/src/indexer.rs"
      to: "TocNode.contributing_agents"
      via: "index agent from toc node"
      pattern: "contributing_agents"
    - from: "crates/memory-service/src/teleport_service.rs"
      to: "TeleportResult.agent"
      via: "maps agent to proto field"
      pattern: "agent"
    - from: "crates/memory-service/src/vector.rs"
      to: "VectorEntry.agent"
      via: "maps agent to VectorMatch proto"
      pattern: "agent"
---

<objective>
Add agent attribution field to BM25 teleport results and vector search results, populating from TOC node contributing_agents and event metadata.

Purpose: DEBT-05 and DEBT-06 — teleport and vector search results currently lack agent attribution, making it impossible for callers to know which agent produced a result. After this plan, both TeleportSearchResult and VectorMatch include an `agent` field.
Output: Updated proto, search schema, indexer, searcher, metadata, and service handlers with agent attribution.
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@proto/memory.proto
@crates/memory-search/src/schema.rs
@crates/memory-search/src/searcher.rs
@crates/memory-search/src/document.rs
@crates/memory-search/src/indexer.rs
@crates/memory-service/src/teleport_service.rs
@crates/memory-service/src/vector.rs
@crates/memory-vector/src/metadata.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add agent field to proto messages and Rust search structs</name>
  <files>
proto/memory.proto
crates/memory-search/src/schema.rs
crates/memory-search/src/searcher.rs
crates/memory-search/src/document.rs
crates/memory-search/src/indexer.rs
crates/memory-vector/src/metadata.rs
  </files>
  <action>
**Proto changes (proto/memory.proto):**
1. Add `optional string agent = 6;` to `TeleportSearchResult` message (after `timestamp_ms` field 5). This uses field number 6 which is the next available.
2. Add `optional string agent = 6;` to `VectorMatch` message (after `timestamp_ms` field 5). This uses field number 6 which is the next available.

**BM25 search schema (crates/memory-search/src/schema.rs):**
1. Add `pub agent: Field` to `SearchSchema` struct.
2. In `build_teleport_schema()`, add `let agent = schema_builder.add_text_field("agent", STRING | STORED);` and include it in the returned struct.
3. In `SearchSchema::from_schema()`, add `let agent = schema.get_field("agent").map_err(|_| SearchError::SchemaMismatch("missing agent field".into()))?;` and include in the returned struct.

**TeleportResult (crates/memory-search/src/searcher.rs):**
1. Add `pub agent: Option<String>` to the `TeleportResult` struct.
2. In the `search` method's result mapping loop, extract agent from the document: `let agent = doc.get_first(self.schema.agent).and_then(|v| v.as_str()).map(|s| s.to_string()).filter(|s| !s.is_empty());`
3. Set `agent` field in the `TeleportResult` constructor.

**Document builder (crates/memory-search/src/document.rs):**
1. In `toc_node_to_doc`, add the agent field from `TocNode::contributing_agents`. Use the first contributing agent as the primary agent: `if let Some(first_agent) = node.contributing_agents.first() { doc.add_text(schema.agent, first_agent); }`. If contributing_agents is empty, add empty string.
2. In `grip_to_doc`, agent is not directly available on Grip. Add empty string: `doc.add_text(schema.agent, "");` — grips inherit agent from their parent node when queried.

**Indexer (crates/memory-search/src/indexer.rs):**
1. Verify that `index_toc_node` and `index_grip` methods pass through to `toc_node_to_doc`/`grip_to_doc` — they should automatically pick up the new field since the document builder now includes it.

**VectorEntry (crates/memory-vector/src/metadata.rs):**
1. Add `pub agent: Option<String>` to `VectorEntry` struct with `#[serde(default)]` for backward compatibility with existing serialized entries.
2. Update `VectorEntry::new()` to accept an optional agent parameter. To avoid breaking all callers, add a new method `with_agent(mut self, agent: Option<String>) -> Self` builder pattern.

Run `cargo build` after proto changes to regenerate the Rust bindings.
  </action>
  <verify>
`cargo build --workspace` succeeds (proto regeneration + all crates compile).
`cargo test -p memory-search` passes (existing tests may need minor agent field additions).
`cargo test -p memory-vector` passes.
`cargo clippy --workspace --all-targets -- -D warnings` passes.
  </verify>
  <done>Proto messages, Rust search structs, BM25 schema, and vector metadata all have agent fields. Indexer stores agent from TocNode.contributing_agents. VectorEntry supports agent with backward compatibility.</done>
</task>

<task type="auto">
  <name>Task 2: Wire agent field through service handlers and add tests</name>
  <files>
crates/memory-service/src/teleport_service.rs
crates/memory-service/src/vector.rs
  </files>
  <action>
**Teleport service handler (crates/memory-service/src/teleport_service.rs):**
1. In `handle_teleport_search`, update the `TeleportSearchResult` mapping to include the agent field from `TeleportResult`: `agent: r.agent,`

**Vector teleport handler (crates/memory-service/src/vector.rs):**
1. In the `vector_teleport` method, update the `VectorMatch` construction to include the agent field from `VectorEntry`: `agent: entry.agent.clone(),`
   (Note: `entry.agent` will be `None` for old entries due to `#[serde(default)]`, which maps to proto `None` correctly.)
2. In the `search` method (used by retrieval handler), update `VectorSearchResult` struct to include `pub agent: Option<String>`, and populate from `entry.agent`.

**Tests:**
1. In `teleport_service.rs` tests, update the test assertions to verify the agent field exists (can be None for existing test data since test TocNodes don't set contributing_agents).
2. Add a new test in `teleport_service.rs`: `test_handle_teleport_search_with_agent` that creates a TocNode with `contributing_agents: vec!["claude"]`, indexes it, searches, and verifies the result has `agent: Some("claude")`.
3. In `vector.rs`, no additional tests needed since integration tests require the embedding model. The type changes are verified by compilation.
  </action>
  <verify>
`cargo test -p memory-service -- test_handle_teleport_search` passes.
`cargo clippy -p memory-service --all-targets -- -D warnings` passes.
  </verify>
  <done>BM25 teleport results and vector search results propagate agent attribution from index through to gRPC response.</done>
</task>

</tasks>

<verification>
```bash
cargo build --workspace
cargo test -p memory-search
cargo test -p memory-vector
cargo test -p memory-service -- teleport
cargo clippy --workspace --all-targets --all-features -- -D warnings
```
</verification>

<success_criteria>
- TeleportSearchResult proto has `optional string agent` field
- VectorMatch proto has `optional string agent` field
- BM25 search results include agent from TocNode.contributing_agents
- Vector search results include agent from VectorEntry metadata
- All existing tests pass with no regressions
- No clippy warnings
</success_criteria>

<output>
After completion, create `.planning/phases/24-proto-service-debt-cleanup/24-02-SUMMARY.md`
</output>

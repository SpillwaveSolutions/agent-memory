---
phase: 24-proto-service-debt-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/memory-service/src/ingest.rs
  - crates/memory-service/src/agents.rs
autonomous: true

must_haves:
  truths:
    - "GetRankingStatus RPC returns actual salience config (enabled, weights) instead of hardcoded false/0"
    - "GetRankingStatus RPC returns actual novelty config status (enabled, threshold)"
    - "ListAgents RPC returns non-zero session_count by scanning events for distinct session_ids per agent"
  artifacts:
    - path: "crates/memory-service/src/ingest.rs"
      provides: "Wired GetRankingStatus returning real config data"
      contains: "SalienceConfig"
    - path: "crates/memory-service/src/agents.rs"
      provides: "ListAgents with event-based session_count"
      contains: "session_count"
  key_links:
    - from: "crates/memory-service/src/ingest.rs"
      to: "memory_types::SalienceConfig"
      via: "import and default config read"
      pattern: "SalienceConfig::default"
    - from: "crates/memory-service/src/agents.rs"
      to: "storage.get_events_in_range"
      via: "event scanning for session counting"
      pattern: "get_events_in_range"
---

<objective>
Wire GetRankingStatus RPC to return actual configuration data and fix ListAgents session_count via event scanning.

Purpose: DEBT-01 and DEBT-04 — these two RPCs return stub/zero data today. After this plan, both return real values from config and storage respectively.
Output: Updated `ingest.rs` with wired GetRankingStatus, updated `agents.rs` with session_count from events.
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@crates/memory-service/src/ingest.rs
@crates/memory-service/src/agents.rs
@crates/memory-types/src/salience.rs
@crates/memory-types/src/config.rs
@crates/memory-service/src/novelty.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire GetRankingStatus to return real config data</name>
  <files>crates/memory-service/src/ingest.rs</files>
  <action>
Replace the stub `get_ranking_status` implementation in `MemoryServiceImpl` (currently returns all false/0 hardcoded values) with a real implementation that:

1. Read `SalienceConfig::default()` from `memory_types` — report `salience_enabled` = `config.enabled` (true by default).
2. Read `NoveltyConfig::default()` from `memory_types::config` — report `novelty_enabled` = `config.enabled` (false by default). For novelty counters (checked/rejected/skipped), return 0 since there's no persistent counter store yet — this is accurate for a fresh daemon (the NoveltyChecker metrics are in-memory only).
3. For `usage_decay_enabled`, return `true` (usage decay is always active per Phase 16 design).
4. For vector/BM25 lifecycle fields:
   - `vector_lifecycle_enabled`: Check if `vector_service` is Some (indicates vector is configured, lifecycle is enabled by default per `VectorLifecycleConfig::default().enabled`)
   - `bm25_lifecycle_enabled`: Check if `teleport_searcher` is Some (indicates BM25 is configured; BM25 lifecycle is disabled by default per `Bm25LifecycleConfig::default().enabled`, but report false since there's no way to know config without storing it)
   - For last_prune_timestamp and last_prune_count: return 0 (no persistent prune history yet — accurate).

Add necessary imports: `use memory_types::SalienceConfig;` and `use memory_types::config::NoveltyConfig;`.

Remove the `_request` underscore prefix since the parameter is now used (or keep it since we don't use the request body, just returning config).

Add a unit test `test_get_ranking_status_returns_defaults` that calls the RPC on a freshly-created MemoryServiceImpl and verifies:
- `salience_enabled` is `true`
- `novelty_enabled` is `false`
- `usage_decay_enabled` is `true`
  </action>
  <verify>
`cargo test -p memory-service -- test_get_ranking_status` passes.
`cargo clippy -p memory-service -- -D warnings` passes.
  </verify>
  <done>GetRankingStatus returns actual salience/novelty/decay config values instead of all-false stubs.</done>
</task>

<task type="auto">
  <name>Task 2: Fix ListAgents session_count via event scanning</name>
  <files>crates/memory-service/src/agents.rs</files>
  <action>
Update the `list_agents` method in `AgentDiscoveryHandler` to compute accurate `session_count` per agent by scanning events:

1. After building the `agent_map` from TOC nodes (existing O(k) loop), scan events to count distinct session_ids per agent.
2. Use `self.storage.get_events_in_range(i64::MIN, i64::MAX)` to get all events. For each event, deserialize with `serde_json::from_slice::<Event>`, extract `agent` (default "unknown") and `session_id`. Build a `HashMap<String, HashSet<String>>` mapping agent_id -> set of session_ids.
3. IMPORTANT: This is an O(n) scan. To keep it bounded, limit to recent events (e.g., last 365 days = `Utc::now().timestamp_millis() - 365*24*60*60*1000`). If there are many events, this still completes in reasonable time because events are small and RocksDB range scans are efficient.
4. After building the session map, merge into the agent_map: for each agent in session_counts, set `session_count` = `session_ids.len()`. For agents in the TOC but not in events (unlikely), keep session_count = 0.

Also update the existing test `test_list_agents_aggregates_from_toc_nodes` to verify session_count. Add a new test `test_list_agents_session_count_from_events` that:
- Stores events with different session_ids and agents
- Stores corresponding TOC nodes with contributing_agents
- Calls ListAgents and verifies session_count reflects distinct session_ids per agent

Add `use std::collections::HashSet;` if not already imported.
  </action>
  <verify>
`cargo test -p memory-service -- test_list_agents` passes (both old and new tests).
`cargo clippy -p memory-service -- -D warnings` passes.
  </verify>
  <done>ListAgents returns accurate session_count based on distinct session_ids from event scanning, not hardcoded 0.</done>
</task>

</tasks>

<verification>
```bash
cargo test -p memory-service -- test_get_ranking_status
cargo test -p memory-service -- test_list_agents
cargo clippy -p memory-service --all-targets -- -D warnings
```
</verification>

<success_criteria>
- GetRankingStatus returns `salience_enabled: true`, `usage_decay_enabled: true`, `novelty_enabled: false` by default
- ListAgents returns non-zero session_count when events with distinct session_ids exist
- All existing tests still pass
- No clippy warnings
</success_criteria>

<output>
After completion, create `.planning/phases/24-proto-service-debt-cleanup/24-01-SUMMARY.md`
</output>

# 10.5-02 Summary: gRPC SearchNode/SearchChildren RPCs

## Status: COMPLETE

## What Was Done

### 1. Proto Definitions (proto/memory.proto)

Added search RPC definitions and messages:

- **SearchField enum**: `SEARCH_FIELD_UNSPECIFIED`, `TITLE`, `SUMMARY`, `BULLETS`, `KEYWORDS`
- **SearchNodeRequest/Response**: Search within a single node
- **SearchChildrenRequest/Response**: Search children of a parent node
- **SearchMatch**: Individual match with field, text, grip_ids, score
- **SearchNodeResult**: Node result with matches and relevance score
- **RPCs**: `SearchNode` and `SearchChildren` added to MemoryService

### 2. Search Service Implementation (crates/memory-service/src/search_service.rs)

Created new module with:

- **proto_to_domain_field()**: Converts proto SearchField to domain SearchField
- **domain_to_proto_field()**: Converts domain SearchField to proto SearchField
- **domain_to_proto_match()**: Converts domain SearchMatch to proto SearchMatch
- **domain_to_proto_level()**: Converts domain TocLevel to proto TocLevel
- **search_node()**: RPC handler that loads node, calls core search, returns matches
- **search_children()**: RPC handler that searches all children of parent, sorts by relevance

### 3. Service Wiring

- Added `pub mod search_service;` to `crates/memory-service/src/lib.rs`
- Added `memory-toc` dependency to `crates/memory-service/Cargo.toml`
- Wired `search_node` and `search_children` RPCs in `MemoryServiceImpl`

### 4. Tests Added

- test_search_node_not_found
- test_search_node_empty_node_id
- test_search_node_empty_query
- test_search_node_whitespace_query
- test_search_children_empty_query
- test_search_children_empty_results
- test_proto_to_domain_field_* (title, summary, bullets, keywords, unspecified, invalid)
- test_domain_to_proto_field_roundtrip
- test_domain_to_proto_level

## Files Modified

| File | Changes |
|------|---------|
| `proto/memory.proto` | Added SearchField enum, search messages, SearchNode/SearchChildren RPCs |
| `crates/memory-service/src/search_service.rs` | NEW - RPC handlers and conversion helpers |
| `crates/memory-service/src/lib.rs` | Added search_service module export |
| `crates/memory-service/src/ingest.rs` | Added search RPC methods to MemoryServiceImpl |
| `crates/memory-service/Cargo.toml` | Added memory-toc dependency |
| `Cargo.toml` (workspace) | memory-toc already present in workspace deps |

## Verification

```bash
cargo build -p memory-service  # Compiles successfully
cargo test -p memory-service   # All 43 tests pass (includes 16 new search_service tests)
cargo check                    # Full workspace compiles
```

## Key Design Decisions

1. **Follows existing RPC patterns**: search_service.rs follows query.rs patterns
2. **Proto field naming**: Uses `SEARCH_FIELD_` prefix like `EVENT_ROLE_`
3. **Empty fields = all fields**: When fields array is empty, searches all fields
4. **Relevance sorting**: SearchChildren sorts results by average match score descending
5. **Limit defaults**: Default limit of 10 for both RPCs

## Next Steps

Phase 10.5-03: Add CLI commands (`mem search-node`, `mem search-children`) that call these RPCs.

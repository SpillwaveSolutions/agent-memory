# Plan 05-02: Query CLI

## Goal

Add query commands to the CLI for manual TOC navigation and testing.

## Requirements Covered

- **CLI-02**: Query CLI for manual TOC navigation and testing

## Tasks

### Task 1: Add Query Subcommand to CLI

**File: crates/memory-daemon/src/cli.rs**

Add `Query` variant to Commands enum with nested subcommands:

```rust
#[derive(Subcommand, Debug)]
pub enum Commands {
    // existing...

    /// Query the memory system
    Query {
        #[command(subcommand)]
        command: QueryCommands,
    },
}

#[derive(Subcommand, Debug)]
pub enum QueryCommands {
    /// List root TOC nodes (year level)
    Root,

    /// Get a specific TOC node
    Node {
        /// Node ID to retrieve
        node_id: String,
    },

    /// Browse children of a node
    Browse {
        /// Parent node ID
        parent_id: String,

        /// Maximum results
        #[arg(short, long, default_value = "20")]
        limit: u32,

        /// Continuation token for pagination
        #[arg(short, long)]
        token: Option<String>,
    },

    /// Get events in time range
    Events {
        /// Start time (Unix ms or ISO)
        #[arg(long)]
        from: i64,

        /// End time (Unix ms or ISO)
        #[arg(long)]
        to: i64,

        /// Maximum results
        #[arg(short, long, default_value = "50")]
        limit: u32,
    },

    /// Expand a grip to show context
    Expand {
        /// Grip ID to expand
        grip_id: String,
    },
}
```

### Task 2: Implement Query Command Handler

**File: crates/memory-daemon/src/commands/query.rs**

```rust
use memory_client::MemoryClient;
use anyhow::Result;

pub async fn handle_query(command: QueryCommands, endpoint: &str) -> Result<()> {
    let mut client = MemoryClient::connect(endpoint).await?;

    match command {
        QueryCommands::Root => {
            let nodes = client.get_toc_root().await?;
            for node in nodes {
                println!("{}: {} ({})", node.node_id, node.title, node.level);
            }
        }
        QueryCommands::Node { node_id } => {
            let node = client.get_node(&node_id).await?;
            print_node(&node);
        }
        QueryCommands::Browse { parent_id, limit, token } => {
            let response = client.browse_toc(&parent_id, limit, token).await?;
            for child in response.children {
                println!("{}: {}", child.node_id, child.title);
            }
            if let Some(token) = response.continuation_token {
                println!("\nMore results available. Use --token {}", token);
            }
        }
        QueryCommands::Events { from, to, limit } => {
            let events = client.get_events(from, to, limit).await?;
            for event in events {
                println!("[{}] {}: {}", event.timestamp, event.role, &event.text[..80.min(event.text.len())]);
            }
        }
        QueryCommands::Expand { grip_id } => {
            let context = client.expand_grip(&grip_id).await?;
            println!("=== Before ===");
            for e in context.events_before { println!("{}", e.text); }
            println!("\n=== Excerpt ===\n{}", context.excerpt);
            println!("\n=== After ===");
            for e in context.events_after { println!("{}", e.text); }
        }
    }
    Ok(())
}

fn print_node(node: &TocNode) {
    println!("ID: {}", node.node_id);
    println!("Title: {}", node.title);
    println!("Level: {:?}", node.level);
    println!("Summary: {}", node.summary.as_deref().unwrap_or("-"));
    println!("\nBullets:");
    for bullet in &node.bullets {
        println!("  â€¢ {}", bullet.text);
    }
    println!("\nChildren: {}", node.child_node_ids.len());
}
```

### Task 3: Add Query Methods to MemoryClient

**File: crates/memory-client/src/client.rs**

Add methods for query RPCs:

```rust
impl MemoryClient {
    pub async fn get_toc_root(&mut self) -> Result<Vec<TocNode>, ClientError>;
    pub async fn get_node(&mut self, node_id: &str) -> Result<TocNode, ClientError>;
    pub async fn browse_toc(&mut self, parent_id: &str, limit: u32, token: Option<String>) -> Result<BrowseResponse, ClientError>;
    pub async fn get_events(&mut self, from: i64, to: i64, limit: u32) -> Result<Vec<Event>, ClientError>;
    pub async fn expand_grip(&mut self, grip_id: &str) -> Result<GripContext, ClientError>;
}
```

### Task 4: Wire Query Command in main.rs

Update main.rs to handle Query command.

### Task 5: Add Tests

Test CLI parsing for query commands.

## Acceptance Criteria

- [ ] `memory-daemon query root` lists year nodes
- [ ] `memory-daemon query node <id>` shows node details
- [ ] `memory-daemon query browse <id>` paginates children
- [ ] `memory-daemon query events --from --to` retrieves events
- [ ] `memory-daemon query expand <grip_id>` shows context
- [ ] Helpful error messages on connection failure

## Dependencies

- Plan 05-01 complete (MemoryClient)

---
*Plan created: 2026-01-30*

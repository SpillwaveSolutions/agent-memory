# Plan 05-03: Admin Commands

## Goal

Add administrative commands for TOC rebuilding, database compaction, and status reporting.

## Requirements Covered

- **CLI-03**: Admin commands: rebuild-toc, compact, status

## Tasks

### Task 1: Add Admin Subcommand to CLI

**File: crates/memory-daemon/src/cli.rs**

Add `Admin` variant to Commands enum:

```rust
#[derive(Subcommand, Debug)]
pub enum Commands {
    // existing...

    /// Administrative commands
    Admin {
        #[command(subcommand)]
        command: AdminCommands,
    },
}

#[derive(Subcommand, Debug)]
pub enum AdminCommands {
    /// Rebuild TOC from raw events
    RebuildToc {
        /// Start from this date (YYYY-MM-DD)
        #[arg(long)]
        from_date: Option<String>,

        /// Dry run - show what would be done
        #[arg(long)]
        dry_run: bool,
    },

    /// Trigger RocksDB compaction
    Compact {
        /// Compact only specific column family
        #[arg(long)]
        cf: Option<String>,
    },

    /// Show database statistics
    Stats,
}
```

### Task 2: Add Admin RPCs to Proto

**File: proto/memory.proto**

```protobuf
// Admin messages
message RebuildTocRequest {
    optional int64 from_timestamp_ms = 1;
    bool dry_run = 2;
}

message RebuildTocResponse {
    int32 segments_created = 1;
    int32 nodes_updated = 2;
    string message = 3;
}

message CompactRequest {
    optional string column_family = 1;
}

message CompactResponse {
    string message = 1;
}

message StatsRequest {}

message StatsResponse {
    int64 event_count = 1;
    int64 toc_node_count = 2;
    int64 grip_count = 3;
    int64 disk_usage_bytes = 4;
    map<string, int64> cf_sizes = 5;
}

service MemoryService {
    // existing RPCs...

    // Admin RPCs
    rpc RebuildToc(RebuildTocRequest) returns (RebuildTocResponse);
    rpc Compact(CompactRequest) returns (CompactResponse);
    rpc GetStats(StatsRequest) returns (StatsResponse);
}
```

### Task 3: Implement Admin RPC Handlers

**File: crates/memory-service/src/admin.rs**

```rust
use crate::proto::{RebuildTocRequest, RebuildTocResponse, CompactRequest, CompactResponse, StatsRequest, StatsResponse};
use memory_storage::Storage;
use std::sync::Arc;

pub async fn rebuild_toc(
    storage: Arc<Storage>,
    request: RebuildTocRequest,
) -> Result<RebuildTocResponse, tonic::Status> {
    // 1. Query events from storage starting from from_timestamp
    // 2. Re-run segmentation
    // 3. Re-generate TOC nodes
    // 4. Return counts
}

pub async fn compact(
    storage: Arc<Storage>,
    request: CompactRequest,
) -> Result<CompactResponse, tonic::Status> {
    // Call storage.compact() or storage.compact_cf(cf_name)
}

pub async fn get_stats(
    storage: Arc<Storage>,
) -> Result<StatsResponse, tonic::Status> {
    // Gather counts from each CF
    // Get disk usage via std::fs
}
```

### Task 4: Add Stats/Compact Methods to Storage

**File: crates/memory-storage/src/db.rs**

```rust
impl Storage {
    pub fn compact(&self) -> Result<(), StorageError> {
        self.db.compact_range::<&[u8], &[u8]>(None, None);
        Ok(())
    }

    pub fn compact_cf(&self, cf_name: &str) -> Result<(), StorageError> {
        let cf = self.db.cf_handle(cf_name).ok_or(...)?;
        self.db.compact_range_cf::<&[u8], &[u8]>(&cf, None, None);
        Ok(())
    }

    pub fn get_stats(&self) -> Result<StorageStats, StorageError> {
        // Count entries in each CF
        // Get disk usage
    }
}
```

### Task 5: Implement Admin Command Handler

**File: crates/memory-daemon/src/commands/admin.rs**

```rust
pub async fn handle_admin(command: AdminCommands, endpoint: &str) -> Result<()> {
    let mut client = MemoryClient::connect(endpoint).await?;

    match command {
        AdminCommands::RebuildToc { from_date, dry_run } => {
            let from_ts = from_date.map(|d| parse_date(&d));
            let result = client.rebuild_toc(from_ts, dry_run).await?;
            println!("Segments created: {}", result.segments_created);
            println!("Nodes updated: {}", result.nodes_updated);
        }
        AdminCommands::Compact { cf } => {
            let result = client.compact(cf).await?;
            println!("{}", result.message);
        }
        AdminCommands::Stats => {
            let stats = client.get_stats().await?;
            println!("Events:     {}", stats.event_count);
            println!("TOC Nodes:  {}", stats.toc_node_count);
            println!("Grips:      {}", stats.grip_count);
            println!("Disk Usage: {} MB", stats.disk_usage_bytes / 1024 / 1024);
        }
    }
    Ok(())
}
```

### Task 6: Add Admin Methods to MemoryClient

```rust
impl MemoryClient {
    pub async fn rebuild_toc(&mut self, from_ts: Option<i64>, dry_run: bool) -> Result<RebuildTocResponse, ClientError>;
    pub async fn compact(&mut self, cf: Option<String>) -> Result<CompactResponse, ClientError>;
    pub async fn get_stats(&mut self) -> Result<StatsResponse, ClientError>;
}
```

### Task 7: Wire Admin Command in main.rs

### Task 8: Add Tests

Test CLI parsing, storage stats method.

## Acceptance Criteria

- [ ] `memory-daemon admin rebuild-toc` rebuilds TOC from events
- [ ] `memory-daemon admin compact` triggers compaction
- [ ] `memory-daemon admin stats` shows database statistics
- [ ] --dry-run flag shows plan without executing
- [ ] Error handling for connection failures

## Dependencies

- Plan 05-01 complete (MemoryClient)
- Plan 05-02 complete (query module pattern)

---
*Plan created: 2026-01-30*

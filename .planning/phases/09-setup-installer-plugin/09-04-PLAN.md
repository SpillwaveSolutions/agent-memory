# Plan 09-04: Health Check and Troubleshooting

## Metadata

```yaml
phase: 9
plan: 04
wave: 3
depends_on: [09-01, 09-02]
files_modified:
  - plugins/memory-setup-plugin/commands/memory-status.md (update)
  - plugins/memory-setup-plugin/commands/memory-config.md (update)
  - plugins/memory-setup-plugin/agents/setup-troubleshooter.md (update)
  - plugins/memory-setup-plugin/skills/memory-setup/references/troubleshooting-guide.md (update)
autonomous: true
```

## Objective

Implement comprehensive health checking via /memory-status, configuration management via /memory-config, and autonomous troubleshooting via the setup-troubleshooter agent.

## Context

After installation, users need:
- Quick health check: "Is it working?"
- Configuration access: "What's my current setup?"
- Problem diagnosis: "Why isn't it capturing events?"
- Self-healing: "Fix common issues automatically"

## Tasks

### Task 1: Implement /memory-status Command

```xml
<task id="1">
  <title>Complete memory-status.md command definition</title>
  <description>
    Update commands/memory-status.md with full implementation:

    Health Checks:
    ```bash
    # Daemon running
    pgrep -x memory-daemon || echo "NOT RUNNING"

    # Port listening
    lsof -i :50051 | grep LISTEN

    # gRPC connectivity
    grpcurl -plaintext localhost:50051 list

    # Database accessible
    ls -la ~/.local/share/agent-memory/db/

    # Recent events
    memory-daemon query events --limit 1

    # Hook configured
    grep -r "memory-ingest" ~/.claude/hooks.yaml
    ```

    Output Format (default):
    ```
    Agent Memory Status
    ═══════════════════════════════════════════════════

    Component       Status    Details
    ─────────────────────────────────────────────────────
    Daemon          ✓ OK      Running (PID 12345, port 50051)
    Database        ✓ OK      1.2 GB, 15,432 events
    Hooks           ✓ OK      Global hooks.yaml configured
    API Key         ✓ OK      ANTHROPIC_API_KEY set
    Auto-start      ✓ OK      launchd service enabled

    Recent Activity
    ─────────────────────────────────────────────────────
    Last event:     2 minutes ago
    Today:          47 events
    This week:      312 events
    ```

    Output Format (--json):
    ```json
    {
      "daemon": {"status": "ok", "pid": 12345, "port": 50051},
      "database": {"status": "ok", "size_bytes": 1288490188, "event_count": 15432},
      "hooks": {"status": "ok", "location": "global"},
      "api_key": {"status": "ok", "provider": "anthropic"},
      "autostart": {"status": "ok", "method": "launchd"},
      "activity": {"last_event": "2024-01-30T10:15:00Z", "today": 47, "week": 312}
    }
    ```

    Output Format (--verbose):
    - Include full configuration dump
    - Show all environment variables
    - List all database column families with sizes
  </description>
  <acceptance>
    - All health checks documented
    - Three output formats defined
    - Status symbols consistent
  </acceptance>
</task>
```

### Task 2: Implement /memory-config Command

```xml
<task id="2">
  <title>Complete memory-config.md command definition</title>
  <description>
    Update commands/memory-config.md with full implementation:

    Subcommand: show
    ```
    /memory-config show

    Current Configuration
    ═════════════════════

    [daemon]
    port = 50051
    db_path = ~/.local/share/agent-memory/db

    [summarizer]
    provider = anthropic
    model = claude-3-haiku-20240307

    [segmentation]
    time_threshold_mins = 30
    token_threshold = 4000

    Environment:
    ANTHROPIC_API_KEY = ****...****
    MEMORY_DAEMON_PORT = (not set)
    ```

    Subcommand: set
    ```
    /memory-config set <key> <value>

    Examples:
    /memory-config set daemon.port 50052
    /memory-config set summarizer.provider openai
    /memory-config set segmentation.time_threshold_mins 60
    ```

    Validation:
    - daemon.port: 1024-65535, check availability
    - summarizer.provider: anthropic|openai|local|none
    - summarizer.model: validate against provider
    - segmentation.*: positive integers

    After set:
    - Write to config.toml
    - Warn if daemon restart needed
    - Offer to restart daemon

    Subcommand: reset
    ```
    /memory-config reset

    This will reset configuration to defaults.
    Your data will NOT be deleted.

    Proceed? [y/N]
    ```
  </description>
  <acceptance>
    - All subcommands documented
    - Validation rules specified
    - Side effects explained
  </acceptance>
</task>
```

### Task 3: Implement Troubleshooter Agent

```xml
<task id="3">
  <title>Complete setup-troubleshooter.md agent definition</title>
  <description>
    Update agents/setup-troubleshooter.md with full diagnostic capabilities:

    Trigger Conditions:
    - User says "memory not working"
    - User says "events not being captured"
    - /memory-status shows failures
    - Explicit: "troubleshoot my memory setup"

    Diagnostic Flow:
    ```
    1. Check daemon status
       - Not running → Start daemon
       - Port conflict → Find and resolve
       - Crash loop → Check logs

    2. Check hook configuration
       - Missing → Generate hooks.yaml
       - Wrong path → Fix binary path
       - Not triggering → Verify hook format

    3. Check gRPC connectivity
       - Connection refused → Daemon issue
       - Timeout → Firewall/network issue
       - Auth error → Check configuration

    4. Check event flow
       - Events arriving → Working
       - No events → Trace from hook
       - Events malformed → Check mapping

    5. Check summarization
       - API key missing → Prompt for key
       - API error → Check quota/validity
       - Local model → Check ollama running
    ```

    Fix Capabilities (can modify without asking):
    - Start stopped daemon
    - Create missing directories
    - Add execute permission to binaries
    - Write missing config with defaults

    Fix Capabilities (ask first):
    - Kill process using port
    - Overwrite existing configuration
    - Install missing binaries
    - Modify hooks.yaml

    Escalation Triggers:
    - Multiple failed fix attempts
    - Unknown error type
    - User data might be affected
    - Requires credentials input

    Example Diagnostic Session:
    ```
    User: "My conversations aren't being saved"

    Troubleshooter:
    ───────────────────────────────────────────────
    Diagnosing Agent Memory...

    ✓ Daemon: Running (PID 12345)
    ✓ Port: 50051 available
    ✓ Database: Accessible
    ✗ Hooks: Not configured

    Issue Found: No hooks.yaml configuration

    Fix: I'll add the hook configuration to ~/.claude/hooks.yaml

    [Writes hooks.yaml]

    ✓ Hooks: Configured

    Verification: Please send a test message and I'll check
    if it was captured...

    ✓ Event captured successfully!

    Your memory setup is now working.
    ───────────────────────────────────────────────
    ```
  </description>
  <acceptance>
    - Clear trigger conditions
    - Comprehensive diagnostic flow
    - Safe vs ask-first fixes defined
    - Escalation criteria specified
  </acceptance>
</task>
```

### Task 4: Create Troubleshooting Guide

```xml
<task id="4">
  <title>Complete troubleshooting-guide.md reference</title>
  <description>
    Update references/troubleshooting-guide.md with common issues:

    Issue: Daemon won't start
    ```
    Symptoms: memory-daemon start fails silently
    Causes:
    - Port 50051 already in use
    - Missing RocksDB library
    - Permission denied on db_path

    Diagnosis:
    lsof -i :50051
    memory-daemon start 2>&1 | head

    Solutions:
    1. Kill existing process: kill $(lsof -t -i:50051)
    2. Install RocksDB: brew install rocksdb (macOS)
    3. Fix permissions: chmod -R 755 ~/.local/share/agent-memory
    ```

    Issue: Events not being captured
    ```
    Symptoms: /memory-recent shows no recent events
    Causes:
    - Hooks not configured
    - memory-ingest not in PATH
    - Daemon not running
    - Hook errors silently failing

    Diagnosis:
    cat ~/.claude/hooks.yaml
    which memory-ingest
    memory-daemon status

    Solutions:
    1. Add hooks: /memory-setup --fresh
    2. Fix PATH: export PATH="$HOME/.local/bin:$PATH"
    3. Start daemon: memory-daemon start
    ```

    Issue: Summarization failing
    ```
    Symptoms: TOC nodes have no summaries
    Causes:
    - API key not set
    - API quota exceeded
    - Network issues

    Diagnosis:
    echo $ANTHROPIC_API_KEY | head -c 10
    curl -s https://api.anthropic.com/v1/messages -H "x-api-key: $ANTHROPIC_API_KEY"

    Solutions:
    1. Set API key: export ANTHROPIC_API_KEY="sk-..."
    2. Check Anthropic dashboard for quota
    3. Try alternative provider: /memory-config set summarizer.provider openai
    ```

    Issue: High disk usage
    ```
    Symptoms: Database growing rapidly
    Causes:
    - Normal for heavy usage
    - Compaction not running
    - Too many events retained

    Diagnosis:
    du -sh ~/.local/share/agent-memory/db/
    memory-daemon admin status

    Solutions:
    1. Trigger compaction: memory-daemon admin compact
    2. Configure retention (future feature)
    ```

    Include 10+ common issues with diagnosis and solutions.
  </description>
  <acceptance>
    - At least 10 common issues covered
    - Each has symptoms, causes, diagnosis, solutions
    - Commands are copy-paste ready
  </acceptance>
</task>
```

### Task 5: Add Diagnostic Commands to SKILL.md

```xml
<task id="5">
  <title>Add quick diagnostic commands to SKILL.md</title>
  <description>
    Add "Quick Diagnostics" section to SKILL.md:

    ```markdown
    ## Quick Diagnostics

    Copy-paste these commands for rapid troubleshooting:

    ### Is the daemon running?
    ```bash
    pgrep -x memory-daemon && echo "Running" || echo "Not running"
    ```

    ### What's using port 50051?
    ```bash
    lsof -i :50051
    ```

    ### Can I connect to the daemon?
    ```bash
    memory-daemon query root 2>&1 | head -5
    ```

    ### Are hooks configured?
    ```bash
    grep -l "memory-ingest" ~/.claude/hooks.yaml .claude/hooks.yaml 2>/dev/null
    ```

    ### Is my API key set?
    ```bash
    [ -n "$ANTHROPIC_API_KEY" ] && echo "Set" || echo "Not set"
    ```

    ### What's the database size?
    ```bash
    du -sh ~/.local/share/agent-memory/db/
    ```

    ### Recent events count?
    ```bash
    memory-daemon admin status | grep -i event
    ```
    ```
  </description>
  <acceptance>
    - Commands work on macOS and Linux
    - Output is clear
    - Covers main diagnostic needs
  </acceptance>
</task>
```

## Verification

```yaml
verification:
  - [ ] /memory-status shows all component health
  - [ ] /memory-status --json produces valid JSON
  - [ ] /memory-config show displays current config
  - [ ] /memory-config set validates and updates
  - [ ] Troubleshooter has clear diagnostic flow
  - [ ] Troubleshooter knows when to ask vs auto-fix
  - [ ] Troubleshooting guide covers 10+ issues
  - [ ] Quick diagnostics in SKILL.md are functional
```

## Must-Haves (Goal-Backward)

For Phase 9 success, this plan must deliver:
1. /memory-status that quickly shows if everything is working
2. /memory-config that allows changing settings without file editing
3. Autonomous troubleshooter that can diagnose and fix common issues
4. Comprehensive troubleshooting guide for manual resolution

# Plan 09-02: Interactive Wizard Flow

## Metadata

```yaml
phase: 9
plan: 02
wave: 2
depends_on: [09-01]
files_modified:
  - plugins/memory-setup-plugin/skills/memory-setup/SKILL.md (update)
  - plugins/memory-setup-plugin/commands/memory-setup.md (update)
  - plugins/memory-setup-plugin/skills/memory-setup/references/wizard-questions.md
autonomous: true
```

## Objective

Implement the detailed interactive wizard flow for /memory-setup that guides users through installation and configuration with progressive questioning.

## Context

The wizard should:
- Detect current state before asking questions
- Skip steps that are already complete
- Offer sensible defaults with option to customize
- Validate each step before proceeding
- Provide clear success/failure feedback

## Tasks

### Task 1: Define State Detection Logic

```xml
<task id="1">
  <title>Define state detection logic in SKILL.md</title>
  <description>
    Add state detection section to SKILL.md that checks:

    1. Prerequisites
       - Claude Code installation detected
       - Rust/cargo availability
       - Platform detection (macOS/Linux/Windows)

    2. Existing Installation
       - memory-daemon binary location
       - memory-ingest binary location
       - Current version if installed

    3. Configuration State
       - ~/.config/agent-memory/config.toml exists
       - hooks.yaml exists (global or project)
       - Environment variables set

    4. Runtime State
       - Daemon process running
       - Port availability
       - Recent event ingestion

    Include bash commands for each check.
  </description>
  <acceptance>
    - All checks have specific commands
    - Output parsing documented
    - State categories defined
  </acceptance>
</task>
```

### Task 2: Create Wizard Question Flow

```xml
<task id="2">
  <title>Create wizard-questions.md reference file</title>
  <description>
    Create references/wizard-questions.md with complete question flow:

    Step 1: Installation Method
    - Condition: binaries not found
    - Options: cargo install, download binary, manual
    - Default: cargo install if cargo available

    Step 2: Installation Location
    - Condition: installing binaries
    - Options: ~/.local/bin, ~/.cargo/bin, custom
    - Default: ~/.local/bin

    Step 3: Summarizer Provider
    - Condition: config.toml not found OR --fresh
    - Options: Anthropic, OpenAI, Local (ollama), None
    - Default: Anthropic

    Step 4: API Key
    - Condition: provider requires API key AND env var not set
    - Input: API key value
    - Validation: format check, test call

    Step 5: Hook Scope
    - Condition: hooks.yaml not found OR --fresh
    - Options: Global, Project-only, Skip
    - Default: Global

    Step 6: Daemon Startup
    - Condition: daemon not running
    - Options: Start + auto-start, Start only, Manual
    - Default: Start + auto-start

    Include skip conditions and dependencies between questions.
  </description>
  <acceptance>
    - All questions have conditions
    - Skip logic documented
    - Defaults are sensible
    - Validation rules specified
  </acceptance>
</task>
```

### Task 3: Update memory-setup.md Command

```xml
<task id="3">
  <title>Update memory-setup.md with detailed wizard instructions</title>
  <description>
    Expand commands/memory-setup.md with:

    1. State Detection Phase
       - What to check
       - How to report current state

    2. Question Phase
       - How to use AskUserQuestion tool
       - Question grouping (max 4 per call)
       - How to handle "Other" responses

    3. Execution Phase
       - How to execute installation
       - How to write configuration files
       - How to start daemon

    4. Verification Phase
       - What to check after setup
       - How to report success/failure
       - What to suggest as next steps

    Include example output formatting.
  </description>
  <acceptance>
    - Clear phase separation
    - Tool usage documented
    - Output format specified
    - Error handling defined
  </acceptance>
</task>
```

### Task 4: Define Wizard Output Format

```xml
<task id="4">
  <title>Define wizard output formatting</title>
  <description>
    Add output formatting section to SKILL.md:

    Progress Display:
    ```
    Agent Memory Setup
    ══════════════════

    Checking prerequisites...
      ✓ Claude Code detected
      ✓ cargo available
      ✗ memory-daemon not found
      ✗ memory-ingest not found

    Step 1 of 6: Installation
    ─────────────────────────
    ```

    Success Display:
    ```
    ══════════════════════════════════════════════════
     Setup Complete!
    ══════════════════════════════════════════════════

    ✓ Binaries installed to ~/.local/bin/
    ✓ Configuration written to ~/.config/agent-memory/
    ✓ Hooks configured in ~/.claude/hooks.yaml
    ✓ Daemon started on port 50051

    Next steps:
      • Start a conversation and it will be recorded
      • Use /memory-recent to see captured events
      • Use /memory-search <topic> to find past discussions
    ```

    Error Display:
    ```
    ✗ Setup Failed
    ──────────────

    Error: Could not start daemon - port 50051 in use

    To fix:
      1. Run: lsof -i :50051
      2. Kill the process using the port
      3. Run: /memory-setup --fresh
    ```
  </description>
  <acceptance>
    - Consistent visual style
    - Clear progress indicators
    - Actionable error messages
  </acceptance>
</task>
```

### Task 5: Add Flag Handling

```xml
<task id="5">
  <title>Document flag handling for wizard modes</title>
  <description>
    Add flag documentation to memory-setup.md:

    --fresh
    - Ignore existing configuration
    - Re-ask all questions
    - Overwrite existing config files
    - Use case: Reset to clean state

    --minimal
    - Use all defaults without asking
    - Only ask for required inputs (API key if not in env)
    - Skip optional steps
    - Use case: Quick setup for experienced users

    --advanced
    - Show all configuration options
    - Include port selection
    - Include database path selection
    - Include segmentation tuning
    - Use case: Power users
  </description>
  <acceptance>
    - Each flag clearly documented
    - Behavior differences specified
    - Use cases provided
  </acceptance>
</task>
```

## Verification

```yaml
verification:
  - [ ] State detection covers all components
  - [ ] Question flow handles all scenarios
  - [ ] Skip logic prevents redundant questions
  - [ ] Output formatting is consistent
  - [ ] All flags documented with behaviors
  - [ ] Error messages are actionable
```

## Must-Haves (Goal-Backward)

For Phase 9 success, this plan must deliver:
1. Complete wizard question flow with conditions and defaults
2. State detection that identifies what's already configured
3. Clear output formatting for progress, success, and errors
4. Flag support for different user expertise levels

---
phase: 10-background-scheduler
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/memory-scheduler/Cargo.toml
  - crates/memory-scheduler/src/lib.rs
  - crates/memory-scheduler/src/scheduler.rs
  - crates/memory-scheduler/src/config.rs
  - crates/memory-scheduler/src/error.rs
  - Cargo.toml
autonomous: true

must_haves:
  truths:
    - "Cron expressions can be parsed and validated"
    - "Scheduler starts and accepts job registrations"
    - "Timezone-aware scheduling works correctly"
    - "Graceful shutdown stops the scheduler"
  artifacts:
    - path: "crates/memory-scheduler/Cargo.toml"
      provides: "Scheduler crate dependencies"
      contains: "tokio-cron-scheduler"
    - path: "crates/memory-scheduler/src/scheduler.rs"
      provides: "SchedulerService wrapper"
      exports: ["SchedulerService"]
    - path: "crates/memory-scheduler/src/config.rs"
      provides: "Scheduler configuration"
      exports: ["SchedulerConfig"]
  key_links:
    - from: "crates/memory-scheduler/src/scheduler.rs"
      to: "tokio-cron-scheduler::JobScheduler"
      via: "wraps JobScheduler with lifecycle methods"
      pattern: "JobScheduler::new"
    - from: "crates/memory-scheduler/src/scheduler.rs"
      to: "tokio_util::sync::CancellationToken"
      via: "shutdown signal propagation"
      pattern: "CancellationToken"
---

<objective>
Create the memory-scheduler crate with core scheduler infrastructure.

Purpose: Establish the foundation for background job scheduling using tokio-cron-scheduler with timezone support and graceful shutdown.
Output: New crate with SchedulerService, configuration, and basic lifecycle management.
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-background-scheduler/10-RESEARCH.md
@crates/memory-service/src/server.rs
@Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create memory-scheduler crate structure</name>
  <files>
    crates/memory-scheduler/Cargo.toml
    crates/memory-scheduler/src/lib.rs
    crates/memory-scheduler/src/error.rs
    Cargo.toml
  </files>
  <action>
Create the new memory-scheduler crate:

1. Create `crates/memory-scheduler/Cargo.toml`:
   - Package name: memory-scheduler
   - Inherit workspace.package fields (version, edition, license, repository)
   - Dependencies:
     - tokio-cron-scheduler = "0.15"
     - chrono-tz = "0.10"
     - tokio-util = { version = "0.7", features = ["rt"] }
     - tokio = { workspace = true }
     - chrono = { workspace = true }
     - tracing = { workspace = true }
     - thiserror = { workspace = true }
     - serde = { workspace = true }
   - Dev dependencies:
     - tokio = { workspace = true, features = ["test-util"] }

2. Create `crates/memory-scheduler/src/lib.rs`:
   - Module exports for scheduler, config, error
   - Doc comment explaining crate purpose (SCHED-01 through SCHED-05)

3. Create `crates/memory-scheduler/src/error.rs`:
   - Define SchedulerError enum with variants:
     - Scheduler(String) - tokio-cron-scheduler errors
     - InvalidCron(String) - cron expression validation
     - InvalidTimezone(String) - timezone parsing errors
     - JobNotFound(String)
     - AlreadyRunning
     - NotRunning
   - Implement From<JobSchedulerError> for SchedulerError

4. Update workspace `Cargo.toml`:
   - Add "crates/memory-scheduler" to workspace members
   - Add memory-scheduler = { path = "crates/memory-scheduler" } to workspace.dependencies
  </action>
  <verify>
    cd /Users/richardhightower/clients/spillwave/src/agent-memory && cargo check -p memory-scheduler
  </verify>
  <done>
    Crate compiles, error types defined, workspace includes memory-scheduler
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement SchedulerConfig and SchedulerService</name>
  <files>
    crates/memory-scheduler/src/config.rs
    crates/memory-scheduler/src/scheduler.rs
    crates/memory-scheduler/src/lib.rs
  </files>
  <action>
Implement core scheduler types:

1. Create `crates/memory-scheduler/src/config.rs`:
   - SchedulerConfig struct with:
     - default_timezone: String (default "UTC", parsed to chrono_tz::Tz)
     - shutdown_timeout_secs: u64 (default 30)
   - impl Default for SchedulerConfig
   - Method parse_timezone() -> Result<Tz, SchedulerError>
   - Serde derive for loading from config

2. Create `crates/memory-scheduler/src/scheduler.rs`:
   - Import tokio_cron_scheduler::{Job, JobScheduler, JobSchedulerError}
   - Import tokio_util::sync::CancellationToken

   - SchedulerService struct with:
     - scheduler: JobScheduler
     - config: SchedulerConfig
     - shutdown_token: CancellationToken
     - is_running: AtomicBool

   - impl SchedulerService:
     - pub async fn new(config: SchedulerConfig) -> Result<Self, SchedulerError>
       - Create JobScheduler with in-memory storage
       - Initialize shutdown_token
       - Set is_running = false

     - pub async fn start(&self) -> Result<(), SchedulerError>
       - Check not already running
       - Call scheduler.start().await
       - Set is_running = true
       - Log "Scheduler started"

     - pub async fn shutdown(&self) -> Result<(), SchedulerError>
       - Signal shutdown via token
       - Wait for shutdown_timeout
       - Call scheduler.shutdown().await
       - Set is_running = false
       - Log "Scheduler shutdown complete"

     - pub fn shutdown_token(&self) -> CancellationToken
       - Return clone of shutdown token for job cancellation

     - pub fn is_running(&self) -> bool

     - pub async fn add_job(&self, job: Job) -> Result<uuid::Uuid, SchedulerError>
       - Wrap scheduler.add(job).await
       - Return job UUID

3. Update lib.rs to export SchedulerConfig and SchedulerService

Note: Use #[tokio::test(flavor = "multi_thread")] for any tests per research pitfall.
  </action>
  <verify>
    cd /Users/richardhightower/clients/spillwave/src/agent-memory && cargo test -p memory-scheduler
  </verify>
  <done>
    SchedulerService starts, accepts jobs, shuts down gracefully. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add timezone-aware job creation helper</name>
  <files>
    crates/memory-scheduler/src/scheduler.rs
    crates/memory-scheduler/src/lib.rs
  </files>
  <action>
Add helper for creating timezone-aware jobs:

1. In scheduler.rs, add method to SchedulerService:
   - pub async fn add_cron_job<F, Fut>(
       &self,
       name: &str,
       cron_expr: &str,
       timezone: Option<&str>,
       job_fn: F,
     ) -> Result<uuid::Uuid, SchedulerError>
     where
       F: Fn() -> Fut + Clone + Send + Sync + 'static,
       Fut: std::future::Future<Output = ()> + Send,

     Implementation:
     - Parse timezone or use config.default_timezone
     - Validate cron expression by attempting to create job
     - Use Job::new_async_tz for timezone-aware scheduling
     - Clone shutdown_token into job closure for cancellation support
     - Wrap job_fn to log start/end with tracing
     - Add job to scheduler
     - Return job UUID

2. Add validate_cron_expression function (public):
   - fn validate_cron_expression(expr: &str) -> Result<(), SchedulerError>
   - Uses croner (via tokio-cron-scheduler) to validate
   - Returns InvalidCron error with descriptive message

3. Add unit tests:
   - test_add_cron_job_valid_expression
   - test_add_cron_job_invalid_expression
   - test_timezone_parsing (America/New_York, UTC, invalid)

Export validate_cron_expression from lib.rs
  </action>
  <verify>
    cd /Users/richardhightower/clients/spillwave/src/agent-memory && cargo test -p memory-scheduler -- --nocapture
  </verify>
  <done>
    Timezone-aware job creation works. Cron validation catches invalid expressions. Tests pass.
  </done>
</task>

</tasks>

<verification>
```bash
# Crate compiles
cd /Users/richardhightower/clients/spillwave/src/agent-memory
cargo build -p memory-scheduler

# All tests pass
cargo test -p memory-scheduler

# Scheduler lifecycle works (verified by tests)
cargo test -p memory-scheduler test_scheduler

# Clippy clean
cargo clippy -p memory-scheduler -- -D warnings
```
</verification>

<success_criteria>
- [ ] memory-scheduler crate exists in workspace
- [ ] SchedulerService wraps tokio-cron-scheduler
- [ ] SchedulerConfig supports timezone and shutdown timeout
- [ ] Cron expressions validated before job creation
- [ ] Timezone-aware scheduling via chrono-tz
- [ ] Graceful shutdown via CancellationToken pattern
- [ ] All tests pass with multi_thread flavor
- [ ] No clippy warnings
</success_criteria>

<output>
After completion, create `.planning/phases/10-background-scheduler/10-01-SUMMARY.md`
</output>

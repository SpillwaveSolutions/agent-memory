---
phase: 17-agent-retrieval-policy
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/memory-types/src/lib.rs
  - crates/memory-types/src/retrieval.rs
  - crates/memory-types/src/config.rs
  - proto/memory.proto
autonomous: true

must_haves:
  truths:
    - "QueryIntent enum classifies queries as Explore, Answer, Locate, or TimeBoxed"
    - "CapabilityTier enum represents 5 tiers from Full to Agentic-only"
    - "StopConditions struct enforces max_depth, max_nodes, max_rpc_calls, timeout_ms, beam_width limits"
    - "RetrievalConfig allows enabling/disabling features and setting default stop conditions"
  artifacts:
    - path: "crates/memory-types/src/retrieval.rs"
      provides: "Core retrieval policy types"
      exports: ["QueryIntent", "CapabilityTier", "StopConditions", "ExecutionMode", "RetrievalConfig"]
    - path: "proto/memory.proto"
      provides: "Proto definitions for retrieval policy"
      contains: "enum QueryIntent"
  key_links:
    - from: "crates/memory-types/src/lib.rs"
      to: "crates/memory-types/src/retrieval.rs"
      via: "pub mod retrieval"
      pattern: "pub mod retrieval"
---

<objective>
Create the foundational types for the retrieval policy: query intent classification, capability tiers, stop conditions, and execution modes.

Purpose: These types form the vocabulary for the entire retrieval policy. Every subsequent plan depends on these definitions. Per PRD Section 3-5, we define QueryIntent (Explore/Answer/Locate/TimeBoxed), CapabilityTier (1-5), StopConditions (max_depth, max_nodes, timeout, etc.), and ExecutionMode (Sequential/Parallel/Hybrid).

Output: New retrieval module in memory-types with all core enums, structs, and configs. Proto definitions for wire-compatible types.
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Technical reference
@docs/prds/agent-retrieval-policy-prd.md
@crates/memory-types/src/lib.rs
@crates/memory-types/src/config.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create retrieval module with core enums and StopConditions</name>
  <files>crates/memory-types/src/retrieval.rs, crates/memory-types/src/lib.rs</files>
  <action>
Create new file `crates/memory-types/src/retrieval.rs` with:

1. QueryIntent enum (PRD Section 3):
   ```rust
   #[derive(Debug, Clone, Copy, PartialEq, Eq, Hash, Serialize, Deserialize, Default)]
   #[serde(rename_all = "lowercase")]
   pub enum QueryIntent {
       /// Discover patterns, themes, related concepts
       /// Example: "What have I been working on?"
       Explore,
       /// Get evidence-backed result fast (DEFAULT)
       /// Example: "How did we fix the JWT bug?"
       #[default]
       Answer,
       /// Find exact snippet, quote, or definition
       /// Example: "Where did I define that config?"
       Locate,
       /// Return best partial in N ms, then stop
       /// Used by agentic skills with latency constraints
       TimeBoxed,
   }
   ```

2. CapabilityTier enum (PRD Section 5.1):
   ```rust
   #[derive(Debug, Clone, Copy, PartialEq, Eq, Hash, Serialize, Deserialize, PartialOrd, Ord)]
   pub enum CapabilityTier {
       /// Full: Topics + Hybrid + Agentic (best for explore + contextual answers)
       Tier1Full = 1,
       /// Hybrid: BM25 + Vector + Agentic (default for most answer queries)
       Tier2Hybrid = 2,
       /// Semantic: Vector + Agentic (concept queries)
       Tier3Semantic = 3,
       /// Keyword: BM25 + Agentic (exact term matching)
       Tier4Keyword = 4,
       /// Agentic: TOC Search only (always works - guaranteed fallback)
       Tier5Agentic = 5,
   }
   ```

   Implement Default as Tier5Agentic (safest fallback).

3. ExecutionMode enum (PRD Section 5.4):
   ```rust
   #[derive(Debug, Clone, Copy, PartialEq, Eq, Hash, Serialize, Deserialize, Default)]
   #[serde(rename_all = "lowercase")]
   pub enum ExecutionMode {
       /// One layer at a time, beam width 1 (DEFAULT - best explainability)
       #[default]
       Sequential,
       /// Multiple accelerators/siblings at once, bounded fan-out (2-5)
       Parallel,
       /// Start parallel, cancel losers when one dominates
       Hybrid,
   }
   ```

4. StopConditions struct (PRD Section 5.5):
   ```rust
   #[derive(Debug, Clone, Serialize, Deserialize)]
   pub struct StopConditions {
       /// Maximum depth of tree traversal (default: 5 levels)
       #[serde(default = "default_max_depth")]
       pub max_depth: u32,
       /// Maximum nodes visited (default: 100)
       #[serde(default = "default_max_nodes")]
       pub max_nodes_visited: u32,
       /// Maximum RPC calls (default: 20)
       #[serde(default = "default_max_rpc_calls")]
       pub max_rpc_calls: u32,
       /// Maximum token budget (default: 4000)
       #[serde(default = "default_token_budget")]
       pub max_token_budget: u32,
       /// Timeout in milliseconds (default: 5000)
       #[serde(default = "default_timeout_ms")]
       pub timeout_ms: u64,
       /// Beam width for parallel execution (default: 1, max: 5)
       #[serde(default = "default_beam_width")]
       pub beam_width: u32,
   }
   ```

   Add default functions:
   - default_max_depth() -> 5
   - default_max_nodes() -> 100
   - default_max_rpc_calls() -> 20
   - default_token_budget() -> 4000
   - default_timeout_ms() -> 5000
   - default_beam_width() -> 1

   Implement Default trait using all defaults.

   Add method: `pub fn with_timeout(mut self, ms: u64) -> Self`
   Add method: `pub fn for_time_boxed(timeout_ms: u64) -> Self` - creates strict conditions for time-boxed intent.

5. LayerStatus struct to track individual layer health:
   ```rust
   #[derive(Debug, Clone, Serialize, Deserialize, Default)]
   pub struct LayerStatus {
       pub enabled: bool,
       pub healthy: bool,
       pub doc_count: u64,
   }
   ```

6. Export module in lib.rs: `pub mod retrieval;` and re-export key types:
   ```rust
   pub use retrieval::{QueryIntent, CapabilityTier, ExecutionMode, StopConditions, LayerStatus};
   ```

Include unit tests for:
- QueryIntent Default is Answer
- CapabilityTier ordering (Tier1 < Tier5)
- StopConditions default values
- StopConditions::for_time_boxed() creates strict conditions
  </action>
  <verify>
```bash
cargo build -p memory-types
cargo test -p memory-types retrieval
```
  </verify>
  <done>retrieval.rs exists with QueryIntent, CapabilityTier, ExecutionMode, StopConditions, LayerStatus; all unit tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Add RetrievalConfig and update Settings</name>
  <files>crates/memory-types/src/retrieval.rs, crates/memory-types/src/config.rs</files>
  <action>
Add to `crates/memory-types/src/retrieval.rs`:

1. RetrievalConfig struct:
   ```rust
   #[derive(Debug, Clone, Serialize, Deserialize)]
   pub struct RetrievalConfig {
       /// Master switch for retrieval policy (default: true)
       #[serde(default = "default_true")]
       pub enabled: bool,

       /// Default stop conditions
       #[serde(default)]
       pub stop_conditions: StopConditions,

       /// Default execution mode
       #[serde(default)]
       pub default_mode: ExecutionMode,

       /// Enable intent classification (default: true)
       #[serde(default = "default_true")]
       pub intent_classification_enabled: bool,

       /// Enable automatic fallback on layer failure (default: true)
       #[serde(default = "default_true")]
       pub auto_fallback_enabled: bool,

       /// Enable explainability payload in responses (default: true)
       #[serde(default = "default_true")]
       pub explainability_enabled: bool,
   }
   ```

   Add helper function: `fn default_true() -> bool { true }`

   Implement Default trait with all features enabled.

2. IntentDefaults struct for per-intent configuration:
   ```rust
   #[derive(Debug, Clone, Serialize, Deserialize)]
   pub struct IntentDefaults {
       /// Stop conditions for Explore intent
       #[serde(default)]
       pub explore: StopConditions,
       /// Stop conditions for Answer intent
       #[serde(default)]
       pub answer: StopConditions,
       /// Stop conditions for Locate intent
       #[serde(default)]
       pub locate: StopConditions,
       /// Stop conditions for TimeBoxed intent (stricter defaults)
       #[serde(default = "default_time_boxed_conditions")]
       pub time_boxed: StopConditions,
   }
   ```

   Add `default_time_boxed_conditions()` returning StopConditions with:
   - timeout_ms: 2000 (stricter)
   - max_rpc_calls: 10 (stricter)
   - max_nodes_visited: 50 (stricter)

Update `crates/memory-types/src/config.rs`:

1. Add import: `use crate::retrieval::RetrievalConfig;`

2. If Settings struct exists, add field:
   ```rust
   /// Retrieval policy configuration
   #[serde(default)]
   pub retrieval: RetrievalConfig,
   ```

   Or document where to add it based on existing config structure.
  </action>
  <verify>
```bash
cargo build -p memory-types
cargo test -p memory-types retrieval
cargo test -p memory-types config
```
  </verify>
  <done>RetrievalConfig exists with all policy switches; Settings includes retrieval config section</done>
</task>

<task type="auto">
  <name>Task 3: Add retrieval policy enums to proto</name>
  <files>proto/memory.proto</files>
  <action>
Update `proto/memory.proto`:

1. Add QueryIntent enum (after existing enums, around line 115):
   ```protobuf
   // Query intent classification for retrieval routing (FR-04)
   enum QueryIntent {
       QUERY_INTENT_UNSPECIFIED = 0;
       QUERY_INTENT_EXPLORE = 1;     // Discover patterns, themes
       QUERY_INTENT_ANSWER = 2;      // Evidence-backed result (default)
       QUERY_INTENT_LOCATE = 3;      // Find exact snippet
       QUERY_INTENT_TIME_BOXED = 4;  // Return best partial in N ms
   }
   ```

2. Add CapabilityTier enum:
   ```protobuf
   // Capability tier for retrieval (FR-02)
   enum CapabilityTier {
       CAPABILITY_TIER_UNSPECIFIED = 0;
       CAPABILITY_TIER_FULL = 1;     // Topics + Hybrid + Agentic
       CAPABILITY_TIER_HYBRID = 2;   // BM25 + Vector + Agentic
       CAPABILITY_TIER_SEMANTIC = 3; // Vector + Agentic
       CAPABILITY_TIER_KEYWORD = 4;  // BM25 + Agentic
       CAPABILITY_TIER_AGENTIC = 5;  // TOC Search only (always works)
   }
   ```

3. Add ExecutionMode enum:
   ```protobuf
   // Execution mode for retrieval (FR-15)
   enum ExecutionMode {
       EXECUTION_MODE_UNSPECIFIED = 0;
       EXECUTION_MODE_SEQUENTIAL = 1;  // One layer at a time (default)
       EXECUTION_MODE_PARALLEL = 2;    // Multiple layers simultaneously
       EXECUTION_MODE_HYBRID = 3;      // Start parallel, cancel losers
   }
   ```

4. Add StopConditions message:
   ```protobuf
   // Stop conditions for retrieval bounds (FR-10)
   message StopConditions {
       // Maximum tree traversal depth (default: 5)
       uint32 max_depth = 1;
       // Maximum nodes to visit (default: 100)
       uint32 max_nodes_visited = 2;
       // Maximum RPC calls (default: 20)
       uint32 max_rpc_calls = 3;
       // Maximum token budget (default: 4000)
       uint32 max_token_budget = 4;
       // Timeout in milliseconds (default: 5000)
       uint64 timeout_ms = 5;
       // Beam width for parallel (default: 1, max: 5)
       uint32 beam_width = 6;
   }
   ```

5. Add LayerStatus message:
   ```protobuf
   // Status of an individual retrieval layer
   message LayerStatus {
       bool enabled = 1;
       bool healthy = 2;
       uint64 doc_count = 3;
   }
   ```
  </action>
  <verify>
```bash
cargo build --workspace
```
  </verify>
  <done>Proto has QueryIntent, CapabilityTier, ExecutionMode, StopConditions, LayerStatus definitions</done>
</task>

</tasks>

<verification>
After all tasks complete:

```bash
# Full workspace build
cargo build --workspace

# All memory-types tests
cargo test -p memory-types --all-features

# Clippy check
cargo clippy -p memory-types -- -D warnings

# Ensure proto compiles
cargo build -p memory-service
```
</verification>

<success_criteria>
1. retrieval.rs module exists with QueryIntent, CapabilityTier, ExecutionMode, StopConditions, LayerStatus
2. RetrievalConfig exists with all policy switches (enabled, intent_classification, auto_fallback, explainability)
3. StopConditions has configurable defaults matching PRD Section 5.5
4. Proto has all retrieval policy enums and messages
5. Default for QueryIntent is Answer (most common case)
6. Default for CapabilityTier is Tier5Agentic (safest fallback)
7. All unit tests pass
8. Clippy passes with no warnings
</success_criteria>

<output>
After completion, create `.planning/phases/17-agent-retrieval-policy/17-01-SUMMARY.md`
</output>

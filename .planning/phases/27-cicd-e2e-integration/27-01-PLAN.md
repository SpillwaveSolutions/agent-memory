---
phase: 27-cicd-e2e-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/ci.yml
autonomous: true

must_haves:
  truths:
    - "GitHub Actions CI includes a dedicated E2E test job separate from unit/integration tests"
    - "The E2E job triggers on pull requests to main branch"
    - "CI output shows E2E test count and individual pass/fail separately from other tests"
    - "The ci-success gate job requires the E2E job to pass"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "CI workflow with dedicated E2E job"
      contains: "e2e"
  key_links:
    - from: "ci-success job"
      to: "e2e job"
      via: "needs array"
      pattern: "needs:.*e2e"
---

<objective>
Add a dedicated E2E test job to the GitHub Actions CI workflow that runs the e2e-tests crate separately from unit/integration tests, providing clear per-test pass/fail reporting.

Purpose: Satisfy CI-01, CI-02, CI-03 requirements — E2E tests run automatically on every PR with separate reporting from unit/integration tests.
Output: Updated `.github/workflows/ci.yml` with dedicated `e2e` job and updated gate job.
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.github/workflows/ci.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dedicated E2E test job to CI workflow</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Edit `.github/workflows/ci.yml` to add a new `e2e` job and update the existing `test` job:

1. **Modify the existing `test` job** to exclude e2e-tests crate:
   - Change `cargo test --workspace --all-features` to `cargo test --workspace --all-features --exclude e2e-tests`
   - This prevents E2E tests from running mixed with unit/integration tests

2. **Add a new `e2e` job** after the `test` job with:
   - `name: E2E Tests`
   - `runs-on: ubuntu-24.04` (single platform, not matrix — E2E tests are platform-independent logic tests)
   - Steps:
     a. `actions/checkout@v4`
     b. Install system dependencies (protobuf-compiler, libclang-dev) — same as other Linux jobs
     c. `dtolnay/rust-toolchain@stable`
     d. `Swatinem/rust-cache@v2` with `shared-key: "e2e"`
     e. **Run E2E tests** with: `cargo test -p e2e-tests --all-features -- --show-output 2>&1 | tee e2e-results.txt`
     f. **Report E2E summary** step that runs even on failure (`if: always()`):
        ```bash
        echo "## E2E Test Results" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        grep -E "^test |^running |ok|FAILED|test result:" e2e-results.txt >> $GITHUB_STEP_SUMMARY || true
        echo '```' >> $GITHUB_STEP_SUMMARY
        ```
        This provides clear E2E-specific pass/fail in the GitHub Actions summary view.
     g. **Fail on test failure**: After the summary step, add a step that checks the test exit code. Use a pattern where the test step uses `id: e2e_run` and `continue-on-error: true`, and the final step checks `steps.e2e_run.outcome`.

   NOTE: Do NOT include `#[ignore]` vector tests (they need ~80MB model downloads). The standard `cargo test -p e2e-tests` already skips them by default since `#[ignore]` tests require `-- --ignored` flag.

3. **Update `ci-success` gate job**:
   - Add `e2e` to the `needs` array: `needs: [fmt, clippy, test, build, doc, e2e]`
   - Add E2E check to the if-condition:
     ```
     [[ "${{ needs.e2e.result }}" != "success" ]]
     ```
  </action>
  <verify>
Run `yamllint` or manual YAML syntax check on `.github/workflows/ci.yml`. Verify:
- The `e2e` job exists with name "E2E Tests"
- The `test` job has `--exclude e2e-tests`
- The `ci-success` job includes `e2e` in its `needs` array
- The workflow `on:` section still includes `pull_request: branches: [main]`
  </verify>
  <done>
The ci.yml has a dedicated `e2e` job that: (a) runs `cargo test -p e2e-tests` on ubuntu, (b) produces a step summary with per-test pass/fail, (c) is gated by ci-success. The test job excludes e2e-tests to avoid redundant execution. The workflow triggers on PRs to main.
  </done>
</task>

<task type="auto">
  <name>Task 2: Validate CI workflow and run local E2E test dry-run</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Validate the updated CI workflow:

1. **YAML syntax validation**: Parse the ci.yml to confirm it is valid YAML (use `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml'))"` or similar).

2. **Structural validation**: Verify:
   - The `e2e` job has all required fields: `name`, `runs-on`, `steps`
   - The `e2e` job's steps include checkout, system deps, Rust toolchain, cargo cache, test run, and summary
   - The `ci-success` job's `needs` array includes all 6 jobs: fmt, clippy, test, build, doc, e2e
   - The `ci-success` job's check script includes the e2e result check

3. **Local dry-run**: Run `cargo test -p e2e-tests --all-features` locally to confirm the E2E test command works and all non-ignored tests pass. Count the tests and verify the output shows individual test names.

4. **Verify exclusion**: Run `cargo test --workspace --all-features --exclude e2e-tests 2>&1 | tail -5` to confirm the test job exclusion syntax works and doesn't break other tests.
  </action>
  <verify>
- `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml'))"` exits 0
- `cargo test -p e2e-tests --all-features` passes with 27+ tests (29 total minus 2 ignored)
- `cargo test --workspace --all-features --exclude e2e-tests` passes
  </verify>
  <done>
The ci.yml is valid YAML, structurally correct, and the cargo commands for both the E2E job and the modified test job work correctly on the local machine.
  </done>
</task>

</tasks>

<verification>
1. `.github/workflows/ci.yml` contains a dedicated `e2e` job with name "E2E Tests"
2. The `e2e` job runs `cargo test -p e2e-tests --all-features`
3. The `e2e` job has a step summary that shows individual test results
4. The `test` job excludes `e2e-tests` crate with `--exclude e2e-tests`
5. The `ci-success` gate job includes `e2e` in its needs array and checks its result
6. The workflow triggers on `pull_request: branches: [main]` (CI-02)
7. `cargo test -p e2e-tests --all-features` passes locally
8. `cargo test --workspace --all-features --exclude e2e-tests` passes locally
</verification>

<success_criteria>
- CI-01: A dedicated E2E test job exists in ci.yml that runs `cargo test -p e2e-tests`
- CI-02: The workflow triggers on pull requests to main (inherited from existing `on:` block, plus verified)
- CI-03: E2E tests are reported separately — dedicated job with step summary showing test count and per-test pass/fail, distinct from the unit/integration test job
- The ci-success gate requires the E2E job, so PRs cannot merge without passing E2E tests
</success_criteria>

<output>
After completion, create `.planning/phases/27-cicd-e2e-integration/27-01-SUMMARY.md`
</output>

---
phase: 26-e2e-advanced-scenario-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/e2e-tests/src/lib.rs
  - crates/e2e-tests/tests/multi_agent_test.rs
autonomous: true

must_haves:
  truths:
    - "A test ingests events from 3 agents (claude, copilot, gemini), builds TOC segments with contributing_agents, and verifies cross-agent route_query returns results from all agents"
    - "A test ingests events from multiple agents, queries with agent_filter, and verifies only the specified agent's results are returned"
    - "Agent discovery (ListAgents) correctly reports all 3 agents with accurate session counts and ordering"
  artifacts:
    - path: "crates/e2e-tests/tests/multi_agent_test.rs"
      provides: "Multi-agent cross-query and filtered-query E2E tests"
      contains: "test_multi_agent_cross_agent_query"
    - path: "crates/e2e-tests/src/lib.rs"
      provides: "Enhanced create_test_events_for_agent helper"
      contains: "create_test_events_for_agent"
  key_links:
    - from: "crates/e2e-tests/tests/multi_agent_test.rs"
      to: "crates/memory-service/src/retrieval.rs"
      via: "RetrievalHandler::route_query with agent_filter"
      pattern: "route_query"
    - from: "crates/e2e-tests/tests/multi_agent_test.rs"
      to: "crates/memory-service/src/agents.rs"
      via: "AgentDiscoveryHandler::list_agents"
      pattern: "list_agents"
    - from: "crates/e2e-tests/tests/multi_agent_test.rs"
      to: "crates/memory-search/src/indexer.rs"
      via: "SearchIndexer::index_toc_node"
      pattern: "index_toc_node"
---

<objective>
Implement multi-agent E2E tests (E2E-05) that verify cross-agent ingestion, unfiltered cross-agent queries, and filtered single-agent queries work correctly.

Purpose: Prove the multi-agent ecosystem works end-to-end: events from different agents (claude, copilot, gemini) can be ingested, indexed, and queried both across all agents and filtered to a specific agent. This validates the Phase 18/23 agent infrastructure in a realistic multi-agent scenario.

Output: Working E2E test file with 3 tests covering cross-agent queries, filtered queries, and agent discovery.
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/25-e2e-core-pipeline-tests/25-01-SUMMARY.md

Key source files for reference:
@crates/e2e-tests/src/lib.rs  (TestHarness, create_test_events, ingest_events, build_toc_segment)
@crates/e2e-tests/tests/pipeline_test.rs  (existing pattern for route_query testing)
@crates/e2e-tests/tests/bm25_teleport_test.rs  (existing pattern for BM25 indexing + search)
@crates/memory-service/src/retrieval.rs  (RetrievalHandler::route_query, with_services)
@crates/memory-service/src/agents.rs  (AgentDiscoveryHandler::list_agents)
@crates/memory-search/src/indexer.rs  (SearchIndexer::index_toc_node, index_grip)
@crates/memory-types/src/toc.rs  (TocNode::with_contributing_agent, with_contributing_agents)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add create_test_events_for_agent helper to lib.rs</name>
  <files>
    crates/e2e-tests/src/lib.rs
  </files>
  <action>
    Add a new public helper function `create_test_events_for_agent` to crates/e2e-tests/src/lib.rs that is like `create_test_events` but accepts an explicit `agent` parameter instead of hardcoding "claude":

    ```rust
    /// Create N test events for a specific agent with sequential timestamps.
    ///
    /// Like `create_test_events` but allows specifying the agent name.
    /// Uses realistic agent names (e.g., "claude", "copilot", "gemini").
    pub fn create_test_events_for_agent(
        session_id: &str,
        count: usize,
        base_text: &str,
        agent: &str,
    ) -> Vec<Event> {
    ```

    Implementation: Same as `create_test_events` but uses `event.with_agent(agent)` instead of `event.with_agent("claude")`.

    This avoids modifying the existing `create_test_events` signature (which is used by Phase 25 tests) while enabling multi-agent test data creation.

    Ensure `cargo build -p e2e-tests` compiles.
  </action>
  <verify>
    cargo build -p e2e-tests
    cargo clippy -p e2e-tests --all-targets -- -D warnings
  </verify>
  <done>
    A new `create_test_events_for_agent` helper exists in lib.rs, compiles cleanly, and can create events attributed to any agent name.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement multi-agent E2E tests (E2E-05)</name>
  <files>
    crates/e2e-tests/tests/multi_agent_test.rs
  </files>
  <action>
    Create crates/e2e-tests/tests/multi_agent_test.rs with three test functions:

    **Test 1: test_multi_agent_cross_agent_query (E2E-05 primary)**

    Verifies unfiltered cross-agent query returns results from all agents:
    1. Create a TestHarness
    2. Create events for 3 agents using `create_test_events_for_agent`:
       - "claude": 6 events in session "session-claude" about "Rust ownership and borrow checker for memory safety"
       - "copilot": 6 events in session "session-copilot" about "TypeScript generics and type inference patterns"
       - "gemini": 6 events in session "session-gemini" about "Python machine learning with PyTorch models"
    3. Ingest all 18 events using `ingest_events`
    4. Build TOC segments for each agent's events using `build_toc_segment`
       - Each segment will have the agent in contributing_agents because the events carry that agent
    5. Create BM25 index at harness.bm25_index_path
    6. Index all 3 TocNodes via SearchIndexer::index_toc_node, plus any grips via index_grip
    7. Commit the index
    8. Create TeleportSearcher, wrap in Arc
    9. Create RetrievalHandler::with_services(storage, Some(bm25_searcher), None, None)
    10. Call route_query with query "programming languages" (a broad query that should match content from all agents), agent_filter: None, limit: 20
    11. Verify:
        - has_results is true
        - Results are non-empty
        - Explanation is present
    12. Also verify via BM25 directly (TeleportSearcher::search for "rust ownership") that results exist
    13. Use pretty_assertions for all assert_eq! calls

    **Test 2: test_multi_agent_filtered_query (E2E-05 filter)**

    Verifies agent_filter restricts results to specified agent:
    1. Same setup as Test 1 (create harness, 3 agents, ingest, build TOC, index into BM25)
    2. Create RetrievalHandler::with_services with BM25 searcher
    3. Call route_query with query "memory safety borrow" and agent_filter: Some("claude".to_string())
    4. Verify:
        - has_results is true (claude's content matches)
        - Results are non-empty
    5. Search BM25 directly for "rust ownership" using SearchOptions::new().with_limit(10)
    6. Verify the TeleportSearcher results include agent attribution:
        - Find results with agent == Some("claude") in the search results
        - The agent field is set on TeleportResults from agent-attributed TocNodes
    7. Call route_query with query "rust ownership" and agent_filter: Some("nonexistent_agent".to_string())
    8. Verify: has_results is false OR results are empty (no agent named "nonexistent_agent" has content)

    **Test 3: test_multi_agent_discovery (E2E-05 discovery)**

    Verifies ListAgents works correctly with multi-agent data:
    1. Create TestHarness
    2. Create events and TOC nodes for "claude" (2 sessions) and "copilot" (1 session):
        - claude: 4 events in "session-claude-1", 4 events in "session-claude-2"
        - copilot: 4 events in "session-copilot-1"
    3. Ingest events and store them properly with outbox entries (use the existing ingest_events helper which calls storage.put_event)
    4. Build TOC segments for each session's events
    5. Create AgentDiscoveryHandler::new(storage)
    6. Call list_agents(Request::new(ListAgentsRequest {}))
    7. Verify:
        - agents list contains "claude" and "copilot" (found via TOC node contributing_agents)
        - claude has session_count == 2 (2 distinct session_ids)
        - copilot has session_count == 1
        - Agents are sorted by last_seen_ms descending

    All tests use #[tokio::test], `use e2e_tests::*`, and pretty_assertions.
    Use realistic agent names per the discussion decisions ("claude", "copilot", "gemini").
    Do NOT use #[ignore] â€” all tests must run by default.
  </action>
  <verify>
    cargo test -p e2e-tests --test multi_agent_test -- --nocapture
    cargo clippy -p e2e-tests --all-targets -- -D warnings
  </verify>
  <done>
    Three multi-agent E2E tests pass: test_multi_agent_cross_agent_query proves cross-agent query returns results from multiple agents; test_multi_agent_filtered_query proves agent_filter restricts results to the specified agent; test_multi_agent_discovery proves ListAgents correctly reports agent summaries. All run without #[ignore] and use pretty_assertions.
  </done>
</task>

</tasks>

<verification>
1. `cargo test -p e2e-tests --test multi_agent_test` passes all 3 tests
2. `cargo clippy -p e2e-tests --all-targets -- -D warnings` clean
3. Cross-agent query with no agent_filter returns results (unfiltered)
4. Filtered query with agent_filter returns only matching agent's results
5. ListAgents reports correct agent counts and session counts
</verification>

<success_criteria>
- test_multi_agent_cross_agent_query passes (E2E-05 cross-agent)
- test_multi_agent_filtered_query passes (E2E-05 filtered)
- test_multi_agent_discovery passes (E2E-05 discovery)
- All tests run without #[ignore]
- No clippy warnings
</success_criteria>

<output>
After completion, create `.planning/phases/26-e2e-advanced-scenario-tests/26-01-SUMMARY.md`
</output>

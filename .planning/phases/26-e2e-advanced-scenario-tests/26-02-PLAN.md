---
phase: 26-e2e-advanced-scenario-tests
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/e2e-tests/tests/degradation_test.rs
autonomous: true

must_haves:
  truths:
    - "A test queries with BM25 missing and verifies the system detects Agentic tier and still returns a response without error"
    - "A test queries with vector index missing and verifies graceful degradation to BM25+Agentic"
    - "A test queries with all indexes missing (worst case) and verifies the system degrades to Agentic-only tier, still responding without panic"
    - "GetRetrievalCapabilities reports correct tier and warnings when indexes are missing"
  artifacts:
    - path: "crates/e2e-tests/tests/degradation_test.rs"
      provides: "Graceful degradation E2E tests for missing index scenarios"
      contains: "test_degradation_no_bm25_index"
  key_links:
    - from: "crates/e2e-tests/tests/degradation_test.rs"
      to: "crates/memory-service/src/retrieval.rs"
      via: "RetrievalHandler::with_services with None parameters"
      pattern: "with_services"
    - from: "crates/e2e-tests/tests/degradation_test.rs"
      to: "crates/memory-retrieval/src/types.rs"
      via: "CombinedStatus::detect_tier tier detection"
      pattern: "detect_tier"
    - from: "crates/e2e-tests/tests/degradation_test.rs"
      to: "crates/memory-retrieval/src/executor.rs"
      via: "FallbackChain execution with missing layers"
      pattern: "FallbackChain"
---

<objective>
Implement graceful degradation E2E tests (E2E-06) that verify the system handles missing indexes correctly: BM25 missing, vector missing, topic graph missing, and all missing together.

Purpose: Prove the retrieval pipeline degrades gracefully when indexes are unavailable. The system must never panic, must detect the correct capability tier, must attempt appropriate fallback layers, and must report useful warnings. This validates the fallback chain and tier detection from Phase 17.

Output: Working E2E test file with tests covering each missing-index scenario individually and the worst-case all-missing scenario.
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/25-e2e-core-pipeline-tests/25-01-SUMMARY.md

Key source files for reference:
@crates/e2e-tests/src/lib.rs  (TestHarness, helpers)
@crates/memory-service/src/retrieval.rs  (RetrievalHandler::with_services, get_retrieval_capabilities, route_query)
@crates/memory-retrieval/src/types.rs  (CapabilityTier, CombinedStatus::detect_tier)
@crates/memory-retrieval/src/executor.rs  (FallbackChain::for_intent, RetrievalExecutor)
@crates/memory-service/src/ingest.rs  (MemoryServiceImpl::new — creates handler with no indexes)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement graceful degradation E2E tests (E2E-06)</name>
  <files>
    crates/e2e-tests/tests/degradation_test.rs
  </files>
  <action>
    Create crates/e2e-tests/tests/degradation_test.rs with the following tests:

    **Test 1: test_degradation_all_indexes_missing (worst case)**

    Verifies the system works in Agentic-only mode when no indexes are configured:
    1. Create a TestHarness
    2. Create and ingest 6 events using create_test_events and ingest_events
    3. Build a TOC segment using build_toc_segment (so there IS data in storage, just no search indexes)
    4. Create RetrievalHandler::with_services(storage, None, None, None) — no BM25, no vector, no topics
    5. Call get_retrieval_capabilities(Request::new(GetRetrievalCapabilitiesRequest {}))
    6. Verify:
        - tier is Agentic (value 5 / ProtoTier::Agentic as i32)
        - bm25_status.enabled == false
        - vector_status.enabled == false
        - topics_status.enabled == false
        - agentic_status.healthy == true (always available)
        - warnings is non-empty (should warn about missing indexes)
    7. Call route_query with query "what were we discussing?", agent_filter: None
    8. Verify:
        - The call succeeds (no panic, no error)
        - explanation is present
        - explanation.tier is Agentic tier
        - layers_attempted is non-empty (should have attempted Agentic at minimum)
        - has_results may be false (Agentic layer currently returns empty), but the call must not fail
    9. Use pretty_assertions for structural comparisons

    **Test 2: test_degradation_no_bm25_index**

    Verifies the system degrades when only BM25 is missing:
    1. Create a TestHarness
    2. Create and ingest events, build TOC segment
    3. Create RetrievalHandler::with_services(storage, None, None, None) — BM25 not configured
       (For this test, we omit all search indexes to isolate the BM25-missing path. The key assertion is that route_query does not fail.)
    4. Call get_retrieval_capabilities
    5. Verify bm25_status.enabled == false
    6. Verify the detected tier is Agentic (since nothing else is configured either)
    7. Call route_query with query "find the error message about auth"
    8. Verify: call succeeds, explanation.tier reflects the degraded tier
    9. Verify explanation.fallback_occurred or explanation.candidates_considered shows the system tried available layers

    **Test 3: test_degradation_bm25_present_vector_missing**

    Verifies the system uses BM25 when vector is missing (Keyword tier):
    1. Create a TestHarness
    2. Create and ingest events, build TOC segment
    3. Build a BM25 index and index the TOC node (same pattern as pipeline_test.rs):
        - SearchIndexConfig::new, SearchIndex::open_or_create, SearchIndexer::new
        - indexer.index_toc_node, indexer.commit
        - TeleportSearcher::new, wrap in Arc
    4. Create RetrievalHandler::with_services(storage, Some(bm25_searcher), None, None) — BM25 present, vector and topics absent
    5. Call get_retrieval_capabilities
    6. Verify:
        - tier is Keyword (ProtoTier::Keyword)
        - bm25_status.enabled == true, bm25_status.healthy == true
        - vector_status.enabled == false
        - topics_status.enabled == false
    7. Call route_query with query matching the ingested content (use terms from the test events)
    8. Verify:
        - has_results is true (BM25 found results)
        - explanation.tier is Keyword
        - Results are non-empty and have valid doc_ids
        - The system did NOT panic despite missing vector/topics

    **Test 4: test_degradation_capabilities_warnings_contain_context**

    Verifies that capability warnings contain useful context about what is missing:
    1. Create RetrievalHandler::with_services(storage, None, None, None)
    2. Call get_retrieval_capabilities
    3. Verify warnings list:
        - warnings is non-empty
        - At least one warning contains "BM25" (case-insensitive check)
        - At least one warning contains "Vector" (case-insensitive check)
        - At least one warning contains "Topic" (case-insensitive check)
    4. This validates E2E-06's requirement that error/degradation messages provide useful context

    All tests use #[tokio::test], `use e2e_tests::*`, pretty_assertions, and tonic::Request.
    Do NOT use #[ignore] — all tests must run by default.
    Import necessary types: memory_service::pb::{RouteQueryRequest, GetRetrievalCapabilitiesRequest, CapabilityTier as ProtoTier}, memory_service::RetrievalHandler, memory_search::{SearchIndex, SearchIndexConfig, SearchIndexer, TeleportSearcher}.
  </action>
  <verify>
    cargo test -p e2e-tests --test degradation_test -- --nocapture
    cargo clippy -p e2e-tests --all-targets -- -D warnings
  </verify>
  <done>
    Four graceful degradation E2E tests pass: test_degradation_all_indexes_missing proves worst-case Agentic-only mode works; test_degradation_no_bm25_index proves the system handles missing BM25; test_degradation_bm25_present_vector_missing proves Keyword tier works correctly when vector is absent; test_degradation_capabilities_warnings_contain_context proves warning messages mention which indexes are missing. All run without #[ignore].
  </done>
</task>

</tasks>

<verification>
1. `cargo test -p e2e-tests --test degradation_test` passes all 4 tests
2. `cargo clippy -p e2e-tests --all-targets -- -D warnings` clean
3. All-indexes-missing scenario returns Agentic tier without panic
4. BM25-missing scenario degrades gracefully
5. BM25-present/vector-missing scenario reports Keyword tier and returns results
6. Warning messages contain useful context about missing indexes
</verification>

<success_criteria>
- test_degradation_all_indexes_missing passes (E2E-06 worst case)
- test_degradation_no_bm25_index passes (E2E-06 individual missing)
- test_degradation_bm25_present_vector_missing passes (E2E-06 partial availability)
- test_degradation_capabilities_warnings_contain_context passes (E2E-06 warning quality)
- All tests run without #[ignore]
- No clippy warnings
</success_criteria>

<output>
After completion, create `.planning/phases/26-e2e-advanced-scenario-tests/26-02-SUMMARY.md`
</output>

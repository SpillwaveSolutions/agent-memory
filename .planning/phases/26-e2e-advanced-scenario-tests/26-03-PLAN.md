---
phase: 26-e2e-advanced-scenario-tests
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/e2e-tests/tests/error_path_test.rs
autonomous: true

must_haves:
  truths:
    - "A test sends an IngestEventRequest with missing event_id and verifies InvalidArgument error with message mentioning 'event_id'"
    - "A test sends an IngestEventRequest with missing session_id and verifies InvalidArgument error with message mentioning 'session_id'"
    - "A test sends a RouteQuery with empty query and verifies InvalidArgument error"
    - "A test sends a ClassifyQueryIntent with empty query and verifies InvalidArgument error"
    - "A test sends a GetNode request with empty node_id and verifies InvalidArgument error"
    - "A test sends an ExpandGrip request for a nonexistent grip_id and verifies graceful empty response (no panic)"
    - "No test causes a panic — all error paths return structured gRPC Status errors"
  artifacts:
    - path: "crates/e2e-tests/tests/error_path_test.rs"
      provides: "Error path E2E tests for malformed inputs and invalid queries"
      contains: "test_ingest_missing_event_id"
  key_links:
    - from: "crates/e2e-tests/tests/error_path_test.rs"
      to: "crates/memory-service/src/ingest.rs"
      via: "MemoryServiceImpl::ingest_event validation"
      pattern: "ingest_event"
    - from: "crates/e2e-tests/tests/error_path_test.rs"
      to: "crates/memory-service/src/retrieval.rs"
      via: "RetrievalHandler::route_query and classify_query_intent empty query validation"
      pattern: "route_query"
    - from: "crates/e2e-tests/tests/error_path_test.rs"
      to: "crates/memory-service/src/query.rs"
      via: "get_node and expand_grip validation"
      pattern: "get_node"
---

<objective>
Implement error path E2E tests (E2E-08) that verify malformed events and invalid queries are handled gracefully with useful error messages.

Purpose: Prove the system never panics on bad input and returns structured gRPC errors with field-level context. This validates that every validation check in the service layer produces a useful error message mentioning the problematic field/value, enabling better debugging for API consumers.

Output: Working E2E test file covering malformed ingest events, invalid queries, empty required fields, and nonexistent resource lookups.
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md

Key source files for reference:
@crates/e2e-tests/src/lib.rs  (TestHarness)
@crates/memory-service/src/ingest.rs  (MemoryServiceImpl, IngestEvent validation: missing event, empty event_id, empty session_id, invalid timestamp)
@crates/memory-service/src/retrieval.rs  (RetrievalHandler: route_query empty query, classify_query_intent empty query)
@crates/memory-service/src/query.rs  (get_node empty node_id, expand_grip empty grip_id, expand_grip nonexistent grip)
@crates/memory-service/src/agents.rs  (GetAgentActivity invalid bucket)
@crates/memory-service/src/lib.rs  (re-exports for MemoryServiceImpl)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement error path E2E tests for malformed ingest events (E2E-08 ingest)</name>
  <files>
    crates/e2e-tests/tests/error_path_test.rs
  </files>
  <action>
    Create crates/e2e-tests/tests/error_path_test.rs with tests covering malformed ingest requests.

    Use the MemoryServiceImpl directly (not via gRPC server) to test validation, following the pattern from the existing unit tests in ingest.rs but at the E2E level (using the full service, not just one function).

    Import:
    ```rust
    use std::collections::HashMap;
    use std::sync::Arc;
    use pretty_assertions::assert_eq;
    use tonic::Request;
    use e2e_tests::TestHarness;
    use memory_service::MemoryServiceImpl;
    use memory_service::RetrievalHandler;
    use memory_service::pb::{
        memory_service_server::MemoryService,
        IngestEventRequest, Event as ProtoEvent,
        EventType as ProtoEventType, EventRole as ProtoEventRole,
        RouteQueryRequest, ClassifyQueryIntentRequest,
        GetNodeRequest, ExpandGripRequest,
        GetAgentActivityRequest, BrowseTocRequest,
    };
    ```

    **Test 1: test_ingest_missing_event (E2E-08)**

    1. Create TestHarness, create MemoryServiceImpl::new(storage)
    2. Call ingest_event with IngestEventRequest { event: None }
    3. Verify: Result is Err with code InvalidArgument
    4. Verify: Error message contains "Event" (field-level context)

    **Test 2: test_ingest_missing_event_id (E2E-08)**

    1. Create MemoryServiceImpl
    2. Call ingest_event with a ProtoEvent that has event_id = "" (empty string)
    3. Verify: Result is Err with code InvalidArgument
    4. Verify: Error message contains "event_id" (mentions the problematic field)

    **Test 3: test_ingest_missing_session_id (E2E-08)**

    1. Create MemoryServiceImpl
    2. Call ingest_event with a ProtoEvent that has session_id = "" (empty string), valid event_id
    3. Verify: Result is Err with code InvalidArgument
    4. Verify: Error message contains "session_id"

    **Test 4: test_ingest_invalid_timestamp (E2E-08)**

    1. Create MemoryServiceImpl
    2. Call ingest_event with a ProtoEvent that has timestamp_ms = -999999999999999 (extremely negative, invalid)
    3. Verify: Result is Err with code InvalidArgument
    4. Verify: Error message contains "timestamp" (mentions the problematic field)

    **Test 5: test_ingest_valid_event_succeeds (positive control)**

    1. Create MemoryServiceImpl
    2. Call ingest_event with a fully valid ProtoEvent (valid event_id, session_id, timestamp, text)
    3. Verify: Result is Ok, response.created == true
    4. This proves the validation is not overly aggressive

    All tests should use `use memory_service::pb::memory_service_server::MemoryService;` to access the trait methods on MemoryServiceImpl. The trait must be in scope for .ingest_event() etc to resolve.

    Do NOT use #[ignore]. All tests must run by default.
  </action>
  <verify>
    cargo test -p e2e-tests --test error_path_test -- test_ingest --nocapture
    cargo clippy -p e2e-tests --all-targets -- -D warnings
  </verify>
  <done>
    Five ingest error path tests pass: missing event, empty event_id, empty session_id, and invalid timestamp all return InvalidArgument with field-level error messages; valid event succeeds as positive control.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement error path E2E tests for invalid queries and lookups (E2E-08 query)</name>
  <files>
    crates/e2e-tests/tests/error_path_test.rs
  </files>
  <action>
    Add additional test functions to crates/e2e-tests/tests/error_path_test.rs covering query/lookup error paths:

    **Test 6: test_route_query_empty_query (E2E-08)**

    1. Create TestHarness, create RetrievalHandler::with_services(storage, None, None, None)
    2. Call route_query with RouteQueryRequest { query: "".to_string(), ..defaults }
    3. Verify: Result is Err with code InvalidArgument
    4. Verify: Error message contains "Query" or "query" (field context)

    **Test 7: test_classify_intent_empty_query (E2E-08)**

    1. Create RetrievalHandler
    2. Call classify_query_intent with ClassifyQueryIntentRequest { query: "".to_string(), timeout_ms: None }
    3. Verify: Result is Err with code InvalidArgument

    **Test 8: test_get_node_empty_id (E2E-08)**

    1. Create MemoryServiceImpl::new(storage)
    2. Call get_node with GetNodeRequest { node_id: "".to_string() }
    3. Verify: Result is Err with code InvalidArgument
    4. Verify: Error message contains "node_id"

    **Test 9: test_expand_grip_empty_id (E2E-08)**

    1. Create MemoryServiceImpl
    2. Call expand_grip with ExpandGripRequest { grip_id: "".to_string(), events_before: None, events_after: None }
    3. Verify: Result is Err with code InvalidArgument
    4. Verify: Error message contains "grip_id"

    **Test 10: test_expand_grip_nonexistent_graceful (E2E-08)**

    1. Create MemoryServiceImpl
    2. Call expand_grip with ExpandGripRequest { grip_id: "nonexistent-grip-12345".to_string(), events_before: None, events_after: None }
    3. Verify: Result is Ok (NOT an error — the system gracefully returns empty)
    4. Verify: response.grip is None (grip not found, but no panic)
    5. Verify: excerpt_events, events_before, events_after are all empty

    **Test 11: test_browse_toc_empty_parent_id (E2E-08)**

    1. Create MemoryServiceImpl
    2. Call browse_toc with BrowseTocRequest { parent_id: "".to_string(), limit: 10, continuation_token: None }
    3. Verify: Result is Err with code InvalidArgument
    4. Verify: Error message contains "parent_id"

    **Test 12: test_get_agent_activity_invalid_bucket (E2E-08)**

    1. Create MemoryServiceImpl
    2. Call get_agent_activity with GetAgentActivityRequest { agent_id: None, from_ms: None, to_ms: None, bucket: "invalid_bucket".to_string() }
    3. Verify: Result is Err with code InvalidArgument
    4. Verify: Error message contains "bucket" (mentions the invalid field)

    All tests should use #[tokio::test] and pretty_assertions.
    Do NOT use #[ignore].
    Verify ALL error messages mention the problematic field/value for debugging — this is a specific requirement from the phase discussion.
  </action>
  <verify>
    cargo test -p e2e-tests --test error_path_test -- --nocapture
    cargo clippy -p e2e-tests --all-targets -- -D warnings
  </verify>
  <done>
    Twelve error path E2E tests pass covering ingest validation (missing event, empty event_id, empty session_id, invalid timestamp), query validation (empty query for route_query and classify_intent), lookup validation (empty node_id, empty grip_id, nonexistent grip graceful), navigation validation (empty parent_id), and agent activity validation (invalid bucket). All error messages mention the problematic field. No test causes a panic.
  </done>
</task>

</tasks>

<verification>
1. `cargo test -p e2e-tests --test error_path_test` passes all 12 tests
2. `cargo clippy -p e2e-tests --all-targets -- -D warnings` clean
3. Every error response has code InvalidArgument (not Internal or Unavailable)
4. Every error message mentions the problematic field name
5. Nonexistent grip returns graceful empty response (not error)
6. Valid ingest succeeds (positive control)
7. No test causes a panic
</verification>

<success_criteria>
- All 12 error path tests pass (E2E-08)
- Error messages contain field-level context (event_id, session_id, query, node_id, grip_id, parent_id, bucket)
- Nonexistent resources handled gracefully (empty response, not panic)
- All tests run without #[ignore]
- No clippy warnings
</success_criteria>

<output>
After completion, create `.planning/phases/26-e2e-advanced-scenario-tests/26-03-SUMMARY.md`
</output>

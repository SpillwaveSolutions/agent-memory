---
phase: 25-e2e-core-pipeline-tests
plan: 02
type: execute
wave: 2
depends_on: ["25-01"]
files_modified:
  - crates/e2e-tests/tests/bm25_teleport_test.rs
autonomous: true

must_haves:
  truths:
    - "A test ingests events, builds BM25 index, and verifies bm25_search returns matching events ranked by relevance"
    - "BM25 results for a specific query score higher than results for an unrelated query"
  artifacts:
    - path: "crates/e2e-tests/tests/bm25_teleport_test.rs"
      provides: "BM25 teleport E2E test with relevance ranking verification"
      contains: "test_bm25_ingest_index_search_ranked"
  key_links:
    - from: "crates/e2e-tests/tests/bm25_teleport_test.rs"
      to: "crates/memory-search/src/indexer.rs"
      via: "SearchIndexer::index_toc_node and index_grip"
      pattern: "index_toc_node"
    - from: "crates/e2e-tests/tests/bm25_teleport_test.rs"
      to: "crates/memory-search/src/searcher.rs"
      via: "TeleportSearcher::search"
      pattern: "searcher.search"
---

<objective>
Implement the BM25 teleport E2E test (E2E-02) that verifies the full ingest-to-BM25-search pipeline including relevance ranking.

Purpose: Prove that BM25 keyword search works end-to-end: events are ingested, TOC nodes and grips are built and indexed into Tantivy, and bm25_search returns matching results ranked by relevance score.

Output: Working E2E test covering Success Criterion #2.
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/25-e2e-core-pipeline-tests/25-01-SUMMARY.md

Key source files for reference:
@crates/memory-search/src/indexer.rs  (SearchIndexer)
@crates/memory-search/src/searcher.rs  (TeleportSearcher::search)
@crates/memory-search/src/index.rs  (SearchIndex::open_or_create)
@crates/memory-service/src/teleport_service.rs  (handle_teleport_search, test helpers)
@crates/e2e-tests/src/lib.rs  (TestHarness, helpers from Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement BM25 teleport E2E test with relevance ranking (E2E-02)</name>
  <files>
    crates/e2e-tests/tests/bm25_teleport_test.rs
  </files>
  <action>
    Create crates/e2e-tests/tests/bm25_teleport_test.rs with the following tests:

    **Test 1: test_bm25_ingest_index_search_ranked (E2E-02 primary)**

    This test verifies the complete BM25 search pipeline with ranking:
    1. Create a TestHarness
    2. Create 3 distinct conversation segments (each 5+ events) about different topics:
       - Segment A: "Rust ownership and borrow checker" (events about Rust memory model)
       - Segment B: "Python web frameworks" (events about Django, Flask)
       - Segment C: "Database query optimization" (events about SQL indexing)
    3. Ingest all events using ingest_events helper
    4. Build TOC segments for each group using build_toc_segment helper — creates TocNodes with grips
    5. Create BM25 index: SearchIndexConfig::new(harness.bm25_index_path()), SearchIndex::open_or_create
    6. Index all 3 TocNodes via SearchIndexer::index_toc_node (plus any grips via index_grip)
    7. Commit the index
    8. Create TeleportSearcher::new(&index)
    9. Search for "rust ownership borrow" with SearchOptions::new().with_limit(10)
    10. Verify:
        - Results are non-empty
        - First result is from Segment A (the Rust topic) — check doc_id matches segment A's node_id
        - Results are in descending score order (r[i].score >= r[i+1].score)
        - No result from Segment B (Python) should rank higher than Segment A results
    11. Search for "python flask django" and verify Segment B ranks first
    12. Search for "nonexistent_gibberish_term_xyz" and verify 0 results
    13. Use pretty_assertions for all structural comparisons

    **Test 2: test_bm25_search_filters_by_doc_type**

    Verify doc type filtering works in BM25 search:
    1. Create a TestHarness, ingest events, build TOC segment (creates nodes + grips)
    2. Index both nodes and grips into BM25
    3. Search with SearchOptions::new().with_doc_type(DocType::TocNode) — verify only TocNode results
    4. Search with SearchOptions::new().with_doc_type(DocType::Grip) — verify only Grip results
    5. Search with no filter — verify both types present

    **Test 3: test_bm25_search_with_agent_attribution**

    Verify agent field propagation in BM25 results (Phase 24 feature):
    1. Create events with agent = "claude" and build a TOC node with contributing_agents = ["claude"]
    2. Index the node into BM25
    3. Search and verify result has agent field set to Some("claude")
    4. Create a node without contributing_agents, search, verify agent is None
  </action>
  <verify>
    cargo test -p e2e-tests --test bm25_teleport_test -- --nocapture
    cargo clippy -p e2e-tests --all-targets -- -D warnings
  </verify>
  <done>
    Three BM25 E2E tests pass: test_bm25_ingest_index_search_ranked proves BM25 search returns results ranked by relevance with the correct topic scoring highest; test_bm25_search_filters_by_doc_type proves doc type filtering works; test_bm25_search_with_agent_attribution proves agent fields propagate through search. All use pretty_assertions.
  </done>
</task>

</tasks>

<verification>
1. `cargo test -p e2e-tests --test bm25_teleport_test` passes all 3 tests
2. `cargo clippy -p e2e-tests --all-targets -- -D warnings` clean
3. BM25 relevance ranking test verifies: higher-relevance results rank first
4. Doc type filter test verifies: TocNode-only and Grip-only filters work
5. Agent attribution test verifies: agent field propagates through BM25 results
</verification>

<success_criteria>
- test_bm25_ingest_index_search_ranked passes (Success Criterion #2)
- BM25 returns higher-relevance results first (ordering verified)
- Agent field present on results from agent-attributed TOC nodes
- No clippy warnings
</success_criteria>

<output>
After completion, create `.planning/phases/25-e2e-core-pipeline-tests/25-02-SUMMARY.md`
</output>

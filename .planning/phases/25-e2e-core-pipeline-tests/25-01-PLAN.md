---
phase: 25-e2e-core-pipeline-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/e2e-tests/Cargo.toml
  - crates/e2e-tests/src/lib.rs
  - crates/e2e-tests/tests/pipeline_test.rs
  - Cargo.toml
autonomous: true

must_haves:
  truths:
    - "A test ingests events, triggers TOC segment build with grips, and verifies route_query returns results with correct provenance"
    - "A test ingests events with grips, calls expand_grip, and verifies source events with surrounding context are returned"
    - "The e2e-tests crate exists and compiles as part of the workspace"
  artifacts:
    - path: "crates/e2e-tests/Cargo.toml"
      provides: "E2E test crate definition with workspace dependencies"
      contains: "[package]"
    - path: "crates/e2e-tests/src/lib.rs"
      provides: "Shared test harness and helper functions"
      contains: "TestHarness"
    - path: "crates/e2e-tests/tests/pipeline_test.rs"
      provides: "Full pipeline E2E test and grip provenance E2E test"
      contains: "test_full_pipeline_ingest_toc_grip_route_query"
  key_links:
    - from: "crates/e2e-tests/tests/pipeline_test.rs"
      to: "crates/memory-toc/src/builder.rs"
      via: "TocBuilder::process_segment"
      pattern: "process_segment"
    - from: "crates/e2e-tests/tests/pipeline_test.rs"
      to: "crates/memory-toc/src/expand.rs"
      via: "GripExpander::expand"
      pattern: "expand"
    - from: "crates/e2e-tests/src/lib.rs"
      to: "crates/memory-service/src/server.rs"
      via: "run_server_with_shutdown"
      pattern: "run_server_with_shutdown"
---

<objective>
Create the e2e-tests crate with shared test harness and implement the two most complex E2E tests: the full ingest-to-query pipeline test (E2E-01) and the grip provenance test (E2E-07).

Purpose: Establish the e2e-tests crate infrastructure that all subsequent plans depend on, and prove the core pipeline works end-to-end from event ingestion through TOC segment building, grip creation, and route_query resolution — plus grip expansion with context retrieval.

Output: Working e2e-tests crate with 2 passing E2E tests covering Success Criteria #1 and #5.
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Key source files for reference:
@crates/memory-daemon/tests/integration_test.rs  (existing TestHarness pattern)
@crates/memory-toc/src/builder.rs  (TocBuilder::process_segment)
@crates/memory-toc/src/segmenter.rs  (segment_events, SegmentationConfig)
@crates/memory-toc/src/summarizer/mock.rs  (MockSummarizer)
@crates/memory-toc/src/expand.rs  (GripExpander)
@crates/memory-service/src/retrieval.rs  (RetrievalHandler::route_query)
@crates/memory-service/src/server.rs  (run_server_with_shutdown)
@crates/memory-client/src/client.rs  (MemoryClient API)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create e2e-tests crate with shared TestHarness</name>
  <files>
    Cargo.toml (workspace root)
    crates/e2e-tests/Cargo.toml
    crates/e2e-tests/src/lib.rs
  </files>
  <action>
    1. Add "crates/e2e-tests" to the workspace members list in the root Cargo.toml.

    2. Create crates/e2e-tests/Cargo.toml with:
       - [package] name = "e2e-tests", edition and version from workspace
       - [dependencies]: memory-types, memory-storage, memory-service, memory-client, memory-toc, memory-search, memory-indexing, memory-vector, memory-embeddings, memory-topics, memory-retrieval (all workspace = true or path refs)
       - Also add: tokio (workspace), chrono (workspace), ulid (workspace), serde_json (workspace), async-trait (workspace)
       - [dev-dependencies]: tempfile (workspace), pretty_assertions = "1", rand (workspace)

    3. Create crates/e2e-tests/src/lib.rs with a shared TestHarness struct modeled on crates/memory-daemon/tests/integration_test.rs but enhanced:
       - TestHarness fields: _temp_dir (TempDir), storage (Arc&lt;Storage>), bm25_index_path (PathBuf), vector_index_path (PathBuf), topic_storage (Arc&lt;TopicStorage>)
       - TestHarness::new() creates temp dir, opens Storage, sets up subdirs for bm25/vector indexes
       - Helper: ingest_events(storage, events) — writes events to storage with outbox entries (storage.put_event)
       - Helper: create_test_events(session_id, count, base_text) -> Vec&lt;Event> — creates N events with ULID-based IDs, sequential timestamps 100ms apart, using create_test_event pattern from existing tests
       - Helper: build_toc_segment(storage, events) -> TocNode — uses SegmentationConfig, segment_events(), MockSummarizer, TocBuilder::process_segment to build a segment node with grips
       - All helpers are pub for reuse by later plans

    Ensure `cargo build -p e2e-tests` compiles with no errors.
  </action>
  <verify>
    cargo build -p e2e-tests
    cargo clippy -p e2e-tests --all-targets -- -D warnings
  </verify>
  <done>
    The e2e-tests crate compiles, is part of the workspace, and exports TestHarness with helper functions for event creation, ingestion, and TOC building.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement full pipeline E2E test (E2E-01) and grip provenance E2E test (E2E-07)</name>
  <files>
    crates/e2e-tests/tests/pipeline_test.rs
  </files>
  <action>
    Create crates/e2e-tests/tests/pipeline_test.rs with two test functions:

    **Test 1: test_full_pipeline_ingest_toc_grip_route_query (E2E-01)**

    This test verifies the complete ingest-to-query pipeline:
    1. Create a TestHarness
    2. Create 10+ events with realistic content about "Rust memory safety and borrow checker" using create_test_events helper — mix UserMessage and AssistantMessage types with agent = "claude"
    3. Ingest events into storage via ingest_events helper
    4. Build TOC segment using build_toc_segment helper — this triggers MockSummarizer + grip extraction
    5. Verify the TocNode was created: check node has non-empty title, bullets, keywords
    6. Verify grips were created: check storage.get_grip for grip IDs found in node.bullets[*].grip_ids
    7. Verify parent TOC nodes exist up to Year level
    8. Build a BM25 index from the TOC node and grips using SearchIndexConfig, SearchIndex::open_or_create, SearchIndexer::index_toc_node, SearchIndexer::index_grip, commit
    9. Create a TeleportSearcher from the BM25 index
    10. Create a RetrievalHandler::with_services(storage, Some(bm25_searcher), None, None)
    11. Call route_query with query "memory safety borrow checker" and verify:
        - Response has_results is true
        - Results are non-empty
        - Explanation is present with tier and intent fields
    12. Use pretty_assertions for all assert_eq! calls
    13. Assert structural + content: verify result doc_ids exist in storage, verify text_preview is non-empty

    **Test 2: test_grip_provenance_expand_with_context (E2E-07)**

    This test verifies grip expansion with surrounding context:
    1. Create a TestHarness
    2. Create 8 events with sequential timestamps (100ms apart) — events represent a conversation about "debugging auth tokens"
    3. Ingest events
    4. Build TOC segment (which extracts grips)
    5. Get grip IDs from the segment node's bullets
    6. For each grip found, call GripExpander::new(storage).expand(grip_id)
    7. Verify ExpandedGrip:
       - grip field matches the stored grip (same grip_id, excerpt)
       - excerpt_events is non-empty (contains the events the grip references)
       - events_before or events_after have context events (surrounding the excerpt)
       - all_events().len() >= excerpt_events.len() (total includes context)
    8. Verify provenance chain: the grip's event_id_start and event_id_end correspond to actual events in excerpt_events (compare event_id)
    9. Use pretty_assertions for diff output

    Both tests should use #[tokio::test] and be in a single test file. Use `use e2e_tests::*;` for harness access.
  </action>
  <verify>
    cargo test -p e2e-tests --test pipeline_test -- --nocapture
    cargo clippy -p e2e-tests --all-targets -- -D warnings
  </verify>
  <done>
    Two E2E tests pass: test_full_pipeline_ingest_toc_grip_route_query proves the complete ingest-to-query pipeline works, and test_grip_provenance_expand_with_context proves grip expansion returns source events with surrounding context. Both use structural + content assertions with pretty_assertions.
  </done>
</task>

</tasks>

<verification>
1. `cargo build -p e2e-tests` succeeds
2. `cargo test -p e2e-tests` passes all tests
3. `cargo clippy -p e2e-tests --all-targets -- -D warnings` clean
4. Full pipeline test verifies: ingest -> segment build -> grip creation -> route_query returns results
5. Grip provenance test verifies: grip expand returns excerpt events + context events
</verification>

<success_criteria>
- The e2e-tests crate compiles and is part of the workspace
- test_full_pipeline_ingest_toc_grip_route_query passes (Success Criterion #1)
- test_grip_provenance_expand_with_context passes (Success Criterion #5)
- All assertions use pretty_assertions for clear diff output
- No clippy warnings
</success_criteria>

<output>
After completion, create `.planning/phases/25-e2e-core-pipeline-tests/25-01-SUMMARY.md`
</output>

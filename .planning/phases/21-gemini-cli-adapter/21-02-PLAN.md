---
phase: 21-gemini-cli-adapter
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - plugins/memory-gemini-adapter/.gemini/commands/memory-search.toml
  - plugins/memory-gemini-adapter/.gemini/commands/memory-recent.toml
  - plugins/memory-gemini-adapter/.gemini/commands/memory-context.toml
  - plugins/memory-gemini-adapter/.gemini/skills/memory-query/SKILL.md
  - plugins/memory-gemini-adapter/.gemini/skills/memory-query/references/command-reference.md
  - plugins/memory-gemini-adapter/.gemini/skills/retrieval-policy/SKILL.md
  - plugins/memory-gemini-adapter/.gemini/skills/retrieval-policy/references/command-reference.md
  - plugins/memory-gemini-adapter/.gemini/skills/topic-graph/SKILL.md
  - plugins/memory-gemini-adapter/.gemini/skills/topic-graph/references/command-reference.md
  - plugins/memory-gemini-adapter/.gemini/skills/bm25-search/SKILL.md
  - plugins/memory-gemini-adapter/.gemini/skills/bm25-search/references/command-reference.md
  - plugins/memory-gemini-adapter/.gemini/skills/vector-search/SKILL.md
  - plugins/memory-gemini-adapter/.gemini/skills/vector-search/references/command-reference.md
autonomous: true

must_haves:
  truths:
    - "User can invoke /memory-search, /memory-recent, /memory-context as Gemini slash commands"
    - "TOML commands contain complete instructions for Gemini to execute memory queries"
    - "Skills provide tier-aware retrieval with fallback chains identical to Claude Code and OpenCode"
    - "Navigator agent logic is embedded in memory-query skill (no separate agent file)"
    - "Skills are separate copies (not symlinks) for portability"
  artifacts:
    - path: "plugins/memory-gemini-adapter/.gemini/commands/memory-search.toml"
      provides: "Search command with topic/keyword and time period filtering"
      contains: "prompt"
    - path: "plugins/memory-gemini-adapter/.gemini/commands/memory-recent.toml"
      provides: "Recent conversations command with days/limit parameters"
      contains: "prompt"
    - path: "plugins/memory-gemini-adapter/.gemini/commands/memory-context.toml"
      provides: "Grip expansion command for full conversation context"
      contains: "prompt"
    - path: "plugins/memory-gemini-adapter/.gemini/skills/memory-query/SKILL.md"
      provides: "Core query skill with embedded navigator logic"
      min_lines: 100
    - path: "plugins/memory-gemini-adapter/.gemini/skills/retrieval-policy/SKILL.md"
      provides: "Tier detection and intent classification skill"
      min_lines: 30
    - path: "plugins/memory-gemini-adapter/.gemini/skills/bm25-search/SKILL.md"
      provides: "BM25 keyword search skill"
      min_lines: 20
    - path: "plugins/memory-gemini-adapter/.gemini/skills/vector-search/SKILL.md"
      provides: "Vector semantic search skill"
      min_lines: 20
    - path: "plugins/memory-gemini-adapter/.gemini/skills/topic-graph/SKILL.md"
      provides: "Topic graph exploration skill"
      min_lines: 20
  key_links:
    - from: "plugins/memory-gemini-adapter/.gemini/commands/memory-search.toml"
      to: "memory-daemon retrieval route"
      via: "CLI commands in prompt text"
      pattern: "memory-daemon.*retrieval.*route"
    - from: "plugins/memory-gemini-adapter/.gemini/skills/memory-query/SKILL.md"
      to: "memory-daemon query"
      via: "CLI commands in skill instructions"
      pattern: "memory-daemon.*query"
---

<objective>
Create TOML command wrappers and skill files for the Gemini CLI adapter. Commands provide `/memory-search`, `/memory-recent`, `/memory-context` slash commands. Skills are separate copies of the existing SKILL.md files from the OpenCode plugin, with the memory-query skill enhanced to embed navigator agent logic (since Gemini has no separate agent definition format).

Purpose: Enable Gemini CLI users to query past conversations with the same capabilities as Claude Code and OpenCode users -- tier-aware retrieval, intent classification, and fallback chains.

Output: 3 TOML command files + 5 skill directories with SKILL.md and references.
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-gemini-cli-adapter/21-RESEARCH.md
@plugins/memory-opencode-plugin/.opencode/skill/memory-query/SKILL.md
@plugins/memory-opencode-plugin/.opencode/skill/retrieval-policy/SKILL.md
@plugins/memory-opencode-plugin/.opencode/skill/topic-graph/SKILL.md
@plugins/memory-opencode-plugin/.opencode/skill/bm25-search/SKILL.md
@plugins/memory-opencode-plugin/.opencode/skill/vector-search/SKILL.md
@plugins/memory-opencode-plugin/.opencode/skill/memory-query/references/command-reference.md
@plugins/memory-opencode-plugin/.opencode/skill/retrieval-policy/references/command-reference.md
@plugins/memory-opencode-plugin/.opencode/skill/topic-graph/references/command-reference.md
@plugins/memory-opencode-plugin/.opencode/skill/bm25-search/references/command-reference.md
@plugins/memory-opencode-plugin/.opencode/skill/vector-search/references/command-reference.md
@plugins/memory-opencode-plugin/.opencode/agents/memory-navigator.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TOML command files for Gemini</name>
  <files>
    plugins/memory-gemini-adapter/.gemini/commands/memory-search.toml
    plugins/memory-gemini-adapter/.gemini/commands/memory-recent.toml
    plugins/memory-gemini-adapter/.gemini/commands/memory-context.toml
  </files>
  <action>
Create three TOML command files in Gemini CLI format. Gemini TOML commands have two fields: `description` (short summary) and `prompt` (the full instruction text that Gemini receives when the command is invoked). Use `{{args}}` for argument substitution.

**memory-search.toml:**
- description: "Search past conversations by topic or keyword using agent-memory"
- prompt: Instruct Gemini to parse arguments (topic required, optional --period, --agent), check daemon status, use tier-aware retrieval (`memory-daemon retrieval route "{{args}}"`), fall back to TOC navigation if no results, and format results with grip IDs. Reference the research Example 3 for the prompt structure.

**memory-recent.toml:**
- description: "Show recent conversation summaries from agent-memory"
- prompt: Instruct Gemini to parse arguments (optional --days N, --limit N, --agent), get TOC root, navigate to current period, collect recent day nodes, and present summaries with timestamps and grip IDs. Reference research Example 4.

**memory-context.toml:**
- description: "Expand a grip to see full conversation context around an excerpt"
- prompt: Instruct Gemini to parse the grip ID argument (required, format grip:{timestamp}:{ulid}), validate format, expand using `memory-daemon query expand`, and format the conversation thread with before/after events. Reference research Example 5.

All three commands should include:
- Clear argument parsing instructions
- The exact `memory-daemon` CLI commands to run (with `--endpoint http://[::1]:50051` where needed)
- Output format templates in markdown
- Error handling guidance (daemon not running, no results)
- A footer suggesting `/memory-context grip:ID` for drill-down (where applicable)

Use the research examples as the baseline but adapt the argument handling to reference `{{args}}` properly. The commands should be self-contained -- Gemini does not load skills automatically from commands, so the prompt must include enough instruction to execute the query.
  </action>
  <verify>
1. All three TOML files parse correctly: `python3 -c "import tomllib; tomllib.load(open('plugins/memory-gemini-adapter/.gemini/commands/memory-search.toml','rb'))"` (repeat for each)
2. Each file has both `description` and `prompt` keys
3. `memory-search.toml` prompt contains `memory-daemon retrieval route`
4. `memory-recent.toml` prompt contains `memory-daemon query` and `root`
5. `memory-context.toml` prompt contains `memory-daemon query` and `expand`
6. All prompts reference `{{args}}` for argument substitution
  </verify>
  <done>
Three TOML command files exist with valid TOML syntax, each containing description + prompt fields, with complete instructions for Gemini to execute memory queries including argument parsing, CLI commands, output formatting, and error handling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Copy skills and embed navigator logic in memory-query</name>
  <files>
    plugins/memory-gemini-adapter/.gemini/skills/memory-query/SKILL.md
    plugins/memory-gemini-adapter/.gemini/skills/memory-query/references/command-reference.md
    plugins/memory-gemini-adapter/.gemini/skills/retrieval-policy/SKILL.md
    plugins/memory-gemini-adapter/.gemini/skills/retrieval-policy/references/command-reference.md
    plugins/memory-gemini-adapter/.gemini/skills/topic-graph/SKILL.md
    plugins/memory-gemini-adapter/.gemini/skills/topic-graph/references/command-reference.md
    plugins/memory-gemini-adapter/.gemini/skills/bm25-search/SKILL.md
    plugins/memory-gemini-adapter/.gemini/skills/bm25-search/references/command-reference.md
    plugins/memory-gemini-adapter/.gemini/skills/vector-search/SKILL.md
    plugins/memory-gemini-adapter/.gemini/skills/vector-search/references/command-reference.md
  </files>
  <action>
Create skill directories and files for the Gemini adapter. Gemini CLI natively supports the SKILL.md format (same as Claude Code), so skills can be copied with minimal changes.

**For retrieval-policy, topic-graph, bm25-search, vector-search:**
Copy the SKILL.md and references/command-reference.md files directly from `plugins/memory-opencode-plugin/.opencode/skill/` to `plugins/memory-gemini-adapter/.gemini/skills/`. These skills are format-compatible and need no modifications. Gemini reads SKILL.md with YAML frontmatter identically to Claude Code and OpenCode.

**For memory-query (ENHANCED):**
Copy the base SKILL.md from the OpenCode plugin, then ADD the navigator agent logic. Per user decision: "embed navigator logic inside the skill, tell Gemini to invoke in parallel". This means adding a section to memory-query/SKILL.md that includes:

1. A "Navigator Mode" section explaining that for complex queries, Gemini should activate this skill's full retrieval workflow automatically
2. The agent navigation loop from the OpenCode memory-navigator agent (intent classification -> tier detection -> route through optimal layers -> expand grips -> return with explainability)
3. Trigger patterns: "recall what we discussed", "search conversation history", "find previous session", "what did we talk about", "get context from earlier"
4. Instructions to invoke retrieval steps in parallel where possible (e.g., classify intent while checking retrieval status)

Read the OpenCode navigator agent file (`plugins/memory-opencode-plugin/.opencode/agents/memory-navigator.md`) and merge its behavioral instructions into the memory-query SKILL.md. The skill should be self-contained -- when Gemini activates memory-query, it gets both the query capability AND the navigator intelligence.

All skills must have YAML frontmatter with name, description, license, and metadata fields matching the existing pattern.
  </action>
  <verify>
1. All 5 skill directories exist with SKILL.md files:
   - `test -f plugins/memory-gemini-adapter/.gemini/skills/memory-query/SKILL.md`
   - `test -f plugins/memory-gemini-adapter/.gemini/skills/retrieval-policy/SKILL.md`
   - `test -f plugins/memory-gemini-adapter/.gemini/skills/topic-graph/SKILL.md`
   - `test -f plugins/memory-gemini-adapter/.gemini/skills/bm25-search/SKILL.md`
   - `test -f plugins/memory-gemini-adapter/.gemini/skills/vector-search/SKILL.md`
2. All 5 reference directories exist with command-reference.md:
   - `test -f plugins/memory-gemini-adapter/.gemini/skills/memory-query/references/command-reference.md` (repeat for each)
3. memory-query/SKILL.md contains "Navigator" (navigator logic embedded)
4. memory-query/SKILL.md contains "intent" or "classify" (intent classification)
5. memory-query/SKILL.md contains "parallel" (parallel invocation instruction)
6. All SKILL.md files have YAML frontmatter: `head -1 plugins/memory-gemini-adapter/.gemini/skills/*/SKILL.md` shows `---`
7. Each SKILL.md has `name:` in frontmatter
  </verify>
  <done>
Five skill directories exist with SKILL.md + references/command-reference.md files. Four skills (retrieval-policy, topic-graph, bm25-search, vector-search) are direct copies from OpenCode plugin. memory-query skill has navigator agent logic embedded with trigger patterns, intent classification, and parallel invocation instructions.
  </done>
</task>

</tasks>

<verification>
- All 3 TOML commands parse as valid TOML
- All 5 skills have SKILL.md with YAML frontmatter
- memory-query skill includes navigator logic (no separate agent file)
- Commands reference correct memory-daemon CLI commands
- Skills are separate copies (not symlinks) for portability
</verification>

<success_criteria>
- 3 TOML command files in .gemini/commands/ with description + prompt fields
- 5 skill directories in .gemini/skills/ with SKILL.md + references/
- memory-query skill embeds navigator agent intelligence
- All files use correct Gemini CLI format (TOML for commands, SKILL.md for skills)
</success_criteria>

<output>
After completion, create `.planning/phases/21-gemini-cli-adapter/21-02-SUMMARY.md`
</output>

---
phase: 18-agent-tagging-infrastructure
plan: 03
type: execute
wave: 2
depends_on:
  - 18-01
files_modified:
  - crates/memory-types/src/toc.rs
  - crates/memory-daemon/src/cli.rs
autonomous: true

must_haves:
  truths:
    - "TocNode tracks which agents contributed events"
    - "CLI teleport search accepts --agent filter"
    - "CLI route query accepts --agent filter"
    - "Old TocNodes without contributing_agents deserialize correctly"
  artifacts:
    - path: "crates/memory-types/src/toc.rs"
      provides: "TocNode with contributing_agents field"
      contains: "pub contributing_agents: Vec<String>"
    - path: "crates/memory-daemon/src/cli.rs"
      provides: "CLI with --agent filter"
      contains: "agent: Option<String>"
  key_links:
    - from: "crates/memory-daemon/src/cli.rs"
      to: "TeleportCommand::Search"
      via: "clap derive macro"
      pattern: "#\\[arg.*agent"
---

<objective>
Add contributing_agents to TocNode and --agent filter to CLI commands.

Purpose: Enable tracking which agents contributed to each time period (for TOC display) and allow users to filter queries by agent via CLI.

Output: Updated TocNode with contributing_agents, CLI commands with --agent filter.
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-agent-tagging-infrastructure/18-RESEARCH.md

# Reference for patterns
@crates/memory-types/src/toc.rs
@crates/memory-daemon/src/cli.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add contributing_agents to TocNode</name>
  <files>crates/memory-types/src/toc.rs</files>
  <action>
Add the contributing_agents field to TocNode for tracking which agents contributed events.

Follow the Phase 16 salience pattern for backward compatibility.

1. Add the field to TocNode struct after is_pinned (around line 158):

```rust
// === Phase 18: Multi-Agent Tracking ===
/// Agents that contributed events to this time period.
///
/// Populated during TOC building when events from multiple
/// agents fall within the same time window.
/// Default: empty Vec for pre-phase-18 nodes.
#[serde(default)]
pub contributing_agents: Vec<String>,
```

2. Update TocNode::new() to initialize the field:

In the Self { ... } block (around line 185), add after is_pinned:
```rust
// Phase 18: Multi-agent tracking
contributing_agents: Vec::new(),
```

3. Add builder method after with_pinned():

```rust
/// Add a contributing agent.
pub fn with_contributing_agent(mut self, agent: impl Into<String>) -> Self {
    let agent_id = agent.into().to_lowercase();
    if !self.contributing_agents.contains(&agent_id) {
        self.contributing_agents.push(agent_id);
    }
    self
}

/// Set all contributing agents.
pub fn with_contributing_agents(mut self, agents: Vec<String>) -> Self {
    self.contributing_agents = agents.into_iter()
        .map(|a| a.to_lowercase())
        .collect();
    // Deduplicate
    self.contributing_agents.sort();
    self.contributing_agents.dedup();
    self
}
```

4. Add backward compatibility test after existing tests:

```rust
#[test]
fn test_toc_node_backward_compat_no_agents() {
    // Simulate pre-phase-18 serialized node (no contributing_agents field)
    let v200_json = r#"{
        "node_id": "toc:day:2026-01-01",
        "level": "day",
        "title": "January 1, 2026",
        "start_time": 1735689600000,
        "end_time": 1735776000000,
        "bullets": [],
        "keywords": [],
        "child_node_ids": [],
        "version": 1,
        "created_at": 1735689600000,
        "salience_score": 0.5,
        "memory_kind": "observation",
        "is_pinned": false
    }"#;

    let node: TocNode = serde_json::from_str(v200_json).unwrap();

    // Verify default contributing_agents is empty
    assert!(node.contributing_agents.is_empty());
    // Verify other fields loaded correctly
    assert_eq!(node.node_id, "toc:day:2026-01-01");
}

#[test]
fn test_toc_node_with_contributing_agents() {
    let node = TocNode::new(
        "node-123".to_string(),
        TocLevel::Day,
        "Test Node".to_string(),
        Utc::now(),
        Utc::now(),
    )
    .with_contributing_agent("claude")
    .with_contributing_agent("opencode")
    .with_contributing_agent("Claude"); // Should dedupe to "claude"

    assert_eq!(node.contributing_agents.len(), 2);
    assert!(node.contributing_agents.contains(&"claude".to_string()));
    assert!(node.contributing_agents.contains(&"opencode".to_string()));
}
```
  </action>
  <verify>
Run `cargo test -p memory-types` - all tests pass including new tests.
Run `cargo clippy -p memory-types` - no warnings.
  </verify>
  <done>
TocNode has contributing_agents: Vec<String> field with serde(default).
with_contributing_agent() and with_contributing_agents() builder methods exist.
Backward compatibility test passes for nodes without contributing_agents.
Agent IDs are normalized to lowercase and deduplicated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add --agent filter to CLI teleport and retrieval commands</name>
  <files>crates/memory-daemon/src/cli.rs</files>
  <action>
Add --agent filter option to relevant CLI commands following existing patterns.

1. Add --agent to TeleportCommand::Search (around line 275):

After the `query` field, add:
```rust
/// Filter results to a specific agent (e.g., "claude", "opencode")
#[arg(long, short = 'a')]
agent: Option<String>,
```

2. Add --agent to TeleportCommand::VectorSearch (around line 295):

After the `query` field, add:
```rust
/// Filter results to a specific agent (e.g., "claude", "opencode")
#[arg(long, short = 'a')]
agent: Option<String>,
```

3. Add --agent to TeleportCommand::HybridSearch (around line 315):

After the `query` field, add:
```rust
/// Filter results to a specific agent (e.g., "claude", "opencode")
#[arg(long, short = 'a')]
agent: Option<String>,
```

4. Add --agent to RetrievalCommand::Route (around line 473):

After the `query` field, add:
```rust
/// Filter results to a specific agent (e.g., "claude", "opencode")
#[arg(long, short = 'a')]
agent: Option<String>,
```

5. Add CLI tests at the end of the tests module:

```rust
#[test]
fn test_cli_teleport_search_with_agent() {
    let cli = Cli::parse_from([
        "memory-daemon",
        "teleport",
        "search",
        "rust memory",
        "--agent",
        "claude",
    ]);
    match cli.command {
        Commands::Teleport(TeleportCommand::Search { query, agent, .. }) => {
            assert_eq!(query, "rust memory");
            assert_eq!(agent, Some("claude".to_string()));
        }
        _ => panic!("Expected Teleport Search command"),
    }
}

#[test]
fn test_cli_teleport_search_agent_short() {
    let cli = Cli::parse_from([
        "memory-daemon",
        "teleport",
        "search",
        "authentication",
        "-a",
        "opencode",
    ]);
    match cli.command {
        Commands::Teleport(TeleportCommand::Search { agent, .. }) => {
            assert_eq!(agent, Some("opencode".to_string()));
        }
        _ => panic!("Expected Teleport Search command"),
    }
}

#[test]
fn test_cli_retrieval_route_with_agent() {
    let cli = Cli::parse_from([
        "memory-daemon",
        "retrieval",
        "route",
        "test query",
        "--agent",
        "gemini",
    ]);
    match cli.command {
        Commands::Retrieval(RetrievalCommand::Route { query, agent, .. }) => {
            assert_eq!(query, "test query");
            assert_eq!(agent, Some("gemini".to_string()));
        }
        _ => panic!("Expected Retrieval Route command"),
    }
}
```
  </action>
  <verify>
Run `cargo test -p memory-daemon` - all tests pass including new agent filter tests.
Run `cargo clippy -p memory-daemon` - no warnings.
Run `cargo run -p memory-daemon -- teleport search "test" --help` - shows --agent option.
  </verify>
  <done>
TeleportCommand::Search has --agent/-a filter option.
TeleportCommand::VectorSearch has --agent/-a filter option.
TeleportCommand::HybridSearch has --agent/-a filter option.
RetrievalCommand::Route has --agent/-a filter option.
CLI tests verify the --agent option works.
  </done>
</task>

</tasks>

<verification>
1. `cargo build --workspace` compiles successfully
2. `cargo test -p memory-types` passes all tests
3. `cargo test -p memory-daemon` passes all tests
4. `cargo clippy --workspace` has no warnings
5. CLI help shows --agent option for teleport and retrieval commands
</verification>

<success_criteria>
- TocNode has `contributing_agents: Vec<String>` with serde(default)
- Builder methods for adding contributing agents exist
- Old TocNodes deserialize with empty contributing_agents
- TeleportCommand::Search has --agent/-a filter
- TeleportCommand::VectorSearch has --agent/-a filter
- TeleportCommand::HybridSearch has --agent/-a filter
- RetrievalCommand::Route has --agent/-a filter
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/18-agent-tagging-infrastructure/18-03-SUMMARY.md`
</output>

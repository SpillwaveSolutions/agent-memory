# Plan 06-02: Documentation and Usage Examples

## Goal

Create comprehensive documentation that enables users and developers to understand, install, configure, and integrate with the agent-memory system.

## Success Criteria

1. README.md provides quick start and overview
2. Architecture documentation explains component relationships
3. Usage guide covers all CLI commands
4. Integration guide shows hook handler setup
5. API reference documents all gRPC endpoints

## Tasks

### Task 1: Update Root README.md

Update `README.md` with:

```markdown
# Agent Memory

Local, append-only conversational memory with TOC-based agentic navigation.

## Overview

Agent Memory provides AI agents with efficient recall of past conversations through:

- **Time-based TOC**: Year -> Month -> Week -> Day -> Segment hierarchy
- **Summaries**: Auto-generated summaries at each level
- **Grips**: Anchors linking summaries to source evidence
- **gRPC API**: Fast, type-safe communication

## Quick Start

### Build

```bash
cargo build --release
```

### Start Daemon

```bash
# Start with default settings
./target/release/memory-daemon start

# Start with custom config
./target/release/memory-daemon start --port 50051 --db-path ~/.memory-store
```

### Stop Daemon

```bash
./target/release/memory-daemon stop
```

### Check Status

```bash
./target/release/memory-daemon status
```

## Configuration

Configuration sources (highest priority first):
1. Command-line flags
2. Environment variables (MEMORY_* prefix)
3. Config file (~/.config/memory-daemon/config.toml)
4. Defaults

### Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| MEMORY_PORT | gRPC port | 50051 |
| MEMORY_DB_PATH | RocksDB path | ~/.memory-store |
| MEMORY_LOG_LEVEL | Log verbosity | info |

## CLI Commands

### Query Commands

```bash
# Get TOC root nodes
memory-daemon query --endpoint http://127.0.0.1:50051 root

# Get specific node
memory-daemon query --endpoint http://127.0.0.1:50051 node --node-id "toc:year:2026"

# Browse node children
memory-daemon query --endpoint http://127.0.0.1:50051 browse --parent-id "toc:year:2026" --limit 10

# Get events in time range
memory-daemon query --endpoint http://127.0.0.1:50051 events --from 1706745600000 --to 1706832000000

# Expand grip context
memory-daemon query --endpoint http://127.0.0.1:50051 expand --grip-id "grip:123:abc"
```

### Admin Commands

```bash
# Storage statistics
memory-daemon admin --db-path ~/.memory-store stats

# Compact database
memory-daemon admin --db-path ~/.memory-store compact

# Compact specific column family
memory-daemon admin --db-path ~/.memory-store compact --cf events
```

## Architecture

See [docs/ARCHITECTURE.md](docs/ARCHITECTURE.md) for detailed component documentation.

## Integration

See [docs/INTEGRATION.md](docs/INTEGRATION.md) for hook handler setup.

## License

MIT
```

### Task 2: Create Architecture Documentation

Create `docs/ARCHITECTURE.md`:

```markdown
# Architecture

## Component Overview

```
┌─────────────────────────────────────────────────────────────┐
│                      Hook Handler                            │
│  (captures conversation events from Claude Code hooks)       │
└────────────────────────┬────────────────────────────────────┘
                         │ IngestEvent RPC
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                     memory-daemon                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │   gRPC      │  │    TOC      │  │    Summarizer       │  │
│  │   Server    │  │   Builder   │  │    (LLM API)        │  │
│  └──────┬──────┘  └──────┬──────┘  └──────────┬──────────┘  │
│         │                │                     │              │
│         └────────────────┼─────────────────────┘              │
│                          ▼                                    │
│  ┌───────────────────────────────────────────────────────┐   │
│  │                    memory-storage                      │   │
│  │                      (RocksDB)                         │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────────┐  │   │
│  │  │ Events  │ │   TOC   │ │  Grips  │ │ Checkpoints │  │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────────┘  │   │
│  └───────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## Crate Structure

| Crate | Purpose |
|-------|---------|
| memory-types | Domain models (Event, TocNode, Grip, Settings) |
| memory-storage | RocksDB persistence layer |
| memory-toc | Segmentation, summarization, TOC building |
| memory-service | gRPC service implementation |
| memory-client | Client library for hook handlers |
| memory-daemon | CLI binary |

## Data Flow

### Event Ingestion

1. Hook handler captures event (user message, assistant response, etc.)
2. memory-client maps hook event to domain Event
3. IngestEvent RPC sends to daemon
4. Daemon stores in RocksDB with outbox entry
5. Background job processes outbox for TOC updates

### TOC Construction

1. Outbox processor reads pending events
2. Segmenter groups events by time/token boundaries
3. Summarizer generates summaries with grips
4. TocBuilder creates/updates node hierarchy
5. Checkpoint written for crash recovery

### Query Resolution

1. Client calls GetTocRoot for year nodes
2. Navigate down: GetNode or BrowseToc
3. Find relevant time period via summaries
4. GetEvents retrieves raw events
5. ExpandGrip provides source evidence

## Storage Schema

### Column Families

| CF | Key Format | Value |
|----|------------|-------|
| events | `evt:{ts_ms:013}:{ulid}` | Event JSON |
| toc_nodes | `toc:{level}:{time_id}` | TocNode JSON |
| toc_latest | `toc:{level}:{time_id}` | Latest version pointer |
| grips | `grip:{ts_ms:013}:{ulid}` | Grip JSON |
| outbox | `out:{ts_ms:013}:{ulid}` | OutboxEntry JSON |
| checkpoints | `chk:{job_name}` | Checkpoint bytes |

### Key Design

Time-prefixed keys enable efficient range scans:
- All events for January 2026: `evt:1704067200000` to `evt:1706745599999`
- ULID suffix ensures uniqueness within millisecond

## Crash Recovery

1. Atomic batch writes ensure consistency
2. Outbox entries survive crash
3. Checkpoints store job progress
4. On restart, jobs resume from checkpoint
5. Idempotent operations handle duplicates
```

### Task 3: Create Usage Guide

Create `docs/USAGE.md`:

```markdown
# Usage Guide

## Starting the Daemon

### Basic Start

```bash
memory-daemon start
```

### With Options

```bash
memory-daemon start \
  --port 50051 \
  --db-path /var/lib/memory-store \
  --config /etc/memory-daemon/config.toml
```

### As Background Service

Using systemd:
```ini
[Unit]
Description=Agent Memory Daemon
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/memory-daemon start
ExecStop=/usr/local/bin/memory-daemon stop
Restart=on-failure

[Install]
WantedBy=multi-user.target
```

Using launchd (macOS):
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.spillwave.memory-daemon</string>
    <key>ProgramArguments</key>
    <array>
        <string>/usr/local/bin/memory-daemon</string>
        <string>start</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <true/>
</dict>
</plist>
```

## Querying Data

### TOC Navigation

```bash
# Start at the top
memory-daemon query root
# Output: Year nodes with summaries

# Drill down to a month
memory-daemon query browse --parent-id "toc:year:2026" --limit 12

# Get specific day
memory-daemon query node --node-id "toc:day:2026-01-30"
```

### Event Retrieval

```bash
# Events from specific time range
memory-daemon query events \
  --from 1706572800000 \
  --to 1706659199000 \
  --limit 100
```

### Grip Expansion

```bash
# Get context around a grip
memory-daemon query expand \
  --grip-id "grip:1706600000000:01HXYZ123" \
  --before 3 \
  --after 3
```

## Database Administration

### Storage Statistics

```bash
memory-daemon admin stats
# Output:
# Events: 1,234
# TOC Nodes: 56
# Grips: 789
# Outbox: 0
# Disk Usage: 12.5 MB
```

### Compaction

```bash
# Compact all column families
memory-daemon admin compact

# Compact specific CF
memory-daemon admin compact --cf events
```

### Database Location

Default: `~/.memory-store`

Override via:
- `--db-path` flag
- `MEMORY_DB_PATH` env var
- Config file `db_path` key
```

### Task 4: Create Integration Guide

Create `docs/INTEGRATION.md`:

```markdown
# Integration Guide

## Hook Handler Setup

### Claude Code Hooks

Agent-memory integrates with Claude Code via hooks. Add to your hooks configuration:

```json
{
  "hooks": {
    "UserPromptSubmit": [
      {
        "command": "memory-hook ingest user-prompt"
      }
    ],
    "AssistantResponse": [
      {
        "command": "memory-hook ingest assistant-response"
      }
    ]
  }
}
```

### Using the Client Library

```rust
use memory_client::{MemoryClient, HookEvent, HookEventType, map_hook_event};

async fn ingest_event(content: &str) -> Result<(), Box<dyn std::error::Error>> {
    let mut client = MemoryClient::connect("http://127.0.0.1:50051").await?;

    let hook_event = HookEvent {
        session_id: std::env::var("SESSION_ID")?,
        event_type: HookEventType::UserPromptSubmit,
        content: content.to_string(),
        timestamp: None,
        tool_name: None,
        metadata: None,
    };

    let event = map_hook_event(hook_event);
    let (event_id, created) = client.ingest(event).await?;

    println!("Event {}: created={}", event_id, created);
    Ok(())
}
```

### Event Type Mapping

| Hook Event | Memory Event Type |
|------------|-------------------|
| SessionStart | EVENT_TYPE_SESSION_START |
| UserPromptSubmit | EVENT_TYPE_USER_MESSAGE |
| AssistantResponse | EVENT_TYPE_ASSISTANT_MESSAGE |
| ToolUse | EVENT_TYPE_TOOL_RESULT |
| ToolResult | EVENT_TYPE_TOOL_RESULT |
| Stop | EVENT_TYPE_ASSISTANT_STOP |
| SubagentStart | EVENT_TYPE_SUBAGENT_START |
| SubagentStop | EVENT_TYPE_SUBAGENT_STOP |

### Required Metadata

```rust
// Tool events should include tool name
let mut metadata = HashMap::new();
metadata.insert("tool_name".to_string(), "Read".to_string());
metadata.insert("file_path".to_string(), "/path/to/file".to_string());

event = event.with_metadata(metadata);
```

## gRPC API

### Proto Definition

```protobuf
service MemoryService {
    rpc IngestEvent(IngestEventRequest) returns (IngestEventResponse);
    rpc GetTocRoot(GetTocRootRequest) returns (GetTocRootResponse);
    rpc GetNode(GetNodeRequest) returns (GetNodeResponse);
    rpc BrowseToc(BrowseTocRequest) returns (BrowseTocResponse);
    rpc GetEvents(GetEventsRequest) returns (GetEventsResponse);
    rpc ExpandGrip(ExpandGripRequest) returns (ExpandGripResponse);
}
```

### Example: Direct gRPC Call

Using grpcurl:
```bash
grpcurl -plaintext \
  -d '{"event": {"event_id": "01HXYZ...", "session_id": "sess-123", ...}}' \
  localhost:50051 memory.MemoryService/IngestEvent
```

## Error Handling

### Client Errors

```rust
use memory_client::ClientError;

match client.ingest(event).await {
    Ok((id, created)) => println!("Success: {}", id),
    Err(ClientError::Connection(e)) => eprintln!("Connection failed: {}", e),
    Err(ClientError::InvalidArgument(msg)) => eprintln!("Bad input: {}", msg),
    Err(ClientError::Internal(msg)) => eprintln!("Server error: {}", msg),
}
```

### Retry Strategy

```rust
use tokio::time::{sleep, Duration};

async fn ingest_with_retry(client: &mut MemoryClient, event: Event) -> Result<String, ClientError> {
    let mut attempts = 0;
    loop {
        match client.ingest(event.clone()).await {
            Ok((id, _)) => return Ok(id),
            Err(ClientError::Connection(_)) if attempts < 3 => {
                attempts += 1;
                sleep(Duration::from_millis(100 * attempts as u64)).await;
            }
            Err(e) => return Err(e),
        }
    }
}
```
```

### Task 5: Create API Reference

Create `docs/API.md`:

```markdown
# API Reference

## gRPC Service: MemoryService

### IngestEvent

Ingest a conversation event.

**Request:**
```protobuf
message IngestEventRequest {
    Event event = 1;
}

message Event {
    string event_id = 1;      // ULID, client-generated
    string session_id = 2;    // Session identifier
    int64 timestamp_ms = 3;   // Unix millis
    EventType event_type = 4; // Type enum
    EventRole role = 5;       // Role enum
    string text = 6;          // Content
    map<string, string> metadata = 7;
}
```

**Response:**
```protobuf
message IngestEventResponse {
    string event_id = 1;  // Stored event ID
    bool created = 2;     // True if new, false if duplicate
}
```

**Errors:**
- `INVALID_ARGUMENT`: Missing event_id or session_id
- `INTERNAL`: Storage failure

### GetTocRoot

Get root TOC nodes (year level).

**Request:**
```protobuf
message GetTocRootRequest {}
```

**Response:**
```protobuf
message GetTocRootResponse {
    repeated TocNode nodes = 1;  // Year nodes, time-descending
}
```

### GetNode

Get a specific TOC node by ID.

**Request:**
```protobuf
message GetNodeRequest {
    string node_id = 1;  // e.g., "toc:year:2026"
}
```

**Response:**
```protobuf
message GetNodeResponse {
    optional TocNode node = 1;  // Null if not found
}
```

### BrowseToc

Browse children of a TOC node with pagination.

**Request:**
```protobuf
message BrowseTocRequest {
    string parent_id = 1;
    int32 limit = 2;
    optional string continuation_token = 3;
}
```

**Response:**
```protobuf
message BrowseTocResponse {
    repeated TocNode children = 1;
    optional string continuation_token = 2;
    bool has_more = 3;
}
```

### GetEvents

Get events in a time range.

**Request:**
```protobuf
message GetEventsRequest {
    int64 from_timestamp_ms = 1;  // Inclusive
    int64 to_timestamp_ms = 2;    // Inclusive
    int32 limit = 3;
}
```

**Response:**
```protobuf
message GetEventsResponse {
    repeated Event events = 1;
    bool has_more = 2;
}
```

### ExpandGrip

Expand a grip to show context events.

**Request:**
```protobuf
message ExpandGripRequest {
    string grip_id = 1;
    optional int32 events_before = 2;  // Default: 5
    optional int32 events_after = 3;   // Default: 5
}
```

**Response:**
```protobuf
message ExpandGripResponse {
    optional Grip grip = 1;
    repeated Event events_before = 2;
    repeated Event excerpt_events = 3;
    repeated Event events_after = 4;
}
```

## Data Types

### EventType Enum

| Value | Description |
|-------|-------------|
| EVENT_TYPE_SESSION_START | Session begins |
| EVENT_TYPE_USER_MESSAGE | User prompt |
| EVENT_TYPE_ASSISTANT_MESSAGE | Assistant response |
| EVENT_TYPE_TOOL_RESULT | Tool output |
| EVENT_TYPE_ASSISTANT_STOP | Assistant completes |
| EVENT_TYPE_SUBAGENT_START | Subagent spawned |
| EVENT_TYPE_SUBAGENT_STOP | Subagent completes |
| EVENT_TYPE_SESSION_END | Session ends |

### EventRole Enum

| Value | Description |
|-------|-------------|
| EVENT_ROLE_USER | Human user |
| EVENT_ROLE_ASSISTANT | AI assistant |
| EVENT_ROLE_SYSTEM | System message |
| EVENT_ROLE_TOOL | Tool output |

### TocLevel Enum

| Value | Description |
|-------|-------------|
| TOC_LEVEL_YEAR | Year level |
| TOC_LEVEL_MONTH | Month level |
| TOC_LEVEL_WEEK | Week level |
| TOC_LEVEL_DAY | Day level |
| TOC_LEVEL_SEGMENT | Segment level |
```

## Verification

1. README.md is complete and accurate
2. Architecture diagram matches implementation
3. All CLI commands documented with examples
4. Integration code compiles and works
5. API reference matches proto definitions

## Dependencies

- All Phase 1-5 implementation complete
- Proto files finalized

## Notes

- Keep examples minimal but complete
- Prefer code examples over prose
- Test all documented commands before publishing

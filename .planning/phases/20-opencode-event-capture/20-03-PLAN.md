---
phase: 20-opencode-event-capture
plan: 03
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - crates/memory-daemon/src/commands.rs
  - plugins/memory-opencode-plugin/README.md
  - plugins/memory-opencode-plugin/.gitignore
autonomous: true

must_haves:
  truths:
    - "CLI output for retrieval route shows source agent when present"
    - "CLI output for teleport search shows source agent when present"
    - "CLI output for vector search shows source agent when present"
    - "Plugin README documents event capture plugin installation and behavior"
    - "Results without agent field display normally (backward compatible)"
  artifacts:
    - path: "crates/memory-daemon/src/commands.rs"
      provides: "Agent display in CLI output for all query result types"
      contains: "agent"
    - path: "plugins/memory-opencode-plugin/README.md"
      provides: "Updated documentation with event capture section"
      contains: "Event Capture"
  key_links:
    - from: "crates/memory-daemon/src/commands.rs"
      to: "crates/memory-service/src/retrieval.rs"
      via: "RetrievalResult.agent displayed in CLI output"
      pattern: "result.agent"
---

<objective>
Add agent source display to all CLI query output formatters and update the OpenCode plugin README to document the event capture plugin.

Purpose: Fulfills the "results show source agent in output" definition of done for Phase 20, and provides installation documentation for the event capture feature. Without CLI display, the agent field is populated but invisible to users.

Output: Updated CLI command handlers showing agent in query results, and updated plugin README documenting event capture.
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-opencode-event-capture/20-RESEARCH.md
@.planning/phases/20-opencode-event-capture/20-01-SUMMARY.md

# Key source files
@crates/memory-daemon/src/commands.rs
@plugins/memory-opencode-plugin/README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add agent display to CLI query output formatters</name>
  <files>
    crates/memory-daemon/src/commands.rs
  </files>
  <action>
Update three CLI output sections in `crates/memory-daemon/src/commands.rs` to display the agent field when present:

**1. Retrieval Route results** (around line 2354-2378):

After the existing `println!("   Type: {}", result.doc_type);` line (~line 2377), add:
```rust
if let Some(ref agent) = result.agent {
    println!("   Agent: {}", agent);
}
```

**2. Teleport Search results** -- The teleport search uses `TeleportSearchResponse` which returns `TeleportResult` messages. Check the proto definition for whether `TeleportResult` has an `agent` field. If `TeleportResult` in `proto/memory.proto` does NOT have an agent field (it likely doesn't -- it has `doc_id`, `doc_type`, `score`, `keywords`), then skip this output section for now. The teleport search results come from BM25 index documents, not directly from the retrieval pipeline. Agent display for teleport will require index metadata propagation (future work).

NOTE: Only add agent display where the proto response message has an `agent` field. Do NOT add display code that would fail to compile because the field doesn't exist.

**3. Vector Search results** -- Similarly, check `VectorTeleportMatch` proto for agent field. If not present, skip.

**4. Hybrid Search results** -- Check `HybridSearchResult` proto for agent field. If not present, skip.

**Key principle:** Only add agent display for response types that have the `agent` field in their proto definition. The `RetrievalResult` from `RouteQueryResponse` definitely has `optional string agent = 7`. Other search result types may not.

**5. Pass `--agent` filter through retrieval route** -- In `retrieval_route()` function (~line 2280-2288), the `agent_filter` is currently hardcoded to `None`. The `--agent` flag is defined on the CLI (line 504-506) but the value is ignored in the `..` destructuring at line 2081. Fix this:

In the `RetrievalCommand::Route` match arm (~line 2074-2092), change the destructuring to capture `agent`:
```rust
RetrievalCommand::Route {
    query,
    intent,
    limit,
    mode,
    timeout_ms,
    agent,
    addr,
} => {
    retrieval_route(
        &query,
        intent.as_deref(),
        limit,
        mode.as_deref(),
        timeout_ms,
        agent.as_deref(),
        &addr,
    )
    .await
}
```

Update `retrieval_route()` signature to accept `agent_filter: Option<&str>`:
```rust
async fn retrieval_route(
    query: &str,
    intent_override: Option<&str>,
    limit: u32,
    mode_override: Option<&str>,
    timeout_ms: Option<u64>,
    agent_filter: Option<&str>,
    addr: &str,
) -> Result<()> {
```

In the `RouteQueryRequest` construction (~line 2281-2288), change:
```rust
agent_filter: agent_filter.map(|s| s.to_string()),
```
  </action>
  <verify>
Run `cargo build -p memory-daemon` -- compiles without errors. Run `cargo clippy -p memory-daemon --all-targets --all-features -- -D warnings` -- no warnings. Run `cargo test -p memory-daemon --all-features` -- all tests pass. Manually verify:
- `memory-daemon retrieval route "test query" --agent opencode` compiles and accepts the flag
- The output section for retrieval results includes `Agent: <value>` line when agent is present
  </verify>
  <done>
CLI retrieval route output shows "Agent: opencode" (or other agent name) for results that have agent metadata. The `--agent` filter flag is wired through to the RouteQuery gRPC request. Results without agent field display normally without the Agent line.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update plugin README with event capture documentation</name>
  <files>
    plugins/memory-opencode-plugin/README.md
    plugins/memory-opencode-plugin/.gitignore
  </files>
  <action>
**Step 1: Update README.md** to add event capture documentation.

Read the existing README.md first. Add a new major section after the "Installation" section (or after the "Commands" section if more appropriate) titled "## Event Capture". The section should cover:

```markdown
## Event Capture

The plugin includes an automatic event capture system that records your OpenCode sessions into agent-memory. This enables cross-agent memory sharing -- conversations from OpenCode become searchable alongside Claude Code sessions.

### How It Works

The event capture plugin (`.opencode/plugin/memory-capture.ts`) hooks into OpenCode lifecycle events:

| Event | Hook | What's Captured |
|-------|------|----------------|
| Session start | `session.created` | New session with project directory |
| Session end | `session.idle` | Session checkpoint/completion |
| User messages | `message.updated` | User prompts |
| Assistant responses | `message.updated` | AI responses |
| Tool executions | `tool.execute.after` | Tool name and arguments |

All events are automatically tagged with `agent:opencode` and include the project directory for context.

### Prerequisites

- `memory-ingest` binary in PATH (installed with agent-memory)
- `memory-daemon` running (events are silently dropped if daemon is unavailable)

### Behavior

- **Fail-open**: Event capture never blocks OpenCode. If `memory-ingest` is not available or the daemon is down, events are silently dropped.
- **Automatic**: No configuration needed. The plugin activates when OpenCode loads the plugin directory.
- **Cross-agent queries**: Once events are captured, use `memory-daemon retrieval route "query"` to search across both Claude Code and OpenCode sessions. Use `--agent opencode` to filter to OpenCode-only results.

### Configuration

| Environment Variable | Default | Purpose |
|---------------------|---------|---------|
| `MEMORY_INGEST_PATH` | `memory-ingest` | Override path to memory-ingest binary |

### Verifying Capture

After an OpenCode session, verify events were captured:

```bash
# Search for recent events
memory-daemon query events --from $(date -v-1H +%s000) --to $(date +%s000) --limit 5

# Search with agent filter
memory-daemon retrieval route "your query" --agent opencode
```
```

Place this section logically in the README -- after installation/usage sections but before troubleshooting.

**Step 2: Update .gitignore** if needed. Check if `node_modules` is already listed. If not, add it. The plugin doesn't currently use npm packages, but adding it proactively prevents accidental commits if dependencies are added later.

Read the current `.gitignore` and ensure it contains at minimum:
```
node_modules/
.opencode/plugin/*.js
```

The `*.js` entry prevents compiled JS from being committed if someone runs tsc.
  </action>
  <verify>
1. `grep "Event Capture" plugins/memory-opencode-plugin/README.md` finds the new section
2. `grep "agent:opencode" plugins/memory-opencode-plugin/README.md` finds the tagging documentation
3. `grep "fail-open" plugins/memory-opencode-plugin/README.md` (case insensitive) finds fail-open behavior docs
4. `grep "node_modules" plugins/memory-opencode-plugin/.gitignore` finds the entry
5. README renders correctly (no broken markdown)
  </verify>
  <done>
Plugin README documents event capture with: how it works, prerequisites, behavior (fail-open), configuration, and verification steps. .gitignore updated to exclude node_modules and compiled JS. Users can understand what the plugin does and how to verify it works.
  </done>
</task>

</tasks>

<verification>
```bash
# Rust compilation and tests
cargo build -p memory-daemon
cargo test -p memory-daemon --all-features
cargo clippy -p memory-daemon --all-targets --all-features -- -D warnings
cargo fmt --all -- --check

# Documentation checks
grep "Event Capture" plugins/memory-opencode-plugin/README.md
grep "agent:opencode" plugins/memory-opencode-plugin/README.md
grep "node_modules" plugins/memory-opencode-plugin/.gitignore
```
</verification>

<success_criteria>
1. `memory-daemon retrieval route "query"` output includes `Agent: <name>` for results with agent metadata
2. `memory-daemon retrieval route "query" --agent opencode` correctly passes the filter to gRPC
3. Plugin README has complete event capture documentation
4. All existing CLI tests pass
5. Zero clippy warnings
</success_criteria>

<output>
After completion, create `.planning/phases/20-opencode-event-capture/20-03-SUMMARY.md`
</output>

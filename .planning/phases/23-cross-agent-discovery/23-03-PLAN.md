---
phase: 23-cross-agent-discovery
plan: 03
type: execute
wave: 2
depends_on:
  - 23-02
files_modified:
  - crates/memory-daemon/src/cli.rs
  - crates/memory-daemon/src/commands.rs
  - docs/adapters/cross-agent-guide.md
  - docs/adapters/authoring-guide.md
  - docs/adapters/clod-format.md
  - docs/README.md
  - docs/UPGRADING.md
autonomous: true

must_haves:
  truths:
    - "CLOD format documented with examples and field definitions"
    - "CLI utility `memory-daemon clod convert --input <file> --target gemini|opencode|copilot --out <dir>` generates adapter artifacts"
    - "Cross-agent usage guide documents agent filters, retrieval route, agents list/activity, topics-by-agent"
    - "Adapter authoring guide documents hooks, fail-open, redaction, agent tagging, config precedence"
    - "Docs include all three adapters (OpenCode, Gemini, Copilot) with install links"
  nice_to_haves:
    - "CLOD round-trip tests per adapter"
    - "Docs include troubleshooting section for common adapter issues"

deliverables:
  - CLOD spec and converter CLI
  - Cross-agent usage guide, adapter authoring guide
  - Updated top-level docs/README and UPGRADING with cross-agent references

risks:
  - "Keeping generated artifacts aligned with evolving adapter formats; mitigate with fixture tests"
  - "User confusion about config precedence; address with explicit precedence section in docs"
---

<objective>
Create the CLOD specification document and converter CLI, write the cross-agent usage guide and adapter authoring guide, and update top-level documentation. CLOD (Cross-Language Operation Definition) is a TOML-based internal format for defining commands that can be generated into adapter-specific files.

Purpose: Complete Phase 23 documentation requirements (R5.1.1-R5.1.3, R5.3.1-R5.3.3) and provide the CLOD converter utility. This enables the community to author new adapters and understand the cross-agent ecosystem.

Output: CLOD spec document, CLOD converter CLI subcommand, cross-agent usage guide, adapter authoring guide, updated README and UPGRADING docs.
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-cross-agent-discovery/23-RESEARCH.md
@.planning/phases/23-cross-agent-discovery/23-01-SUMMARY.md
@.planning/phases/23-cross-agent-discovery/23-02-SUMMARY.md
@crates/memory-daemon/src/cli.rs
@crates/memory-daemon/src/commands.rs
@plugins/memory-opencode-plugin/README.md
@plugins/memory-gemini-adapter/README.md
@plugins/memory-copilot-adapter/README.md
@docs/README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CLOD format specification and converter CLI subcommand</name>
  <files>
    docs/adapters/clod-format.md
    crates/memory-daemon/src/clod.rs
    crates/memory-daemon/src/cli.rs
    crates/memory-daemon/src/commands.rs
    crates/memory-daemon/src/main.rs
  </files>
  <action>
**1. CLOD specification document (docs/adapters/clod-format.md):**

Create the CLOD format specification. This is a greenfield internal format (no external standard exists). Structure:

```markdown
# CLOD: Cross-Language Operation Definition

## Overview
CLOD is a TOML-based format for defining agent-memory commands in a platform-neutral way.
A single CLOD file can be converted to adapter-specific files for Claude Code, OpenCode, Gemini CLI, and Copilot CLI.

## Format

### [command] section
- `name`: Command identifier (kebab-case, e.g., "memory-search")
- `description`: Human-readable description
- `version`: Semantic version of the command definition

### [[command.parameters]] sections
- `name`: Parameter name
- `description`: What the parameter does
- `required`: Whether the parameter is mandatory (bool)
- `position`: Positional argument index (optional)
- `flag`: CLI flag syntax (e.g., "--period")

### [process] section
- `steps`: Array of strings describing execution steps
  - Steps can include CLI commands in backtick notation
  - Use `<param_name>` for parameter substitution

### [output] section
- `format`: Multi-line string template for output formatting

### [adapters.*] sections
- Per-adapter configuration for generation targets
- `directory`: Where generated files go
- `extension`: File extension
- `template`: Which generation template to use
```

Include a complete example (the memory-search command from the research document). Include a second example for a simpler command (e.g., memory-recent). Document all fields with types and defaults.

**2. CLOD converter module (crates/memory-daemon/src/clod.rs):**

Create a new module for CLOD parsing and conversion:

```rust
use serde::Deserialize;
use std::path::Path;

#[derive(Debug, Deserialize)]
pub struct ClodDefinition {
    pub command: ClodCommand,
    pub process: Option<ClodProcess>,
    pub output: Option<ClodOutput>,
    pub adapters: Option<ClodAdapters>,
}

#[derive(Debug, Deserialize)]
pub struct ClodCommand {
    pub name: String,
    pub description: String,
    pub version: Option<String>,
    pub parameters: Vec<ClodParameter>,
}

#[derive(Debug, Deserialize)]
pub struct ClodParameter {
    pub name: String,
    pub description: String,
    pub required: bool,
    pub position: Option<u32>,
    pub flag: Option<String>,
}
// ... ClodProcess, ClodOutput, ClodAdapters structs
```

Implement conversion functions for each adapter target:
- `generate_claude(def: &ClodDefinition, out_dir: &Path) -> Result<()>`: Generate `.md` file with YAML frontmatter (name, description, parameters as YAML list)
- `generate_opencode(def: &ClodDefinition, out_dir: &Path) -> Result<()>`: Generate `.md` file with `$ARGUMENTS` substitution pattern
- `generate_gemini(def: &ClodDefinition, out_dir: &Path) -> Result<()>`: Generate `.toml` file with `[prompt]` section and `{{args}}` substitution
- `generate_copilot(def: &ClodDefinition, out_dir: &Path) -> Result<()>`: Generate `.md` skill file (Copilot uses skills, not commands)

Each generator should use a simple template approach -- construct the output string using format! macros. Templates are straightforward (10-30 lines each). Do NOT over-engineer with a template engine.

Add `generate_all(def: &ClodDefinition, out_dir: &Path) -> Result<()>` that calls all four generators.

Parse CLOD files using the `toml` crate (already in workspace).

**3. CLI subcommand (cli.rs, commands.rs, main.rs):**

Add `Clod` to the Commands enum:

```rust
/// CLOD format commands
#[command(subcommand)]
Clod(ClodCommand),

#[derive(Subcommand, Debug, Clone)]
pub enum ClodCliCommand {  // Use different name to avoid conflict with clod::ClodCommand
    /// Convert CLOD definition to adapter-specific files
    Convert {
        /// Path to CLOD definition file (.toml)
        #[arg(long)]
        input: String,
        /// Target adapter: claude, opencode, gemini, copilot, all
        #[arg(long)]
        target: String,
        /// Output directory
        #[arg(long)]
        out: String,
    },
    /// Validate a CLOD definition file
    Validate {
        /// Path to CLOD definition file (.toml)
        input: String,
    },
}
```

Implement `handle_clod_command`:
- `Convert`: Parse CLOD file, call appropriate generator(s), print generated file paths.
- `Validate`: Parse CLOD file, report any errors, print "Valid CLOD definition: <name> v<version>" on success.

Wire in main.rs.
  </action>
  <verify>
1. `test -f docs/adapters/clod-format.md` confirms spec exists
2. `grep "Cross-Language Operation Definition" docs/adapters/clod-format.md` shows title
3. `cargo build -p memory-daemon` compiles
4. `cargo clippy -p memory-daemon --all-targets --all-features -- -D warnings` passes
5. `cargo run -p memory-daemon -- clod --help` shows convert and validate subcommands
6. `cargo run -p memory-daemon -- clod validate --help` shows input argument
7. `cargo test -p memory-daemon` passes
  </verify>
  <done>
- [ ] docs/adapters/clod-format.md has complete CLOD specification with 2+ examples
- [ ] clod.rs module parses CLOD TOML and generates adapter-specific files
- [ ] Four generator functions: claude, opencode, gemini, copilot
- [ ] CLI supports `clod convert --input <file> --target <target> --out <dir>` and `clod validate <file>`
- [ ] cargo build and clippy pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Create cross-agent usage guide and adapter authoring guide</name>
  <files>
    docs/adapters/cross-agent-guide.md
    docs/adapters/authoring-guide.md
  </files>
  <action>
**1. Cross-agent usage guide (docs/adapters/cross-agent-guide.md):**

Create a comprehensive guide for users working with multiple agents. Structure:

```markdown
# Cross-Agent Usage Guide

## Overview
How to use agent-memory with multiple AI coding agents simultaneously.

## Supported Agents
Table comparing all four adapters (Claude Code, OpenCode, Gemini CLI, Copilot CLI):
| Feature | Claude Code | OpenCode | Gemini CLI | Copilot CLI |
|---------|-------------|----------|------------|-------------|
| Event Capture | hooks.yaml | plugin | settings.json | hooks.json |
| Commands | .md frontmatter | .md $ARGUMENTS | .toml | Skills |
| Skills | .claude/skills/ | .opencode/skill/ | .gemini/skills/ | .github/skills/ |
| Agent Tag | claude | opencode | gemini | copilot |

## Installation
Links to each adapter's README for installation instructions.

## Agent Discovery
### Listing Agents
`memory-daemon agents list` with example output.

### Agent Activity
`memory-daemon agents activity` with --agent, --from, --to, --bucket examples.

### Topics by Agent
`memory-daemon agents topics --agent <id>` with example output.

## Cross-Agent Queries
### Default: All Agents
Explain that queries without --agent flag return results from all agents.

### Filtered Queries
`memory-daemon retrieval route "query" --agent claude` examples for each command.

### Retrieval with Agent Context
Show how RetrievalResult includes agent field.

## Common Workflows
1. "What was I discussing in OpenCode last week?" -> agents activity + retrieval route
2. "Show me topics shared between Claude and Gemini" -> agents topics comparison
3. "Find all conversations about authentication" -> retrieval route (all agents)
```

**2. Adapter authoring guide (docs/adapters/authoring-guide.md):**

Create a developer guide for building new adapters. Structure:

```markdown
# Adapter Authoring Guide

## Overview
How to create a new agent-memory adapter for an AI coding agent.

## Architecture
Diagram/description of the adapter architecture:
- Hook/Event Capture -> memory-ingest -> RocksDB
- Skills/Commands -> memory-daemon CLI -> gRPC

## The AgentAdapter Trait
Reference `crates/memory-adapters/src/lib.rs`:
- `agent_name()` -> canonical lowercase agent identifier
- `detect()` -> detect if running in this agent's environment
- `config()` -> AdapterConfig with paths and settings
Document each method with examples.

## Event Capture
### Hook Script Pattern
- Receive events from agent's hook/plugin system
- Transform to memory-ingest JSON format
- Pipe to `memory-ingest` binary (backgrounded)
- Required fields: event_type, session_id, timestamp, agent

### Session ID
- Some agents provide session IDs (Claude, OpenCode)
- Others require synthesis (Gemini, Copilot via temp files)

### Fail-Open
- MUST never block the agent's UI
- Use trap ERR EXIT, background processes, timeout guards
- Exit 0 on ALL inputs including malformed

### Redaction
- Strip sensitive fields (api_key, token, secret, password, credential, authorization)
- Use jq walk() with version check (requires jq 1.6+)
- Fallback: del()-based redaction for jq < 1.6

### ANSI Stripping
- Strip CSI, OSC, SS2/SS3 sequences before JSON parsing
- Use perl (preferred) or sed fallback

## Skills
### Skill Format
- SKILL.md with YAML frontmatter
- Portable across Claude Code, OpenCode, Copilot (same format)
- Gemini embeds skill content differently

### Required Skills
- memory-query: Core retrieval with tier-aware routing
- retrieval-policy: Tier detection
- topic-graph: Topic exploration
- bm25-search: Keyword search
- vector-search: Semantic search

## Commands
### Command Format Differences
Table of format differences per agent.

### CLOD Conversion
Reference CLOD format for generating commands from a single definition.

## Agent Tagging
- Set `agent: "<name>"` in event payload (lowercase)
- Tag enables per-agent filtering in queries

## Config Precedence
Document the 5-level hierarchy:
1. CLI flags (highest)
2. Environment variables
3. Project config file
4. User/global config
5. Built-in defaults (lowest)

## Testing Your Adapter
- Use `MEMORY_INGEST_DRY_RUN=1` for testing without daemon
- Verify with `memory-daemon agents list` (your agent should appear)
- Check event capture with `memory-daemon query root` (navigate to recent events)

## Publishing
- Structure: `plugins/memory-<agent>-adapter/`
- Include README.md, .gitignore, and install skill
```
  </action>
  <verify>
1. `test -f docs/adapters/cross-agent-guide.md` confirms file exists
2. `test -f docs/adapters/authoring-guide.md` confirms file exists
3. `grep "Cross-Agent Usage Guide" docs/adapters/cross-agent-guide.md` shows title
4. `grep "Adapter Authoring Guide" docs/adapters/authoring-guide.md` shows title
5. `grep "AgentAdapter" docs/adapters/authoring-guide.md` references the trait
6. `grep "agents list" docs/adapters/cross-agent-guide.md` includes CLI examples
7. `grep "agents topics" docs/adapters/cross-agent-guide.md` includes topics command
8. `grep "CLOD" docs/adapters/authoring-guide.md` references CLOD format
9. `grep "Fail-Open\|fail-open\|fail.open" docs/adapters/authoring-guide.md` covers fail-open pattern
10. `grep "Redact\|redact" docs/adapters/authoring-guide.md` covers redaction
  </verify>
  <done>
- [ ] cross-agent-guide.md covers all four adapters, agent discovery commands, filtered queries, and common workflows
- [ ] authoring-guide.md covers AgentAdapter trait, event capture (hooks, session ID, fail-open, redaction), skills format, commands, agent tagging, config precedence, and testing
- [ ] Both documents are comprehensive but not bloated (500-800 lines each)
- [ ] All CLI commands referenced are accurate per current implementation
  </done>
</task>

<task type="auto">
  <name>Task 3: Update top-level documentation with cross-agent references</name>
  <files>
    docs/README.md
    docs/UPGRADING.md
  </files>
  <action>
**1. Update docs/README.md:**

Add/update sections to reference the cross-agent ecosystem:

- **Adapters section**: Add a table listing all four adapters with links to their READMEs and install instructions:
  ```markdown
  ## Supported Agents

  | Agent | Adapter | Install |
  |-------|---------|---------|
  | Claude Code | Built-in (hooks.yaml) | [Setup Guide](../plugins/memory-query-plugin/README.md) |
  | OpenCode | Plugin | [Setup Guide](../plugins/memory-opencode-plugin/README.md) |
  | Gemini CLI | Adapter | [Setup Guide](../plugins/memory-gemini-adapter/README.md) |
  | Copilot CLI | Adapter | [Setup Guide](../plugins/memory-copilot-adapter/README.md) |
  ```

- **Cross-Agent Discovery section**: Reference the cross-agent guide:
  ```markdown
  ## Cross-Agent Discovery

  When using multiple agents, you can discover which agents contributed memories:

  ```bash
  memory-daemon agents list
  memory-daemon agents activity --agent claude
  memory-daemon agents topics --agent opencode
  ```

  See the [Cross-Agent Usage Guide](adapters/cross-agent-guide.md) for details.
  ```

- **Documentation links section**: Add links to the new docs:
  ```markdown
  ## Documentation

  - [Cross-Agent Usage Guide](adapters/cross-agent-guide.md)
  - [Adapter Authoring Guide](adapters/authoring-guide.md)
  - [CLOD Format Specification](adapters/clod-format.md)
  ```

**2. Create/update docs/UPGRADING.md:**

If docs/UPGRADING.md doesn't exist, create it. Add a v2.1 section:

```markdown
# Upgrading

## v2.0 -> v2.1 (Multi-Agent Ecosystem)

### New Features
- **Multi-agent support**: Memories are now tagged by agent (claude, opencode, gemini, copilot)
- **Agent discovery**: `memory-daemon agents list|activity|topics` commands
- **Agent filtering**: `--agent <name>` flag on retrieval and teleport commands
- **Four adapters**: Claude Code, OpenCode, Gemini CLI, Copilot CLI
- **CLOD format**: Universal command definition for cross-adapter generation

### Breaking Changes
- None. All changes are backward-compatible. Existing data continues to work.

### Migration Steps
1. Update `memory-daemon` binary to v2.1
2. Install desired adapter(s) (see Supported Agents table in README)
3. Existing memories without agent tags are visible to all queries (no migration needed)

### New CLI Commands
- `memory-daemon agents list` - List contributing agents
- `memory-daemon agents activity` - Agent activity timeline
- `memory-daemon agents topics` - Agent's top topics
- `memory-daemon clod convert` - Convert CLOD to adapter files
- `memory-daemon clod validate` - Validate CLOD definition

### New Documentation
- [Cross-Agent Usage Guide](adapters/cross-agent-guide.md)
- [Adapter Authoring Guide](adapters/authoring-guide.md)
- [CLOD Format Specification](adapters/clod-format.md)
```
  </action>
  <verify>
1. `grep "Supported Agents\|supported agents" docs/README.md` confirms adapter table
2. `grep "Cross-Agent" docs/README.md` confirms cross-agent section
3. `grep "authoring-guide\|Authoring Guide" docs/README.md` confirms link
4. `grep "clod-format\|CLOD" docs/README.md` confirms link
5. `test -f docs/UPGRADING.md` confirms file exists
6. `grep "v2.1\|2.1" docs/UPGRADING.md` confirms v2.1 section
7. `grep "agents list" docs/UPGRADING.md` confirms new command documented
8. `grep "clod convert" docs/UPGRADING.md` confirms CLOD command documented
9. `cargo clippy --workspace --all-targets --all-features -- -D warnings` passes (no code changes, but ensure nothing breaks)
10. `RUSTDOCFLAGS="-D warnings" cargo doc --no-deps --workspace --all-features` passes
  </verify>
  <done>
- [ ] docs/README.md has Supported Agents table with all four adapters and links
- [ ] docs/README.md has Cross-Agent Discovery section with CLI examples
- [ ] docs/README.md has Documentation links section pointing to all three new docs
- [ ] docs/UPGRADING.md exists with v2.1 section covering new features, migration, new commands
- [ ] All documentation links are valid relative paths
- [ ] Full workspace clippy and doc build pass
  </done>
</task>

</tasks>

<verification>
- CLOD spec document defines the format with examples
- CLOD converter CLI generates adapter-specific files from CLOD definitions
- Cross-agent guide covers all four adapters, agent discovery, filtered queries
- Authoring guide covers AgentAdapter trait, event capture, skills, commands, testing
- Top-level docs updated with adapter table, cross-agent section, documentation links
- UPGRADING.md documents v2.1 changes and migration path
- Full workspace builds, tests, clippy, and doc pass
</verification>

<success_criteria>
- `memory-daemon clod convert --input example.toml --target all --out /tmp/test` generates 4 adapter files
- `memory-daemon clod validate example.toml` validates a CLOD definition
- docs/adapters/ contains clod-format.md, cross-agent-guide.md, authoring-guide.md
- docs/README.md references all four adapters and new documentation
- docs/UPGRADING.md covers v2.0 -> v2.1 migration
- All documentation is accurate per current codebase
</success_criteria>

<output>
After completion, create `.planning/phases/23-cross-agent-discovery/23-03-SUMMARY.md`
</output>

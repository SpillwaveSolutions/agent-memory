---
phase: 23-cross-agent-discovery
plan: 02
type: execute
wave: 2
depends_on:
  - 23-01
files_modified:
  - proto/memory.proto
  - crates/memory-topics/src/lib.rs
  - crates/memory-topics/src/importance.rs
  - crates/memory-service/src/topics.rs
  - crates/memory-daemon/src/commands.rs
  - crates/memory-daemon/src/cli.rs
autonomous: true

must_haves:
  truths:
    - "Topic metadata includes contributing_agents aggregated from grips/nodes"
    - "Topic RPCs support agent filter (new GetTopicsByAgent or include_contributors flag) without breaking existing callers"
    - "CLI command `agents topics --agent <id> [--limit N]` returns top topics with importance scores"
    - "Agent-filtered topic calls return only contributions from the specified agent"
  nice_to_haves:
    - "Include top documents/grips per topic when agent-filtered"
    - "Expose contributing agent list on topic responses when requested"

deliverables:
  - Agent-aware topic aggregation and RPC
  - CLI surface for topics-by-agent
  - Tests covering agent-filtered topic queries and contributor lists

risks:
  - "Performance of per-agent topic aggregation; mitigate with existing topic index and batched queries"
  - "Backward compatibility for Topic RPCs; ensure defaults match current behavior"
---

<objective>
Add agent-aware topic queries: extend GetTopTopics to support agent filtering, implement the topic-agent linking logic (topic -> TopicLink -> TocNode -> contributing_agents), and add a CLI `agents topics` command. This completes the cross-agent topic linking requirement (R4.3.3).

Purpose: Enable users to see which topics a specific agent has contributed to, with importance scores, enabling cross-agent knowledge discovery.

Output: Agent filter on GetTopTopics RPC, topic-agent aggregation logic in memory-topics, `agents topics --agent <id>` CLI command.
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-cross-agent-discovery/23-RESEARCH.md
@.planning/phases/23-cross-agent-discovery/23-01-SUMMARY.md
@proto/memory.proto
@crates/memory-topics/src/types.rs
@crates/memory-topics/src/storage.rs
@crates/memory-topics/src/lib.rs
@crates/memory-topics/src/importance.rs
@crates/memory-service/src/topics.rs
@crates/memory-daemon/src/cli.rs
@crates/memory-daemon/src/commands.rs
@crates/memory-storage/src/db.rs
@crates/memory-types/src/toc.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add agent filter to GetTopTopics RPC and implement topic-agent aggregation</name>
  <files>
    proto/memory.proto
    crates/memory-topics/src/lib.rs
    crates/memory-topics/src/storage.rs
    crates/memory-service/src/topics.rs
  </files>
  <action>
**1. Proto change (proto/memory.proto):**

Add an optional agent filter field to the existing `GetTopTopicsRequest` message:

```protobuf
message GetTopTopicsRequest {
    // Maximum results to return (default: 10)
    uint32 limit = 1;
    // Look back window in days for importance calculation (default: 30)
    uint32 days = 2;
    // Phase 23: Filter topics by contributing agent (optional, omit for all agents)
    optional string agent_filter = 201;
}
```

Use field number 201 (>200 per research recommendation for Phase 23 additions) to avoid potential conflicts with future fields in the 3-199 range. The `optional` keyword ensures backward compatibility -- existing callers that omit this field get current behavior (all topics).

**2. Topic-agent aggregation logic (crates/memory-topics/src/storage.rs or a new helper):**

Add a public function to TopicStorage or as a free function:

`get_topics_for_agent(topic_storage: &TopicStorage, main_storage: &Storage, agent_id: &str, limit: usize) -> Result<Vec<(Topic, f32)>>`:

The algorithm uses the indirect path: Topic -> TopicLink -> TocNode -> contributing_agents:

1. Get all topics from topic_storage (using existing `get_all_topics()` or iterate).
2. For each topic, get its TopicLinks via `topic_storage.get_links_for_topic(&topic.topic_id)`.
3. For each TopicLink, load the linked TocNode from main_storage via `get_toc_nodes_by_level` or by node_id lookup.
4. Check if `node.contributing_agents` contains the target `agent_id`.
5. If any linked node has the agent, include the topic. Calculate an agent-specific relevance score as the max relevance from matching links.
6. Sort by importance_score * agent_relevance (combined score), take top `limit`.
7. Return `Vec<(Topic, f32)>` where f32 is the agent-specific relevance.

Performance note: The topic graph is typically small (<1000 topics with <10 links each). This is bounded by the topic count, not event count. If performance becomes an issue (>100ms), a direct topic-to-agent index can be added later.

**3. Wire agent filter in topic service (crates/memory-service/src/topics.rs):**

Update the handler for `GetTopTopics` to check the new `agent_filter` field:
- If `agent_filter` is None/empty: use existing behavior (return all top topics by importance).
- If `agent_filter` is Some(agent_id): call the new `get_topics_for_agent` function and return filtered results.

Ensure the response format is the same `GetTopTopicsResponse` with `repeated Topic topics`. The proto `Topic` message already has all needed fields. If agent relevance score needs to be returned, add an optional field to the proto Topic message or use the existing `importance_score` field multiplied by agent relevance.
  </action>
  <verify>
1. `cargo build --workspace` compiles without errors
2. `cargo clippy --workspace --all-targets --all-features -- -D warnings` passes
3. `grep "agent_filter" proto/memory.proto` shows the new field
4. `grep "get_topics_for_agent\|topics_for_agent" crates/memory-topics/src/` confirms the new function
5. `cargo test -p memory-topics` passes
6. `cargo test -p memory-service` passes
  </verify>
  <done>
- [ ] GetTopTopicsRequest has optional agent_filter field (number 201) in proto
- [ ] Topic-agent aggregation function implemented using TopicLink -> TocNode -> contributing_agents path
- [ ] GetTopTopics handler filters by agent when agent_filter is present
- [ ] Existing behavior unchanged when agent_filter is absent
- [ ] Builds and passes clippy
  </done>
</task>

<task type="auto">
  <name>Task 2: Add `agents topics` CLI command</name>
  <files>
    crates/memory-daemon/src/cli.rs
    crates/memory-daemon/src/commands.rs
  </files>
  <action>
**1. CLI definition (crates/memory-daemon/src/cli.rs):**

Add a `Topics` variant to the existing `AgentsCommand` enum (created in Plan 23-01):

```rust
#[derive(Subcommand, Debug, Clone)]
pub enum AgentsCommand {
    /// List all contributing agents with summary stats
    List { ... },        // From Plan 23-01
    /// Show agent activity timeline
    Activity { ... },    // From Plan 23-01
    /// Show top topics for an agent
    Topics {
        /// Agent ID to show topics for
        #[arg(long, short = 'a')]
        agent: String,
        /// Maximum number of topics to return
        #[arg(long, short = 'n', default_value = "10")]
        limit: u32,
        /// gRPC server address
        #[arg(long, default_value = "http://[::1]:50051")]
        addr: String,
    },
}
```

**2. Command handler (crates/memory-daemon/src/commands.rs):**

Add the `Topics` arm to `handle_agents_command`:

```rust
AgentsCommand::Topics { agent, limit, addr } => {
    agents_topics(&agent, limit, &addr).await
},
```

Implement `agents_topics`:
- Connect to gRPC server using existing client pattern.
- Call `GetTopTopics` RPC with `agent_filter = Some(agent)` and the specified limit.
- Display results as a formatted list:
  ```
  Top Topics for agent "claude":
    #  TOPIC                    IMPORTANCE  KEYWORDS
    1  Memory Retrieval          0.87       retrieval, search, teleport
    2  Agent Configuration       0.72       config, adapter, hooks
    3  Topic Graph Analysis      0.65       topics, graph, clustering
    ...
  ```
- Use the existing println! formatting style consistent with other CLI commands.
- Handle empty results: print "No topics found for agent '<agent_id>'" if the response is empty.

**3. Update handle_agents_command match arm** to include the Topics variant.
  </action>
  <verify>
1. `cargo build -p memory-daemon` compiles without errors
2. `cargo clippy -p memory-daemon --all-targets --all-features -- -D warnings` passes
3. `cargo run -p memory-daemon -- agents topics --help` shows --agent, --limit, --addr flags
4. `cargo test -p memory-daemon` passes all tests
  </verify>
  <done>
- [ ] Topics variant added to AgentsCommand enum in cli.rs
- [ ] agents_topics function implemented in commands.rs with formatted output
- [ ] Empty result handling prints informative message
- [ ] handle_agents_command dispatches Topics variant correctly
- [ ] cargo build and clippy pass
  </done>
</task>

<task type="auto">
  <name>Task 3: Add tests for agent-filtered topic queries</name>
  <files>
    crates/memory-topics/src/storage.rs
    crates/memory-service/src/topics.rs
  </files>
  <action>
**1. Topic-agent aggregation tests (crates/memory-topics/src/storage.rs or relevant test module):**

Add tests in a `#[cfg(test)]` block:

- `test_get_topics_for_agent_returns_matching_topics`: Create a TopicStorage with 3 topics. Create TopicLinks connecting topic1 and topic2 to a TocNode that has contributing_agents = ["claude"]. Create a TopicLink connecting topic3 to a TocNode with contributing_agents = ["opencode"]. Call `get_topics_for_agent("claude", 10)`. Verify topic1 and topic2 are returned, topic3 is not.

- `test_get_topics_for_agent_empty_when_no_match`: Create topics linked to nodes with contributing_agents = ["opencode"]. Call `get_topics_for_agent("claude", 10)`. Verify empty result.

- `test_get_topics_for_agent_respects_limit`: Create 5 topics all linked to a "claude" node. Call `get_topics_for_agent("claude", 3)`. Verify only 3 results returned, sorted by importance.

- `test_get_topics_for_agent_sorted_by_importance`: Create 3 topics with different importance scores, all linked to agent "claude". Verify returned in descending importance order.

**2. Integration-level test (crates/memory-service/src/topics.rs):**

If the topics service has existing integration tests, add:

- `test_get_top_topics_without_agent_filter`: Verify existing behavior unchanged -- call GetTopTopics without agent_filter, confirm all topics returned as before.

- `test_get_top_topics_with_agent_filter`: Call GetTopTopics with agent_filter set, verify only topics from matching agent's nodes are returned.

Follow the existing test patterns in the crate. Use the same test helper functions (e.g., `create_test_storage`, `create_test_topic_storage`) that exist in the codebase.
  </action>
  <verify>
1. `cargo test -p memory-topics -- topics_for_agent` passes new topic-agent tests
2. `cargo test -p memory-service -- topics` passes including integration tests
3. `cargo test --workspace --all-features` passes all tests
4. `cargo clippy --workspace --all-targets --all-features -- -D warnings` passes
5. `RUSTDOCFLAGS="-D warnings" cargo doc --no-deps --workspace --all-features` passes
  </verify>
  <done>
- [ ] 4+ unit tests for topic-agent aggregation covering: matching, no match, limit, sort order
- [ ] Integration tests verify backward compatibility (no filter = all topics)
- [ ] Integration test verifies agent filter returns correct subset
- [ ] Full workspace test and clippy pass
- [ ] Documentation builds without warnings
  </done>
</task>

</tasks>

<verification>
- GetTopTopicsRequest accepts optional agent_filter field (proto backward compatible)
- Topic-agent linking uses TopicLink -> TocNode -> contributing_agents path (no new storage)
- CLI `agents topics --agent <id>` displays formatted topic list with importance scores
- Existing topic queries unaffected when agent_filter is absent
- All tests pass including new agent-topic tests
</verification>

<success_criteria>
- `memory-daemon agents topics --agent claude` returns topics with importance scores
- GetTopTopics without agent_filter returns same results as before
- 6+ passing tests for topic-agent aggregation and filtering
- Proto backward compatibility maintained
- Full workspace test + clippy + doc pass
</success_criteria>

<output>
After completion, create `.planning/phases/23-cross-agent-discovery/23-02-SUMMARY.md`
</output>

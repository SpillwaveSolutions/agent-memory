---
phase: 23-cross-agent-discovery
plan: 01
type: execute
wave: 1
depends_on:
  - 22-copilot-cli-adapter
files_modified:
  - proto/memory.proto
  - crates/memory-service/src/retrieval.rs
  - crates/memory-service/src/lib.rs
  - crates/memory-daemon/src/cli.rs
  - crates/memory-daemon/src/commands.rs
  - docs/README.md
autonomous: true

must_haves:
  truths:
    - "ListAgents RPC returns agent_id, event_count, session_count, first_seen, last_seen (UTC ms)"
    - "GetAgentActivity RPC returns bucketed counts (day|week), filtered by agent_id and optional time range"
    - "CLI supports `agents list` and `agents activity --agent <id> [--from --to --bucket]` with human-readable output"
    - "Agent counts derived from existing Event.agent and TocNode.contributing_agents; no storage migration required"
    - "Defaults preserve current behavior when agent filters are absent"
  nice_to_haves:
    - "CLI supports JSON output flag for scripting"
    - "Pagination support if agent count exceeds page size"

deliverables:
  - ListAgents and GetAgentActivity RPCs with tests
  - CLI commands under `memory-daemon agents` (list, activity) with snapshot tests
  - README/USAGE snippet showing agent listing/activity usage

risks:
  - "Large datasets may require pagination; mitigate with sensible limits and streaming iterator"
  - "Timezone handling in CLI display; standardize on UTC human-readable formatting"
---

<objective>
Add ListAgents and GetAgentActivity RPCs to memory-daemon, with supporting service logic and CLI commands. Agents are discovered by aggregating TocNode.contributing_agents (O(k) over TOC nodes, not O(n) event scan). Activity uses time-bounded event scans with chrono bucketing.

Purpose: Enable users to see which AI agents have contributed memories and when they were active, completing the cross-agent discovery capability (R4.3.1, R4.3.2).

Output: Two new RPCs in proto/memory.proto, aggregation logic in memory-service, `agents list` and `agents activity` CLI commands in memory-daemon.
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-cross-agent-discovery/23-RESEARCH.md
@proto/memory.proto
@crates/memory-daemon/src/cli.rs
@crates/memory-daemon/src/commands.rs
@crates/memory-service/src/retrieval.rs
@crates/memory-indexing/src/rebuild.rs
@crates/memory-types/src/toc.rs
@crates/memory-storage/src/db.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ListAgents and GetAgentActivity RPCs to proto and implement service logic</name>
  <files>
    proto/memory.proto
    crates/memory-service/src/agents.rs
    crates/memory-service/src/lib.rs
  </files>
  <action>
**1. Proto additions (proto/memory.proto):**

Add two new RPCs to the `MemoryService` service block after the RouteQuery RPC (line ~104):

```protobuf
// ===== Agent Discovery RPCs (Phase 23 - R4.3.1, R4.3.2) =====

// List all contributing agents with summary statistics
rpc ListAgents(ListAgentsRequest) returns (ListAgentsResponse);

// Get agent activity bucketed by time period
rpc GetAgentActivity(GetAgentActivityRequest) returns (GetAgentActivityResponse);
```

Add message definitions AFTER the existing RouteQuery response messages. Use field numbers starting from 1 within new messages (these are new top-level messages, no conflict risk):

```protobuf
// ===== Agent Discovery Messages (Phase 23) =====

message AgentSummary {
    string agent_id = 1;
    uint64 event_count = 2;
    uint64 session_count = 3;
    int64 first_seen_ms = 4;
    int64 last_seen_ms = 5;
}

message ListAgentsRequest {}

message ListAgentsResponse {
    repeated AgentSummary agents = 1;
}

message GetAgentActivityRequest {
    optional string agent_id = 1;
    optional int64 from_ms = 2;
    optional int64 to_ms = 3;
    string bucket = 4; // "day" or "week"
}

message ActivityBucket {
    int64 start_ms = 1;
    int64 end_ms = 2;
    uint64 event_count = 3;
    string agent_id = 4;
}

message GetAgentActivityResponse {
    repeated ActivityBucket buckets = 1;
}
```

**2. Service module (crates/memory-service/src/agents.rs):**

Create a new `agents.rs` module in memory-service with two public functions:

`list_agents(storage: &Storage) -> Result<Vec<AgentSummary>>`:
- Use `iter_all_toc_nodes()` from `memory-indexing` crate (already public, iterates all levels via `get_toc_nodes_by_level`). This is O(k) where k = TOC nodes (hundreds), NOT O(n) events.
- Build a `HashMap<String, AgentSummary>` from TocNode.contributing_agents.
- For each node, update first_seen_ms (min of node start_time) and last_seen_ms (max of node end_time).
- For event_count and session_count: iterate events from `storage.get_events_in_range()` only if needed, OR set approximate counts from node metadata. Recommendation: set event_count by counting events in the TOC node's time range that match the agent, and session_count by counting unique session_ids. Since this could be expensive for large datasets, add a `max_events_scan` limit (default 10000) and note approximate counts when limit is hit.
- Alternative simpler approach: set event_count = number of TOC nodes the agent appears in (as a proxy), session_count = 0 (not available from TOC alone). Document that these are approximate. Exact counts require event scanning which can be deferred.
- Sort results by last_seen_ms descending.

`get_agent_activity(storage: &Storage, agent_id: Option<&str>, from_ms: Option<i64>, to_ms: Option<i64>, bucket: &str) -> Result<Vec<ActivityBucket>>`:
- Default from_ms to 30 days ago, to_ms to now.
- Use `storage.get_events_in_range(from_ms, to_ms)` to get events in the time window.
- Parse each event value as JSON to extract the `agent` field (use `serde_json::from_slice` with Event struct from memory-types).
- If agent_id filter provided, skip events that don't match.
- Bucket events by day or week using `chrono::NaiveDate` truncation:
  - Day: truncate to date
  - Week: truncate to ISO week start (Monday)
- Return `Vec<ActivityBucket>` sorted by start_ms ascending.
- Use `chrono::DateTime<Utc>::from_timestamp_millis()` for timestamp conversion.

**3. Register module (crates/memory-service/src/lib.rs):**

Add `pub mod agents;` to the module declarations in lib.rs.

**4. Wire RPCs in gRPC service implementation:**

In the existing gRPC service implementation file (likely `crates/memory-service/src/grpc.rs` or similar), add handler methods for `list_agents` and `get_agent_activity` that call the new service functions. Follow the pattern used by existing RPC handlers (e.g., `get_top_topics`).
  </action>
  <verify>
1. `cargo build -p memory-service` compiles without errors
2. `cargo clippy -p memory-service --all-targets --all-features -- -D warnings` passes
3. `grep "rpc ListAgents" proto/memory.proto` returns the new RPC
4. `grep "rpc GetAgentActivity" proto/memory.proto` returns the new RPC
5. `grep "pub mod agents" crates/memory-service/src/lib.rs` confirms module registration
6. `cargo test -p memory-service` passes all tests
  </verify>
  <done>
- [ ] ListAgents and GetAgentActivity RPCs defined in proto/memory.proto with proper messages
- [ ] agents.rs module implements list_agents using TocNode.contributing_agents aggregation (O(k))
- [ ] agents.rs module implements get_agent_activity with time-bounded event scans and chrono bucketing
- [ ] Module registered in memory-service lib.rs
- [ ] gRPC handlers wired for both RPCs
- [ ] cargo build and clippy pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Agents CLI subcommand group to memory-daemon</name>
  <files>
    crates/memory-daemon/src/cli.rs
    crates/memory-daemon/src/commands.rs
    crates/memory-daemon/src/main.rs
  </files>
  <action>
**1. CLI definitions (crates/memory-daemon/src/cli.rs):**

Add `AgentsCommand` enum following the existing `TopicsCommand` pattern:

```rust
/// Agent discovery commands
#[command(subcommand)]
Agents(AgentsCommand),
```

Add to the `Commands` enum. Then define the subcommand enum:

```rust
#[derive(Subcommand, Debug, Clone)]
pub enum AgentsCommand {
    /// List all contributing agents with summary stats
    List {
        /// gRPC server address
        #[arg(long, default_value = "http://[::1]:50051")]
        addr: String,
    },
    /// Show agent activity timeline
    Activity {
        /// Agent ID to show activity for (all agents if omitted)
        #[arg(long, short = 'a')]
        agent: Option<String>,
        /// Start time (YYYY-MM-DD or Unix ms)
        #[arg(long)]
        from: Option<String>,
        /// End time (YYYY-MM-DD or Unix ms)
        #[arg(long)]
        to: Option<String>,
        /// Bucket granularity: day, week
        #[arg(long, default_value = "day")]
        bucket: String,
        /// gRPC server address
        #[arg(long, default_value = "http://[::1]:50051")]
        addr: String,
    },
}
```

**2. Command handlers (crates/memory-daemon/src/commands.rs):**

Add `handle_agents_command` following the `handle_topics_command` pattern:

```rust
pub async fn handle_agents_command(cmd: AgentsCommand) -> Result<()> {
    match cmd {
        AgentsCommand::List { addr } => agents_list(&addr).await,
        AgentsCommand::Activity { agent, from, to, bucket, addr } => {
            agents_activity(agent.as_deref(), from.as_deref(), to.as_deref(), &bucket, &addr).await
        },
    }
}
```

Implement `agents_list`:
- Connect to gRPC server using existing client pattern
- Call ListAgents RPC
- Display results as a formatted table using println! (match existing CLI style):
  ```
  Contributing Agents:
    AGENT         FIRST SEEN              LAST SEEN               NODES
    claude        2026-01-15 08:30 UTC    2026-02-10 14:22 UTC    47
    opencode      2026-02-01 10:00 UTC    2026-02-09 16:45 UTC    23
    gemini        2026-02-05 09:15 UTC    2026-02-10 11:30 UTC    12
    copilot       2026-02-08 13:00 UTC    2026-02-10 15:00 UTC    8
  ```
- Format timestamps as human-readable UTC (chrono formatting)

Implement `agents_activity`:
- Parse --from/--to: if matches YYYY-MM-DD, convert to epoch ms via chrono; if numeric, use as-is
- Call GetAgentActivity RPC
- Display bucketed results:
  ```
  Agent Activity (day buckets):
    DATE          AGENT       EVENTS
    2026-02-08    claude      42
    2026-02-08    opencode    15
    2026-02-09    claude      38
    2026-02-10    claude      27
    2026-02-10    copilot     8
  ```

**3. Wire in main.rs:**

Add the `Commands::Agents(cmd)` arm to the match statement, calling `handle_agents_command(cmd).await?`.
  </action>
  <verify>
1. `cargo build -p memory-daemon` compiles without errors
2. `cargo clippy -p memory-daemon --all-targets --all-features -- -D warnings` passes
3. `cargo run -p memory-daemon -- agents --help` shows list and activity subcommands
4. `cargo run -p memory-daemon -- agents list --help` shows --addr flag
5. `cargo run -p memory-daemon -- agents activity --help` shows --agent, --from, --to, --bucket, --addr flags
6. `cargo test -p memory-daemon` passes all tests
  </verify>
  <done>
- [ ] AgentsCommand enum with List and Activity variants in cli.rs
- [ ] handle_agents_command dispatches to agents_list and agents_activity in commands.rs
- [ ] agents_list displays formatted table with agent_id, first_seen, last_seen, node count
- [ ] agents_activity displays bucketed event counts with date, agent, events columns
- [ ] --from/--to accept both YYYY-MM-DD and epoch ms formats
- [ ] Command wired in main.rs
- [ ] cargo build and clippy pass
  </done>
</task>

<task type="auto">
  <name>Task 3: Add tests for agent discovery and update documentation</name>
  <files>
    crates/memory-service/src/agents.rs
    docs/README.md
  </files>
  <action>
**1. Unit tests (crates/memory-service/src/agents.rs):**

Add a `#[cfg(test)] mod tests` section at the bottom of agents.rs:

- `test_list_agents_empty`: Create empty storage, verify list_agents returns empty vec.
- `test_list_agents_aggregates_from_toc_nodes`: Create test storage with TocNodes that have contributing_agents set (e.g., node1 has ["claude", "opencode"], node2 has ["claude"]). Verify list_agents returns 2 agents, claude appears with first_seen from node1.start_time and last_seen from max of both nodes.
- `test_get_agent_activity_day_buckets`: Create events with known timestamps and agent fields spanning 3 days. Call get_agent_activity with bucket="day". Verify correct number of buckets with expected event counts.
- `test_get_agent_activity_week_buckets`: Similar to above but with bucket="week" spanning 2+ weeks.
- `test_get_agent_activity_filtered_by_agent`: Create events from multiple agents, filter by one agent. Verify only that agent's events appear in buckets.
- `test_get_agent_activity_time_range`: Create events, filter with from_ms/to_ms. Verify only events in range are counted.

Follow the existing test patterns in memory-service (use `create_test_storage()` helper if available, or construct test data manually).

**2. Documentation (docs/README.md):**

Add an "Agent Discovery" section to the existing docs/README.md:

```markdown
### Agent Discovery

List all agents that have contributed memories:

```bash
memory-daemon agents list
```

View agent activity timeline:

```bash
# Activity for all agents (last 30 days, daily buckets)
memory-daemon agents activity

# Activity for a specific agent
memory-daemon agents activity --agent claude

# Activity with time range
memory-daemon agents activity --agent opencode --from 2026-02-01 --to 2026-02-10

# Weekly buckets
memory-daemon agents activity --bucket week
```
```

Keep the documentation concise -- it's a usage snippet, not a full guide (that comes in Plan 03).
  </action>
  <verify>
1. `cargo test -p memory-service -- agents` runs and passes all agent tests
2. `cargo test --workspace --all-features` passes all tests
3. `cargo clippy --workspace --all-targets --all-features -- -D warnings` passes
4. `grep "Agent Discovery" docs/README.md` confirms section exists
5. `grep "agents list" docs/README.md` confirms CLI example
6. `grep "agents activity" docs/README.md` confirms CLI example
  </verify>
  <done>
- [ ] 6+ unit tests in agents.rs covering: empty storage, TOC aggregation, day/week buckets, agent filter, time range
- [ ] All tests pass
- [ ] docs/README.md has Agent Discovery section with list and activity examples
- [ ] Full workspace cargo test and clippy pass
  </done>
</task>

</tasks>

<verification>
- ListAgents RPC aggregates agents from TocNode.contributing_agents (O(k) not O(n))
- GetAgentActivity RPC uses time-bounded event scans with chrono bucketing
- CLI `agents list` shows formatted agent summary table
- CLI `agents activity` supports --agent, --from, --to, --bucket flags
- Proto changes are backward-compatible (new messages only, no existing field changes)
- All tests pass including new agent-specific tests
- docs/README.md updated with Agent Discovery usage examples
</verification>

<success_criteria>
- `memory-daemon agents list` returns contributing agents with first/last seen timestamps
- `memory-daemon agents activity --agent claude --bucket day` shows daily event counts
- 6+ passing tests for agent aggregation and activity bucketing
- No existing tests broken
- Documentation includes both commands with examples
</success_criteria>

<output>
After completion, create `.planning/phases/23-cross-agent-discovery/23-01-SUMMARY.md`
</output>

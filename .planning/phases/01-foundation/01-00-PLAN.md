---
phase: 01-foundation
plan: 00
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - crates/memory-types/Cargo.toml
  - crates/memory-types/src/lib.rs
  - crates/memory-storage/Cargo.toml
  - crates/memory-storage/src/lib.rs
  - crates/memory-service/Cargo.toml
  - crates/memory-service/src/lib.rs
  - crates/memory-daemon/Cargo.toml
  - crates/memory-daemon/src/main.rs
  - proto/memory.proto
  - docs/README.md
  - .gitignore
autonomous: true

must_haves:
  truths:
    - "Workspace compiles with `cargo build`"
    - "Four crates exist: memory-types, memory-storage, memory-service, memory-daemon"
    - "Proto file exists with service placeholder"
    - "Project documentation explains purpose and structure"
  artifacts:
    - path: "Cargo.toml"
      provides: "Virtual manifest workspace definition"
      contains: "[workspace]"
    - path: "crates/memory-types/src/lib.rs"
      provides: "Types crate entry point"
    - path: "crates/memory-storage/src/lib.rs"
      provides: "Storage crate entry point"
    - path: "crates/memory-service/src/lib.rs"
      provides: "Service crate entry point"
    - path: "crates/memory-daemon/src/main.rs"
      provides: "Daemon binary entry point"
    - path: "proto/memory.proto"
      provides: "gRPC service definition placeholder"
    - path: "docs/README.md"
      provides: "Project documentation"
  key_links:
    - from: "crates/memory-daemon/Cargo.toml"
      to: "crates/memory-service"
      via: "workspace dependency"
      pattern: 'memory-service.*path'
    - from: "crates/memory-service/Cargo.toml"
      to: "crates/memory-storage"
      via: "workspace dependency"
      pattern: 'memory-storage.*path'
---

<objective>
Scaffold the Rust workspace structure with four crates, proto directory, and project documentation.

Purpose: Establish the foundational project structure so subsequent plans can add implementation to the correct locations without reorganization.
Output: Compiling workspace with placeholder crates, proto file, and docs/README.md
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create workspace root and crate scaffolding</name>
  <files>
    - Cargo.toml
    - crates/memory-types/Cargo.toml
    - crates/memory-types/src/lib.rs
    - crates/memory-storage/Cargo.toml
    - crates/memory-storage/src/lib.rs
    - crates/memory-service/Cargo.toml
    - crates/memory-service/src/lib.rs
    - crates/memory-service/build.rs
    - crates/memory-daemon/Cargo.toml
    - crates/memory-daemon/src/main.rs
    - proto/memory.proto
    - .gitignore
  </files>
  <action>
Create a virtual manifest workspace at the project root:

**Cargo.toml (workspace root):**
```toml
[workspace]
resolver = "2"
members = [
    "crates/memory-types",
    "crates/memory-storage",
    "crates/memory-service",
    "crates/memory-daemon",
]

[workspace.package]
version = "0.1.0"
edition = "2021"
rust-version = "1.82"
license = "MIT"

[workspace.dependencies]
# Core
rocksdb = { version = "0.24", features = ["multi-threaded-cf", "zstd"] }
tonic = "0.14"
prost = "0.14"
tonic-health = "0.14"
tonic-reflection = "0.14"
config = "0.15"
clap = { version = "4", features = ["derive"] }

# Supporting
ulid = { version = "1.2", features = ["serde"] }
thiserror = "2.0"
anyhow = "1.0"
tracing = "0.1"
tracing-subscriber = { version = "0.3", features = ["env-filter", "json"] }
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
chrono = { version = "0.4", features = ["serde"] }
tokio = { version = "1", features = ["full"] }

# Build dependencies
tonic-build = "0.14"
prost-build = "0.14"

# Internal crates
memory-types = { path = "crates/memory-types" }
memory-storage = { path = "crates/memory-storage" }
memory-service = { path = "crates/memory-service" }
```

**crates/memory-types/Cargo.toml:**
```toml
[package]
name = "memory-types"
version.workspace = true
edition.workspace = true

[dependencies]
serde = { workspace = true }
chrono = { workspace = true }
ulid = { workspace = true }
thiserror = { workspace = true }
```

**crates/memory-types/src/lib.rs:**
```rust
//! Shared types for agent-memory system.
//!
//! This crate defines core data structures used across the memory system:
//! - Event types for conversation storage
//! - Configuration structures
//! - Error types

pub mod error;

// Re-export main types at crate root (to be added in Plan 01-02)
```

Create `crates/memory-types/src/error.rs`:
```rust
//! Error types for the memory system.

use thiserror::Error;

#[derive(Error, Debug)]
pub enum MemoryError {
    #[error("Storage error: {0}")]
    Storage(String),

    #[error("Configuration error: {0}")]
    Config(String),

    #[error("Serialization error: {0}")]
    Serialization(String),
}
```

**crates/memory-storage/Cargo.toml:**
```toml
[package]
name = "memory-storage"
version.workspace = true
edition.workspace = true

[dependencies]
memory-types = { workspace = true }
rocksdb = { workspace = true }
serde = { workspace = true }
serde_json = { workspace = true }
thiserror = { workspace = true }
tracing = { workspace = true }
```

**crates/memory-storage/src/lib.rs:**
```rust
//! Storage layer for agent-memory system.
//!
//! Provides RocksDB-backed storage with:
//! - Column family isolation for different data types
//! - Time-prefixed keys for efficient range scans
//! - Atomic writes via WriteBatch

// To be implemented in Plan 01-01
```

**crates/memory-service/Cargo.toml:**
```toml
[package]
name = "memory-service"
version.workspace = true
edition.workspace = true

[dependencies]
memory-types = { workspace = true }
memory-storage = { workspace = true }
tonic = { workspace = true }
prost = { workspace = true }
tonic-health = { workspace = true }
tonic-reflection = { workspace = true }
tokio = { workspace = true }
tracing = { workspace = true }

[build-dependencies]
tonic-build = { workspace = true }
prost-build = { workspace = true }
```

**crates/memory-service/build.rs:**
```rust
use std::{env, path::PathBuf};

fn main() -> Result<(), Box<dyn std::error::Error>> {
    let out_dir = PathBuf::from(env::var("OUT_DIR").unwrap());

    tonic_build::configure()
        .file_descriptor_set_path(out_dir.join("memory_descriptor.bin"))
        .compile_protos(&["../../proto/memory.proto"], &["../../proto"])?;

    Ok(())
}
```

**crates/memory-service/src/lib.rs:**
```rust
//! gRPC service implementation for agent-memory.
//!
//! Provides:
//! - IngestEvent RPC for event ingestion
//! - Health check endpoint
//! - Reflection endpoint for debugging

pub mod pb {
    tonic::include_proto!("memory");

    pub const FILE_DESCRIPTOR_SET: &[u8] =
        tonic::include_file_descriptor_set!("memory_descriptor");
}

// Server implementation to be added in Plan 01-03
```

**crates/memory-daemon/Cargo.toml:**
```toml
[package]
name = "memory-daemon"
version.workspace = true
edition.workspace = true

[[bin]]
name = "memory-daemon"
path = "src/main.rs"

[dependencies]
memory-types = { workspace = true }
memory-service = { workspace = true }
memory-storage = { workspace = true }
clap = { workspace = true }
config = { workspace = true }
tokio = { workspace = true }
tracing = { workspace = true }
tracing-subscriber = { workspace = true }
anyhow = { workspace = true }
serde = { workspace = true }
```

**crates/memory-daemon/src/main.rs:**
```rust
//! Agent Memory Daemon
//!
//! A local, append-only conversational memory system for AI agents.

fn main() {
    println!("memory-daemon: not yet implemented");
    println!("Run with --help for usage (coming in Plan 01-04)");
}
```

**proto/memory.proto:**
```protobuf
syntax = "proto3";

package memory;

// Memory service for agent conversation storage
service MemoryService {
    // Ingest a conversation event (to be implemented in Plan 01-03)
    rpc IngestEvent(IngestEventRequest) returns (IngestEventResponse);
}

// Placeholder messages (to be fully defined in Plan 01-02/01-03)
message IngestEventRequest {
    // Event details to be added
}

message IngestEventResponse {
    // Response details to be added
}
```

**.gitignore:**
```
# Build artifacts
/target/
**/*.rs.bk

# IDE
.idea/
.vscode/
*.swp
*.swo

# OS
.DS_Store
Thumbs.db

# Environment
.env
.env.local

# RocksDB data (development)
/data/
*.sst
*.log
LOCK
CURRENT
MANIFEST-*
OPTIONS-*
```
  </action>
  <verify>
Run `cargo build` from workspace root. Should compile all 4 crates without errors.
Run `cargo check --all` to verify all crates are properly linked.
  </verify>
  <done>
Workspace builds successfully. All 4 crates exist with proper dependencies. Proto file exists.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create project documentation</name>
  <files>
    - docs/README.md
  </files>
  <action>
Create `docs/README.md` with project overview and structure:

```markdown
# Agent Memory

A local, append-only conversational memory system for AI agents with TOC-based agentic navigation.

## Overview

Agent Memory captures conversations from AI agents (Claude Code, OpenCode, Gemini CLI, GitHub Copilot CLI) and organizes them into a time-based Table of Contents (TOC) for efficient retrieval. The agent can answer "what were we talking about last week?" without scanning everything.

## Architecture

### Core Concepts

- **Events**: Immutable conversation records (user messages, assistant responses, tool calls)
- **TOC (Table of Contents)**: Time-based hierarchy (Year > Month > Week > Day > Segment)
- **Grips**: Excerpts linking TOC summaries to source events (provenance)
- **Outbox**: Queue for async index updates

### Crate Structure

```
agent-memory/
├── crates/
│   ├── memory-types/      # Shared types (Event, TocNode, Grip, Config)
│   ├── memory-storage/    # RocksDB abstraction layer
│   ├── memory-service/    # gRPC service implementation
│   └── memory-daemon/     # CLI binary (start/stop/status)
├── proto/
│   └── memory.proto       # gRPC service definitions
└── docs/
    └── README.md          # This file
```

### Data Flow

1. **Ingestion**: Hook handlers capture agent conversations and send via gRPC
2. **Storage**: Events stored in RocksDB with time-prefixed keys
3. **TOC Building**: Background jobs segment events and create summary hierarchy
4. **Query**: Agents navigate TOC to find relevant time periods, drill to raw events

## Usage

### Starting the Daemon

```bash
# Start in foreground
memory-daemon start --foreground

# Start with custom config
memory-daemon start --config /path/to/config.toml
```

### Configuration

Config file location: `~/.config/agent-memory/config.toml`

```toml
db_path = "~/.local/share/agent-memory/db"
grpc_port = 50051

[summarizer]
provider = "openai"
model = "gpt-4o-mini"
```

Environment variables override config file:
- `MEMORY_DB_PATH`
- `MEMORY_GRPC_PORT`
- `MEMORY_SUMMARIZER_PROVIDER`

## Development

### Prerequisites

- Rust 1.82+
- Protocol Buffers compiler (protoc)

### Building

```bash
# Build all crates
cargo build

# Build release
cargo build --release

# Run tests
cargo test
```

### Testing with grpcurl

```bash
# Check service health
grpcurl -plaintext localhost:50051 grpc.health.v1.Health/Check

# List available services (reflection)
grpcurl -plaintext localhost:50051 list
```

## Design Principles

1. **TOC-First Navigation**: Time hierarchy is the primary access path
2. **Append-Only Storage**: Events are immutable truth
3. **Grounded Summaries**: Every bullet links to source evidence (grips)
4. **Indexes as Accelerators**: BM25/vector search are optional speedups, not dependencies

## License

MIT
```
  </action>
  <verify>
File exists at docs/README.md and contains project overview, crate structure, and usage instructions.
  </verify>
  <done>
Project documentation created with overview, architecture, usage, and development instructions.
  </done>
</task>

</tasks>

<verification>
1. `cargo build` succeeds from workspace root
2. `cargo check --all` shows all 4 crates linked correctly
3. Directory structure matches research recommendations:
   - `crates/memory-types/`
   - `crates/memory-storage/`
   - `crates/memory-service/`
   - `crates/memory-daemon/`
   - `proto/memory.proto`
   - `docs/README.md`
</verification>

<success_criteria>
- Workspace compiles without errors
- All 4 crates exist with proper Cargo.toml files
- Proto file exists with placeholder service definition
- docs/README.md provides project overview
- .gitignore excludes build artifacts and data directories
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-00-SUMMARY.md`
</output>
